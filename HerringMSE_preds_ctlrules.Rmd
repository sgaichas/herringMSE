---
title: 'Are any herring harvest control rules good for both fisheries and predators?'
author: Sarah K. Gaichas, Jonathan J. Deroba, Min-Yang Lee
institute: NOAA NMFS Northeast Fisheries Science Center, Woods Hole, MA, USA
date: September 26, 2018
output:
  beamer_presentation:
    slide_level: 2
    keep_tex: true
---

# Yes (In New England)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align='center', out.width = "\\linewidth", warning = FALSE)
if(!require(ggplot2)) {  
  install.packages("ggplot2")
  require(ggplot2)}
if(!require(tidyr)) {  
  install.packages("tidyr")
  require(tidyr)}
if(!require(dplyr)) {  
  install.packages("dplyr")
  require(dplyr)}
if(!require(broom)) {  
  install.packages("broom")
  require(broom)}
if(!require(knitr)) {  
  install.packages("knitr")
  require(knitr)}
if(!require(gridExtra)) {  
  install.packages("gridExtra")
  require(gridExtra)}
if(!require(grid)) {  
  install.packages("grid")
  require(grid)}
if(!require(ggthemes)) {  
  install.packages("ggthemes")
  require(ggthemes)}
if(!require(readr)) {  
  install.packages("readf")
  require(readr)}
if(!require(kableExtra)) {  
  install.packages("kableExtra")
  require(kableExtra)}


data.dir <- './data'
image.dir <- './images'

#The sg_figs option can be set to FALSE to skip making SG's figures on the fly. Or TRUE to make them. 
sg_figs <- TRUE

if(sg_figs){
  ternpopproddiet <- read.csv(file.path(data.dir,"GOMTernPopsProdDiet_Corrected.csv"))
  preyB <- read.table(file.path(data.dir,"Unadj1111TotBioSimYear.txt"), header=T)  
  preysim <- read.table(file.path(data.dir,"Unadj1111NAASimYear.txt"), header=T)
  preychar <- read.table(file.path(data.dir,"Unadj1111SimCharAA.txt"), header=T)
  herring <- read.csv(file.path(data.dir,"herringassessout2015.csv"))
  dogdiet   <- read.csv(file.path(data.dir,"dogfishdietcomp.csv"))
  GBcoddiet <- read.csv(file.path(data.dir,"GBcoddietcomp.csv"))
  GOMcoddiet <- read.csv(file.path(data.dir,"GOMcoddietcomp.csv"))
  codGB <- read.csv(file.path(data.dir,"GBcodpop.csv"))
  codGOM <- read.csv(file.path(data.dir,"GOMcodpop.csv"))
  dogfish <- read.csv(file.path(data.dir,"dogfishpop.csv"))
  gfishdiet <- read.csv(file.path(data.dir,"Gfishdiets.csv"))
  dogfishrec <- read.csv(file.path(data.dir,"dogfishrec.csv"))
}

allres <- readRDS(file.path(data.dir,"allres.rds"))

#to get table captions and numbering
tn = local({
  i = 0
  function(x) {
    i <<- i + 1
    #paste('\n\n:Table ', i, ': ', x, sep = '')
    paste('\n\n:', x, sep = '')
    # The : before Table tells pandoc to wrap your caption in <caption></caption>
  }
})
knit_hooks$set(tab.cap = function(before, options, envir) {
  if(!before)
    tn(options$tab.cap)
})
default_output_hook = knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  if (is.null(options$tab.cap) == F)
    x
  else
    default_output_hook(x,options)
})

#a better plotting theme than ggplot default? from https://rpubs.com/Koundy/71792
theme_Publication <- function(base_size=14, base_family="") {
      library(grid)
      library(ggthemes)
      (theme_foundation(base_size=base_size, base_family=base_family)
       + theme(plot.title = element_text(face = "bold",
                                         size = rel(1.2), hjust = 0.5),
               text = element_text(),
               panel.background = element_rect(colour = NA),
               plot.background = element_rect(colour = NA),
               panel.border = element_rect(colour = NA),
               axis.title = element_text(face = "bold",size = rel(1)),
               axis.title.y = element_text(angle=90,vjust =2),
               axis.title.x = element_text(vjust = -0.2),
               axis.text = element_text(), 
               axis.line = element_line(colour="black"),
               axis.ticks = element_line(),
               panel.grid.major = element_line(colour="#f0f0f0"),
               panel.grid.minor = element_blank(),
               legend.key = element_rect(colour = NA),
               legend.position = "right",
               legend.direction = "vertical",
               legend.key.size= unit(0.4, "cm"),
               legend.margin = unit(0, "cm"),
               legend.title = element_text(face="italic"),
               plot.margin=unit(c(10,5,5,5),"mm"),
               strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
               strip.text = element_text(face="bold")
          ))
      
}

scale_fill_Publication <- function(...){
      library(scales)
      discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}

scale_colour_Publication <- function(...){
      library(scales)
      discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}
```

<!-- included for reference only
## Abstract

Fishery managers are increasingly asked to balance the direct and indirect effects of harvest on ecosystems and society. In 2016, the New England Fishery Management Council initiated a management strategy evaluation (MSE) to develop an annual, stock-wide Atlantic herring harvest control rule that considered herring's ecological role as forage.  Stakeholders were interested in evaluating potential effects of herring harvest control rules on herring and the herring fishery, as well as multiple predator types including highly migratory species (tuna), groundfish (dogfish), seabirds (terns), and marine mammals. Here, we review the predator modeling process and results. For each predator type, we developed a predator population model and a herring-predator relationship model. Predator models were based on stock assessments, peer-reviewed literature, and observational data specific to the Northeast US shelf. Predator biomass, abundance, recruitment/productivity, condition, and status relative to reference points were evaluated for each herring harvest control rule.  Predators responded differently to the simulated alternative herring control rules. Tuna were most sensitive to changes in herring growth in the simulation, which was driven by herring population model assumptions rather than differences between control rules.  Nesting tern productivity and dogfish populations were maintained above their respective reference points by most herring control rules, but dropped below for a subset of control rules which also resulted in poor herring fishery performance.  MSE results allowed managers to compare herring, fishery, and predator performance for each control rule, revealing a range of strategies that potentially achieve good outcomes for both fisheries and predators. 
-->

## Introduction: Atlantic herring
```{r intro}
knitr::include_graphics(file.path(image.dir, 'allcomponents.png'))
```

<!--Atlantic herring (hereafter herring; *Clupea harengus*) in the Northwest Atlantic are preyed upon by fish, seabirds, and marine mammals, and can account for 20-50% of the diet of these predators [@overholtz_consumption_2007; @smith_trophic_2010;@curti_evaluating_2013]. Herring are also subject to a directed fishery, mostly using midwater trawls, purse seines, and bottom trawls, that averaged 85,000mt of landings during 2008-2017. Much of the herring landed are used as bait in the relatively high value American lobster (*Homarus americanus*) fishery. Herring life-history traits (e.g., weight-at-age) have varied through time, and their complex stock structure creates uncertainty in their assessment and management [@NEFSC2012Assessment; @Deroba2015atlantic]. Thus, herring are of broad interest in the region, but anticipating the relative performance of mangement strategies (e.g., harvest control rules) in the face of uncertainties is challenging, which makes a management strategy evaluation (MSE) for herring in the region a potentially informative tool.

The federal fisheries management process in New England usually starts when the New England Fishery Managment Council (NEFMC), the political body responsible for federally managed species in the northeast US, perceives a problem causing a management goal or objective to be unmet. Managers will propose a range of potential solutions and a technical group, typically composed of scientists and policy analysts from state agencies and the National Marine Fisheries Service (NMFS), will analyze these possible solutions. Council meetings are public, and stakholder input is solicited through open comment periods and diverse advisory panels.  Once the NEFMC votes on a solution, NMFS will, after verifying that it is consistent with applicable laws, translate those solutions into regulations and enforce those regulations. Management actions, particularly contentious ones, can take several years to develop and implement.
-->

## Introduction: Management Strategy Evaluation
```{r introMSE}
knitr::include_graphics(file.path(image.dir, 'MSECSIRO.png'))
```

<!--Management strategy evaluation uses simulation to evaluate the tradeoffs resulting from alternative management options in the face of uncertainty [@punt_management_2016]. MSEs require time, however, for stakeholder input, data collection, and model development [@butterworth2007management; @punt_management_2016]. As such, the process can take much longer than "traditional" management time frames [@butterworth2007management]. The development time is also likely to lengthen when explicit ecosystem, multi-species, or socioeconomic considerations are included because the data and modeling needs, and subsequent uncertainties, are all greater than in a single species approach. This manuscript chronicles the development of a MSE done on a truncated timetable (~12 months) required to meet management time frames. The objectives of this manuscript were to:

1. Evaluate the relative performance of HCRs at meeting herring fishery objectives, including those related to predators of herring, as informed by stakeholder input, and,

2. Discuss our approach to developing a MSE on a relatively truncated timetable in order to meet management time frames, and identify the lessons learned throughout the process, especially as they relate to using MSE as a tool to advance an ecosystem based approach to management [e.g., @plaganyi_multispecies_2014].
-->

## The Dream and The Reality
```{r dreamreality}
knitr::include_graphics(file.path(image.dir, 'MgtProcess.png'))
```


<!--During January 2016, the NEFMC requested a MSE to evaluate harvest control rules (HCRs) for herring (see @Feeney2018blending for more detail. Fishery managers wanted to develop a HCR that, among other things, accounted for the role of Atlantic herring as forage in the ecosystem. The exact "accounting" system was left to be defined by stakeholder-driven workshops that were open to the public, except that the main interest was in the effect that herring have on predators and not top-down effects of predators on herring. Two stakeholder workshops were conducted, one in May 2016 and another in December 2016. Members of the herring, lobster, groundfish, tuna, recreational, and whale-watching industries participated, as well as environmental non-government organizations (ENGO), federal and state agencies, and academics. Input from these diverse stakeholders were then utilized to construct the closed-loop simulation portion of the MSE. Notably, while the techincal group knew the general scope of the modeling exercise (HCRs that account for herring as forage), detailed modeling of many components of interest could not begin in earnest until this step was finished.

Constucting an ecosystem model with an interdisciplinary team of scientists to support these management decisions would be a useful and perhaps ideal tool. However, the NEFMC desired results from the MSE within one year, which constrained the development of many components of the model.  Deciding how to allocate scarce research effort and time to various components of model development is always challenging; the limited time available for model development made this process even more challenging.  Relatively simple models linking key ecosystem components can have many advantages over more complex models for ecosystem analysis [@plaganyi_multispecies_2014; @collie_ecosystem_2016; @punt_exploring_2016]. These "models of intermediate complexity for ecosystem assessments" [MICE; @plaganyi_multispecies_2014] can also be a reasonable approach to conducting science to meet relatively short management timelines while ensuring the models and results reasonably describe the tradeoffs among objectives and remain relevant for decision-making.  The methods in this article describe the reality of what was achieved in order to enable managers to make informed decisions within their preferred time frames.  This reality is then contrasted with more comprehensive scientific approaches that could better inform future decisionmaking (i.e., the "dream").  This manuscript is a companion to @Feeney2018blending  which more fully describes the management context and how this MSE was blended with fisheries management.
-->

## Herring Methods
- lots of modeling

Deroba, J. J., Gaichas, S. K., Lee, M.-Y., Feeney, R. G., Boelke, D. V., and Irwin, B. J. 2018. The dream and the reality: meeting decision-making time frames while incorporating ecosystem and economic models into management strategy evaluation. Canadian Journal of Fisheries and Aquatic Sciences. http://www.nrcresearchpress.com/doi/10.1139/cjfas-2018-0128
<!--A MSE was developed specific to Gulf of Maine - Georges Bank Atlantic herring.  The herring component was modified from @Deroba2014EvaluatingRho, and symbols are largely consistent (Table \ref{symtab}). The MSE was based on an age-structured simulation that considered fish from age-1 through age-8+ (age-8 and older), which is consistent with the age ranges used in the 2012 and 2015 Atlantic herring stock assessments [@NEFSC2012Assessment; @Deroba2015atlantic].  The abundances at age in year one of all simulations equaled the equilibrium abundances produced by the fishing mortality rate that would reduce the population to 40% of $SSB_{F=0}$, but simulations were of sufficient length to make the starting values moot.  Abundance in each subsequent age and year was calculated assuming that fish died exponentially according to an age and year specific total instantaneous mortality rate.

Recruitment followed Beverton-Holt dynamics [@francis1992use]:
\begin{align}
 R_{1,y+1}&=\frac{(\frac{SSB_{F=0}}{R_{F=0}} \frac{1-h}{4h})SSB_y}{1+(\frac{5h-1}{4hR_{F=0}})SSB_y}e^{\varepsilon_{R,y}-\frac{\sigma_R^2}{2}} \\
 \varepsilon_{R,y}&=\omega \varepsilon_{R,y-1}+\sqrt{1-\omega^2}\rho_y \\
 \rho &\sim N(0,\sigma_R^2) \\
 SSB_y&=\sum\limits_{a=1}^{8+}N_{a,y}m_aW_a.
\end{align}

The variance of recruitment process errors ($\sigma_R^2$) equaled 0.36 and the degree of autocorrelation ($\omega$) equaled 0.1, which are values consistent with recruitment estimates from a recent Atlantic herring stock assessment [@Deroba2015atlantic].

### Assessment Error
A stock assessment was approximated (i.e., assessment errors) similar to @punt2008evaluation and @Deroba2014EvaluatingRho.  Assessment error was modeled as a year-specific lognormal random deviation common to all ages, with first-order autocorrelation and a term that created the option to include bias $\rho$:
\begin{align}
\widehat{N}_{a,y}&=[N_{a,y}(\rho+1)]e^{\varepsilon_{\phi,y}-\frac{\sigma_\phi^2}{2}} \\
\varepsilon_{\phi,y}&=\vartheta\varepsilon_{\phi,y-1}+\sqrt{1-\vartheta^2}\tau_y \\
\tau &\sim N(0,\sigma_\phi^2). 
\end{align}
The variance of assessment errors ($\sigma_\phi^2$) equaled 0.05 and autocorrelation ($\vartheta$) equaled 0.7.  A range of values for $\sigma_\phi^2$ and $\vartheta$ were not evaluated because previous research using a similar approach to applying assessment errors has found relative control rule performance to be robust to these quantities [@punt2008evaluation; @irwin2008evaluating; @Deroba2012Evaluating].  Rho ($\rho$) allowed for the inclusion of bias in the assessed value of abundance (see below; @Deroba2014EvaluatingRho).  Assessed spawning stock biomass ($\widehat{SSB}_y$) was calculated similarly to $SSB_y$ except with $N_{a,y}$ replaced with $\widehat{N}_{a,y}$, and assessed total biomass ($\widehat{B}_y$) was calculated as the sum across ages of the product of $\widehat{N}_{a,y}$ and $W_a$.
-->

### Operating Models
```{r OMs,  echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
#tab.cap="Operating model uncertainties addressed\\label{OMs}",
tabl <- "
|Operating Model Name|Herring Productivity|Herring Growth|Assessment Bias|
|:---------------------|:---------------------|:-----------------|:-----------------|
| LowFastBiased        | Low: high M, low h (0.44)  | 1976-1985: fast | 60% overestimate |
| LowSlowBiased        | Low: high M, low h (0.44)  | 2005-2014: slow | 60% overestimate |
| LowFastCorrect       | Low: high M, low h (0.44)  | 1976-1985: fast | None             |
| LowSlowCorrect       | Low: high M, low h (0.44)  | 2005-2014: slow | None             |
| HighFastBiased       | High: low M, high h (0.79) | 1976-1985: fast | 60% overestimate |
| HighSlowBiased       | High: low M, high h (0.79) | 2005-2014: slow | 60% overestimate |
| HighFastCorrect      | High: low M, high h (0.79) | 1976-1985: fast | None             |
| HighSlowCorrect      | High: low M, high h (0.79) | 2005-2014: slow | None             |
"
df<-read_delim(tabl, delim="|")
df<-df[-c(1,2) ,c("Operating Model Name","Herring Productivity","Herring Growth","Assessment Bias")]
knitr::kable(df, booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%
  kable_as_image()

#cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

<!--The stakeholder workshops identified uncertainties about herring life history traits and stock assessment.  The effect of some of these uncertainties on harvest control rule performance was evaluated by simulating the control rules for each of eight operating models (Table \ref{OMs}).  The uncertainties addressed by the eight operating models included: Atlantic herring natural mortality and steepness, Atlantic herring weight-at-age, and possible bias in the stock assessment beyond the unbiased measurement error ($\varepsilon_{\phi y}$). 

The specific values used in the operating models for each of the uncertainties were premised on data used in recent stock assessments or estimates from fits of stock assessment models [@Deroba2015atlantic].  Natural mortality in recent stock assessments has varied among ages and years, with $M$ being higher during 1996-2014 than in previous years  [@NEFSC2012Assessment;@Deroba2015atlantic].  Natural mortality, however, has also been identified as an uncertainty in the stock assessments and sensitivity runs have been conducted without higher $M$ during 1996-2014, such that $M$ was constant among years [@NEFSC2012Assessment;@Deroba2015atlantic].  To capture uncertainty in $M$ in the MSE, operating models were run with either relatively high or low $M_a$ (Table \ref{MWttab}).  Relatively high $M_a$ values equaled the age-specific natural mortality rates used for the years 1996-2014 in the stock assessment.  Relatively low $M_a$ values in the MSE equaled the age-specific natural mortality rates used for the years 1965-1995 in the stock assessment.  In the MSE, $M_a$ was always time invariant.

Uncertainty in estimates of stock-recruit parameters were represented in the MSE by using the parameters estimated by stock assessments fit with and without the higher $M$ during 1996-2014.  Stock assessment fits with higher $M$ during 1996-2014 produced estimates of steepness and $SSB_{F=0}$ that were lower than in stock assessment fits without higher $M$ during 1996-2014 (Tables \ref{OMs} and \ref{MWttab}).  Thus, operating models with relatively high $M_a$ always had relatively low steepness and $SSB_{F=0}$, and the opposite held with relatively low $M_a$ (Table \ref{OMs}).

Uncertainty in Atlantic herring size-at-age was accounted for by having operating models with either fast or slow growth (i.e., weights-at-age; Table \ref{MWttab}).  Atlantic herring weight-at-age generally declined from the mid-1980s through the mid-1990s, especially at ages-3 and older, and has been relatively stable since [@Deroba2015atlantic].  Reasons for the decline are speculative and no causal relationships have been established.  Likewise, the reasons why growth has declined for older ages, but has either remained stable or increased at age-1 and age-2 are unclear.  Thus, the terms "fast" and "slow" growth were used as generally describing the growth conditions of older Atlantic herring.  Fast growth operating models had weights-at-age that equaled the January 1 weights-at-age from the most recent stock assessment averaged over the years 1976-1985, while the slow growth operating models averaged over the years 2005-2014 [@Deroba2015atlantic].  In the MSE, weight-at-age was always time invariant.

Differences in $M$, stock-recruit parameters, and weights-at-age led to differences in unfished (i.e., virgin) and $MSY$ reference points among operating models (Table \ref{RefPts}).  The effect of $M$ and stock-recruit parameters was larger than the effect of differences in weight-at-age (Table \ref{RefPts}).



To address concerns about possible stock assessment bias, operating models with and without a positive bias were included.  In operating models without bias, $\rho$=0 and the only assessment error was that caused by the unbiased measurement errors ($\epsilon_{\phi y}$).  In operating models with bias, $\rho$ equaled 0.6, which was based on the degree of retrospective pattern in $SSB$ from the most recent stock assessment [@Deroba2015atlantic].
-->
## Herring Methods

### Harvest Control Rules

- Biomass Based (1, 3, and 5 year blocks of catch)
<!--Several  classes of control rules were evaluated, including a biomass based control rule [@katsukawa2004numerical], a constant catch rule, and a conditional constant catch rule [@clark2004conditional; @Deroba2012Evaluating].  The biomass based control rule was defined by three parameters: the proportion ($\psi$) of $F_{MSY}$ that dictates the maximum desired fishing mortality rate ($\tilde{F}$), an upper SSB threshold ($SSB_{up}$), and a lower SSB threshold ($SSB_{low}$).  The $\tilde{F}$ equaled the maximum when $\widehat{SSB}$ was above the upper threshold, declined linearly between the upper and lower thresholds, and equaled zero below the lower threshold:
-->

  \begin{equation}
  \label{Fy_equation}
    \tilde{F}_y=
    \begin{cases}
      \psi F_{MSY}, & \text{if}\ \widehat{SSB}_y \geq SSB_{up} \\
      \psi F_{MSY} \frac{\widehat{SSB}_y - SSB_{low}}{SSB_{up}-SSB_{low}}, & \text{if}\ SSB_{low} < \widehat{SSB}_y < SSB_{up}\\
      0, & \text{if}\ \widehat{SSB}_y \leq SSB_{low}
    \end{cases}
  \end{equation}
 
- Biomass Based with a 15% restriction on interannual change 
- Constant Catch (proportion of MSY)
- Conditional Constant Catch (not to exceed max F)
<!--
The $\tilde{F}_y$ was then used to set a quota in year y + 1.  $\tilde{F}_{ay}$ equaled $\tilde{F}_y$ times $S_a$, and $S_a$ was time and simulation invariant selectivity at age equal to the values for the mobile gear fishery as in @Deroba2015atlantic.  $\tilde{F}_y$ was used to set a quota in the following year to approximate the practice of using projections based on an assessment using data through year y - 1 to set quotas in the following year(s).  Furthermore, although $\tilde{F}_y$ was set using $\widehat{SSB}_y$, the quota was based on $\widehat{B}_y$ because the fishery selects some immature ages.  The fully selected fishing mortality rate that would remove the quota from the true population ($\bar{F}_y$) was found using Newton-Raphson iterations.
Several variations of the biomass based rule were also evaluated.  These variations included applying the control rule annually, using the same quota for three year blocks such that the control rule is applied every fourth year (i.e., $Q_{y+1}=Q_{y+2}=Q_{y+3}$), using the same quota for 5 year blocks, and using the same quota for three year blocks but restricting the change in the quota to 15% in either direction when the control rule was reapplied in the fourth year.  Thus, four variants of the biomass based control rule were evaluated: 1) annual application, 2) three year blocks, 3) five year blocks, and 4) 3 year blocks with a 15% restriction.

For each biomass based control rule variant, a range of values for the three parameters defining the control rule was evaluated.  The proportion ($\psi$) of $F_{MSY}$ that dictates the maximum desired fishing mortality rate was varied from 0.1$F_{MSY}$ to 1.0$F_{MSY}$ in increments of 0.1, while the lower and upper SSB threshold parameters ($SSB_{low} \; SSB_{up}$) were varied from 0.0$SSB_{MSY}$ to 4$SSB_{MSY}$ but with inconsistent increments (i.e., 0.0, 0.1, 0.3, 0.5, 0.7, 0.9, 1.0, 1.1, 1.3, 1.5, 1.7, 2.0, 2.5, 3, 3.5, 4).  The full factorial of combinations for the three biomass based control rule parameters produced 1,360 shapes (note $SSB_{low}$ must be <= $SSB_{up}$) and each of these shapes was evaluated for each of the four biomass based control rule variants described above.

The constant catch control rule is defined by one parameter, a desired constant catch (i.e., quota) amount.  The constant catch amounts were varied from 0.1$MSY$ to 1.0$MSY$ in increments of 0.1.  

The conditional constant catch rule used a constant desired catch amount unless removing that desired catch from the assessed biomass caused the fully selected fishing mortality rate to exceed a pre-determined maximum, in which case the desired catch was set to the value produced by applying the maximum fully selected fishing mortality rate to the assessed biomass.  Thus, the conditional constant catch rule has two policy parameters: a desired constant catch amount, and a maximum fishing mortality rate.  The constant catch amounts were varied over the same range as in the constant catch control rule, while the maximum fishing mortality rate equaled 0.5$F_{MSY}$.  When the maximum fishing mortality rate portion of the conditional constant catch rule was invoked, a quota was set in the same manner as when $\widehat{SSB}_y >= SSB_{up}$ in the biomass based control rule described above.

### Implementation Error
Implementation errors were also included in a similar way as in @punt2008evaluation and @Deroba2012Evaluating, as year-specific lognormal random deviations:
\begin{equation}
F_{a,y}=\bar{F}_yS_ae^{\varepsilon_{\theta,y}-\frac{\sigma_\theta^2}{2}} \\
\varepsilon_{\theta} \sim N(0,\sigma_\theta^2).
\end{equation}
The variance of implementation errors ($\sigma_\theta^2$) equaled 0.001.  The US Atlantic herring fishery in the Northwest Atlantic generally catches about the full amount of annual quota.  Catches are monitored through manadatory federal and state reporting requirements, which are used to close the fishery within 10% of the annual quota.  Thus, unbiased implementation errors seemed justified.
-->

## Predators
```{r predoverview}
knitr::include_graphics(file.path(image.dir, 'herrtopreds.png'))
```

<!--The food web of the Northeast US continental shelf large marine ecosystem is characterized by many diverse predators and prey [@link_does_2002]. There is a wealth of scientific information to characterize predator-prey relationships in this region, including feeding ecology data for fish predators [e.g., @smith_trophic_2010], seabirds [@hall_composition_2000], bluefin tuna (*Thunnus thynnus*) [@chase_differences_2002; @golet_changes_2013; @logan_diet_2015; @golet_paradox_2015], and marine mammals [@smith_consumption_2015]. Consumption of herring by predators has been extensively studied in this ecosystem [@overholtz_consumption_2000; @overholtz_consumption_2007], and multiple methods were evaluated to include this consumption within the most recent herring benchmark stock assessment [@NEFSC2012Assessment]. 

Much of this information was presented at the first stakeholder workshop in May 2016, where it was agreed that separate “general predator” models linked to herring would be a reasonable approach, with the goal of developing one model for each of the four predator categories: highly migratory fish, groundfish, seabirds, and marine mammals [@Feeney2018blending].  Bluefin tuna  were identified at the stakeholder workshop as a recommended highly migratory herring predator, and common terns (*Sterna hirundo*) were identified at the stakeholder workshop as the recommended seabird herring predator, so these predators were modeled. No specific groundfish or marine mammal was identified as a representative herring predator during the stakeholder workshop. In sections below we discuss these decisions further.

Predators were modeled with fairly simple delay-difference population dynamics that allowed different predator population processes to be dependent on some aspect of herring population status, following @plaganyi_scotia_2012. Each predator model takes output from the herring operating model (OM) as input, and outputs performance metrics identified at the stakeholder workshop. While this allows “bottom up” effects of herring on predators to be examined, this configuration does not consider “top down” effects of predators on herring, or simultaneous interactions of multiple predators with herring. 

There were two modeling components for each predator included in the herring MSE: a predator population model, and a herring-predator relationship model to link herring with predator populations. Here, we give an overview of the modeling process, and we describe the decisions made in parameterizing individual predator models and herring-predator relationships in the following sections. The overall population in numbers for each predator $P$ each year $N_{y}^P$ is modeled with a delay-difference function: 
\begin{equation}
N_{y+1}^P = N_{y}^PS_{y}^P +  R_{y+1}^P \label{delaydiffN_equation},
\end{equation}
where annual predator survival $S_{y}^P$ is based on annual natural mortality $v$ and exploitation $u$ 
\begin{equation}
S_{y}^P =  (1-v_{y})(1-u) \label{survival_equation},
\end{equation}
and annual recruitment $R_{y}^P$ (delayed until recruitment age a) is a Beverton-Holt function defined as above for herring.

Predator population biomass is defined with Ford-Walford plot intercept ($Fw_{int}$) and slope ($Fw_{slope}$) growth parameters
\begin{equation}
B_{y+1}^P = S_{y}^P (Fw_{int} N_{y}^P + Fw_{slope} B_{y}^P) + Fw_{int} R_{y+1}^P \label{delaydiffB_equation}
\end{equation}

Parameterizing this model requires specification of the stock-recruitment relationship (steepness $h$ and unfished spawning stock size in numbers or biomass), the natural mortality rate, the fishing mortality (exploitation) rate, the initial population size, and the weight at age of the predator (Ford-Walford plot intercept and slope parameters). For each predator, population parameters were derived from different sources (Table \ref{predsource}).

Predator population models were based on either the most recent stock assessment for the predator or from observational data from the Northeast US shelf. Herring-predator relationships were based on either peer-reviewed literature or observational data specific to the Northeast US shelf. We did not include process or observation error in any of these modeled relationships. This is obviously unrealistic, but the primary objective of the herring MSE is to evaluate the effect of herring management on predators. Leaving out variability driven by anything other than herring is intended to clarify the effect of herring management. 

To develop the herring-predator relationship model, specific herring population characteristics (e.g. total abundance or biomass, or abundance/biomass of certain ages or sizes) were related to either predator growth, predator reproduction, or predator survival. Our aim was to use information specific to the Northeast US shelf ecosystem, either from peer-reviewed literature, from observations, or a combination. 

In general, if support for a relationship between herring and predator recruitment was evident, it was modeled as a predator recruitment multiplier based on the herring population ($N_{y}$) relative to a specified threshold $N_{thresh}$:
\begin{equation}
\bar{R}_{y+a}^P = R_{y+a}^P  * \frac{\gamma(N_{y}/N_{thresh})}{(\gamma-1)+(N_{y}/N_{thresh})} \label{recwithherring_equation}, 
\end{equation}

where $\gamma$ > 1 links herring population size relative to the threshold level to predator recruitment.

If a relationship between predator growth and herring population size was evident, annual changes in growth were modeled by modifying either the Ford-Walford intercept ($\alpha_y^P$) or slope ($\rho_y^P$):

\begin{equation}
B_{y+1}^P = S_{y}^P (\alpha_y^P N_{y}^P + Fw_{slope} B_{y}^P) + \alpha_y^PR_{y+1}^P, or
\end{equation}

\begin{equation}
B_{y+1}^P = S_{y}^P (Fw_{int} N_{y}^P + \rho_y^P B_{y}^P) + Fw_{int} R_{y+1}^P, 
\end{equation}

where either $\alpha_y^P$ or $\rho_y^P$ are defined for a predator using herring population parameters (see Eqn. \ref{tunagrow_equation} below).

Finally, herring population size $N_{y}$ could be related to predator survival using an annual multiplier on constant predator annual natural mortality $v$: 

\begin{equation}
v_{y} =  v e ^ {-(\frac{N_{y}}{N_{F=0}})\delta} \label{varmort_equation},
\end{equation}
where 0 < $\delta$ <1 links herring population size to predator survival.

After specifying the population model parameters and herring-predator relationship, we applied the [@hilborn_quantitative_2003] equilibruim calculation for the delay difference model with $F$=0 to get the unfished spawners per recruit ratio. This ratio was then used in a second equilibruim calculation with the current predator exploitation rate to estimate Beverton-Holt stock recruitment parameters, equilibrium recruitment and equilibrium individual weight under exploitation. Then, each model was run forward for 150 years with output from the herring operating model specifying the herring population characteristics. 
-->
## Herring-predator relationship models

- Lots of data analysis and modeling

```{r, message = FALSE, warning = FALSE, fig.show='hold', out.width='0.45\\linewidth'}
# fig.cap="Modeled herring average weight (population >180mm in length) to tuna growth relationship.",See text (Herring-tuna relationship model section) for derivation. \\label{herringtuna}
# from MSE_TunaLink.R
FWalpha       <-  0.020605  #ford-walford plot intercept parameter 
FWrho         <-  0.9675  #ford-walford plot slope parameter
BFTGrowThresh <-  0.15
preypredgrow  <-  1.1 #strengh of effect of prey N on predator growth, >=1, 1=no effect

preyAvgWt     <-  seq(0,0.3,by=0.01)
AnnualAlpha   <-  c()

AnnualAlpha<-(0.9*FWalpha) + ((1.1*FWalpha) - (0.9*FWalpha))/(1+exp((1-preypredgrow)*(100*(preyAvgWt-BFTGrowThresh)/BFTGrowThresh))) #alpha changes with herring avg wt, not slope

qplot(preyAvgWt, AnnualAlpha, geom="line", xlab="Herring average weight (kg)", ylab="Tuna AnnAlpha parameter") +
  theme_Publication() + scale_colour_Publication()

#ternfig
herring <- herring[,1:6]

ternpopproddiet_herring <- left_join(ternpopproddiet, herring)

terntotalpop <- ternpopproddiet %>%
  group_by(yr, species) %>%
  filter(yr<2016) %>%
  select(breedpairs, nfledged) %>%
  filter(!is.na(nfledged)) %>%
  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

# Monomoy Island is a third of the population but eats mainly sandlance and is south of GOM proper--leave out?

terntotpop_noMon <- ternpopproddiet %>%
  group_by(yr, species) %>%
  filter(colony != "Monomoy") %>%
  filter(yr<2016) %>%
  select(breedpairs, nfledged) %>%
  filter(!is.na(nfledged)) %>%
  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

ternpop_herringpop <- left_join(terntotalpop, herring)
ternpopnomon_herringpop <- left_join(terntotpop_noMon, herring)

totprodnomonherr <- ggplot(ternpopnomon_herringpop, aes(x=HerringTotalB, y=totfledge/totpairs, colour=species)) +
  geom_point() +
  geom_hline(yintercept = 1) #+
  #ggtitle("Tern production (no Monomoy) and assessed herring tot B")

#totprodnomonherr + stat_smooth(method = "lm", formula = y ~ x, size = 1) 

HerrAlpha <- 1.09
HerringThresh <- 400000

recmult<-(HerrAlpha*(ternpopnomon_herringpop$HerringTotalB/HerringThresh))/((HerrAlpha-1)+(ternpopnomon_herringpop$HerringTotalB/HerringThresh))

#totprodnomonherr + geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5)

lmtotnomon <- lm(totfledge/totpairs ~ HerringTotalB, species=="Common", data=ternpopnomon_herringpop)

#totprodnomonherr + geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5) +
  #geom_line(aes(x=HerringTotalB, y=9.439e-01 + 1.210e-07*HerringTotalB), color="black", lty=3)

totprodnomonherr + 
  scale_y_continuous(limits = c(0,1.8)) +
  scale_x_continuous(limits = c(0,2500000)) +
  geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5) +
  geom_line(aes(x=HerringTotalB, y=9.439e-01 + 1.210e-07*HerringTotalB), color="black", lty=3, show.legend = FALSE) +
  geom_line(aes(x=seq(0,2500000,length.out=51), y=(HerrAlpha*(seq(0,2500000,length.out=51)/HerringThresh))/((HerrAlpha-1)+(seq(0,2500000,length.out=51)/HerringThresh)), show.legend = FALSE)) +
  labs(x="Herring total biomass (metric tons)", y="Tern productivity (fledglings per nesting pair)", color='Tern species') +
  scale_colour_manual(values=c("#fdb462","#386cb0")) +
  theme_Publication() #+ scale_colour_Publication()

```

<!--Western Atlantic bluefin tuna population parameters were drawn from the 2014 stock assessment [@iccat_report_2015], the growth curve from [@restrepo_updated_2010], and recruitment parameters from a detailed examination of alternative stock recruit relationships [@porch_making_2016]. Ultimately, the "low recruitment" scenario was selected to represent bluefin tuna productivity in the Gulf of Maine, which defines Bmsy as 13,226 t and therefore affects measures of status relative to Bmsy. Continuation of the current tuna fishing strategy (F<0.5Fmsy under the low recruitment scenario) is assumed. All predator population model parameters are listed in Table \ref{predpars}. 

### Herring-tuna relationship model
Tuna diets are variable depending on location and timing of foraging [@chase_differences_2002; @golet_changes_2013; @logan_diet_2015; @golet_paradox_2015], but for the purposes of this analysis, we assumed that herring is an important enough prey of tuna to impact tuna growth in the Northeast US shelf ecosystem. A relationship between bluefin tuna growth and herring average weight was implemented based on information and methods in @golet_paradox_2015. The relationship between tuna condition anomaly (defined as proportional departures from the weight-at-length relationship used in the assessment) and average weight of tuna-prey-sized herring ($\bar{W}_{y}$, herring >180 mm collected from commercial herring fisheries) was modeled as a generalized logistic function with lower and upper bounds on tuna growth parameters:
\begin{equation}
\alpha_y^P = (0.9 Fw_{int}) + \frac{(1.1 Fw_{int}) - (0.9 Fw_{int})}{1+e^{(1-\lambda)*(100(\bar{W}_{y}-T)/T)}} \label{tunagrow_equation},
\end{equation} 
where $\lambda$ > 1 links herring average weight anomalies to tuna growth.
   
The inflection point of $T$ = 0.15 kg average weight aligns with 0 tuna weight anomaly from Fig. 2C on p 186 in @golet_paradox_2015, and upper and lower bounds were determined by estimating the growth intercept with weight at age 10% higher or lower, respectively from the average weight at age obtained by applying the length to weight conversion reported in the 2014 stock assessment [@iccat_report_2015] to the length at age estimated from the @restrepo_updated_2010 growth curve (Fig. \ref{herringtuna}). When included in the model with $\lambda$ = 1.1 in equation \ref{tunagrow_equation}, the simulated variation in tuna weight at age covered the observed range reported in @golet_paradox_2015. 

## Tern population and herring-tern relationship models

```{r, eval=sg_figs, fig.cap="Stock-recruitment function for Gulf of Maine common terns assuming 10\\% fledgling to adult survival. Fitted parameters with all years of the common tern dataset included a non-significant beta parameter (dashed line), while fits to a truncated dataset resulted in low population production rates inconsistent with currently observed common tern trends (dotted line). Therefore, steepness was estimated to give a relationship (solid black line) falling between these two lines. \\label{ternSR}", message = FALSE, warning = FALSE}
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

terntotalpop <- ternpopproddiet %>%
  group_by(yr, species) %>%
  filter(yr<2016) %>%
  select(breedpairs, nfledged) %>%
  filter(!is.na(nfledged)) %>%
  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

ternrec <- ggplot(terntotalpop, aes(x=totpairs, y=totfledge*.1, colour=species)) +
  geom_point() +
  scale_y_continuous(limits = c(0,5000)) +
  scale_x_continuous(limits = c(0,45000)) #+
  #ggtitle("Tern stock and recruitment assuming 10% fledgling->adult survival")

BHfun <- function(x,a,b){
  (x/a)/(1+(1/a*b)*x)
}

BHsteep <- function(Sdat, steep, Rmax, Smax){
  4*steep*Rmax*Sdat/
    (Smax*(1-steep)+Sdat*(5*steep-1))
}

ternrec+
  #stat_function(fun=BHfun, args=list(a= 5.445551,b=0.0002266453), col="black", lwd=1, linetype="dashed")+
  stat_function(fun=BHfun, args=list(a= 9.786020,b=-0.0001570145), col="black",  linetype="dashed")+
  stat_function(fun=BHsteep, args=list(steep=0.41, Rmax=2900, Smax=45000), col="black", linetype="dotted") +
  stat_function(fun=BHsteep, args=list(steep=0.26, Rmax=4500, Smax=45000), col="black") +
  labs(x="Number of nesting pairs", y="Number of recruits (fledglings/10)", color='Tern species') +
  scale_colour_manual(values=c("#fdb462","#386cb0")) +
  theme_Publication() #+ scale_colour_Publication()


```



```{r, eval=sg_figs, fig.cap="Gulf of Maine tern annual productivity distributions by majority diet item offered to fledglings. Boxplots represent the median (wide line within the box) and 25th and 75th percentiles (box) of annual productivity measured across all nesting colonies in the Gulf of Maine where that prey species was the majority in the diet. Boxplot whiskers include the highest and lowest observations within 1.5 box lengths from the box. Observations further from the box (outliers) are represented by points. The black line represents the target tern productivity of 1.0 fledgling per nest. \\label{chickdiet}", message = FALSE, warning = FALSE}
#knitr::include_graphics("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/TernMajorDietItems.png")
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

majorterndiet <- ternpopproddiet %>% 
  filter(!majority.diet %in% c("", "hake and sandlance",
                             "hake and butterfish",
                             "herring and hake",
                             "herring present"))

dietitem <- ggplot(majorterndiet, aes(x=majority.diet, y=productivity, colour=species)) +
  geom_hline(yintercept = 1) + 
  geom_boxplot()

dietitem + theme_Publication() + #element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x="Majority prey species group", y="Tern productivity", color='Tern species') +
  scale_colour_manual(values=c("#fdb462","#386cb0")) +
  theme(axis.text.x = element_text(size=8))

```



```{r, eval=sg_figs, fig.cap="Herring proporiton in diet and annual tern productivity (fledglings/nest) by Gulf of Maine colony. Colony names are at the top of each subplot; I = island. Two colonies, Machias Seal and Stratton above, have significant positive Spearman's rank correlations between herring proportion in diet and annual productivity for common terns. No linear model slopes were significant, so none are shown in the plot. The black line represents the target tern productivity of 1.0 fledgling per nest. \\label{proddiet}", fig.height=8, fig.width=10,  out.width='\\linewidth', message = FALSE, warning = FALSE}
#knitr::include_graphics("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/ternproddiet.png")
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

ternproddiet <- ggplot(ternpopproddiet, aes(x=prop.herring, y=productivity, colour=species)) +
  geom_point() +
  geom_hline(yintercept = 1) #+
  #stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  #stat_smooth(method = "loess", formula = y ~ x, size = 1) +
  #ggtitle("Herring proportion in diet and tern productivity GOM")

ternproddiet + facet_wrap(~colony) + #theme(text=element_text(size=16))
  labs(x="Proportion of herring in diet", y="Productivity", color='Tern species') +
  scale_colour_manual(values=c("#fdb462","#386cb0")) +
  theme_Publication() #+ scale_colour_Publication()

```


```{r, eval=sg_figs,  message=FALSE, warning=FALSE,fig.align='right', fig.show='hold', out.width='0.4\\linewidth'}
#fig.cap="Modeled influence of herring total biomass on tern reproductive success. The black horizontal line represents the target tern productivity of 1.0 fledgling per nest. \\label{herrternmod}",Total annual productivity (fledglings per nest) for both tern species relative to assessed herring total biomass is shown, but the modeled relationship (curve) is based only on common terns. A linear relationship between herring total biomass and common tern productivity crosses tern productivity=1 (black dotted line) at ~400,000 tons herring total biomass. This linear relationship does not have a statistically significant slope; the curve was fit to represent a level but positive contribution of herring total biomass to common tern productivity above the threshold. 
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

#herring <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/herringassessout2015.csv")
herring <- herring[,1:6]

ternpopproddiet_herring <- left_join(ternpopproddiet, herring)

#terntotalpop <- ternpopproddiet %>%
#  group_by(yr, species) %>%
#  filter(yr<2016) %>%
#  select(breedpairs, nfledged) %>%
#  filter(!is.na(nfledged)) %>%
#  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

# Monomoy Island is a third of the population but eats mainly sandlance and is south of GOM proper--leave out?

terntotpop_noMon <- ternpopproddiet %>%
  group_by(yr, species) %>%
  filter(colony != "Monomoy") %>%
  filter(yr<2016) %>%
  select(breedpairs, nfledged) %>%
  filter(!is.na(nfledged)) %>%
  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

ternpop_herringpop <- left_join(terntotalpop, herring)
ternpopnomon_herringpop <- left_join(terntotpop_noMon, herring)

totprodnomonherr <- ggplot(ternpopnomon_herringpop, aes(x=HerringTotalB, y=totfledge/totpairs, colour=species)) +
  geom_point() +
  geom_hline(yintercept = 1) #+
  #ggtitle("Tern production (no Monomoy) and assessed herring tot B")

#totprodnomonherr + stat_smooth(method = "lm", formula = y ~ x, size = 1) 

HerrAlpha <- 1.09
HerringThresh <- 400000

recmult<-(HerrAlpha*(ternpopnomon_herringpop$HerringTotalB/HerringThresh))/((HerrAlpha-1)+(ternpopnomon_herringpop$HerringTotalB/HerringThresh))

#totprodnomonherr + geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5)

lmtotnomon <- lm(totfledge/totpairs ~ HerringTotalB, species=="Common", data=ternpopnomon_herringpop)

#totprodnomonherr + geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5) +
  #geom_line(aes(x=HerringTotalB, y=9.439e-01 + 1.210e-07*HerringTotalB), color="black", lty=3)

totprodnomonherr + 
  scale_y_continuous(limits = c(0,1.8)) +
  scale_x_continuous(limits = c(0,2500000)) +
  geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5) +
  geom_line(aes(x=HerringTotalB, y=9.439e-01 + 1.210e-07*HerringTotalB), color="black", lty=3, show.legend = FALSE) +
  geom_line(aes(x=seq(0,2500000,length.out=51), y=(HerrAlpha*(seq(0,2500000,length.out=51)/HerringThresh))/((HerrAlpha-1)+(seq(0,2500000,length.out=51)/HerringThresh)), show.legend = FALSE)) +
  labs(x="Herring total biomass (metric tons)", y="Tern productivity (fledglings per nesting pair)", color='Tern species') +
  scale_colour_manual(values=c("#fdb462","#386cb0")) +
  theme_Publication() #+ scale_colour_Publication()


```
<!--


```{r, eval=sg_figs, message = FALSE, warning = FALSE}
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

#terntotalpop <- ternpopproddiet %>%
#  group_by(yr, species) %>%
#  filter(yr<2016) %>%
#  select(breedpairs, nfledged) %>%
#  filter(!is.na(nfledged)) %>%
#  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

terntotalpop19982015 <- terntotalpop %>%
  filter(yr>1997)

#ternsigtrend <- terntotalpop19982015 %>%
#  group_by(species) %>%
#  do(fitpoptrend = lm(yr ~ totpairs, data = .))
#terncoef <- tidy(ternsigtrend, fitpoptrend)
#filter(terncoef, p.value<0.05)
# both intercepts are significant at this p

ternpoptrend <- ggplot(terntotalpop19982015, aes(x=yr, y=totpairs, colour=species))

# plot with actual data and simulated data from pop model
# WARNING only works with PredN from MSE_TernLink.R reproduced here
#######Some Functions#########
###Function to calculate unfished "SSBR", and abundance or biomass, or equilibrium characteristics given exploitation rate for delay-difference dynamics with Beverton-Holt SR.
#function(unfishedspr,desired unfished N or B, steepness,units of numbs or bio?, annual natural mortality, annual fishery exploitation rate, ford walford parameter intercept, ford walford slope param, do unfished or exploited equilib?)
unfishspr<-function(predunfishspr=NULL,targzero=NULL,steep=NULL,numbs_weightb=NULL,annualnatmort=NULL,annualexploit=NULL,FWalpha=NULL,FWrho=NULL,unfishflag=NULL) {
  #see delay-diff chapter of hilborn and walters and common pubs on steepness (Mangel et al 2010)
  predrzero<-1/predunfishspr*targzero  #unfished recruitment=f(unfishedSSBR,unfished N or B specified by user
  predalpha<-(4*steep*predrzero)/(5*steep-1) #alpha of BH SR #1/beta? alpha in Mangel et al 2010 is (targzero/predrzero)*((1-steep)/(4*steep)) #
  predbeta<-((targzero/predrzero)*((1-steep)/(4*steep)))/((5*steep-1)/(4*steep*predrzero)) #beta of BH SR #alpha/beta? beta ibid (5*steep-1)/(4*steep*predrzero)
  #predalpha<- (targzero/predrzero)*((1-steep)/(4*steep)) #direct from Mangel et al 2010
  #predbeta<-(5*steep-1)/(4*steep*predrzero) #direct from Mangel et al 2010
  if(numbs_weightb==1){ #solving in units of numbers or biomass
    kappa<-1-(1-annualnatmort)*(1-annualexploit) #growth-survival constant (pg 339 Hilborn and Walters)
    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium N
    Ceq<-eqvalue*annualexploit #equilibrium catch
    Req<-kappa*eqvalue #equilibrium recruitment
    SSeq<-eqvalue-Ceq  #equilibrium spawning stock
  } else {
    kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/FWalpha  #growth-survival constant (pg 339 Hilborn and Walters)
    #kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/(Recwt-((Prerecwt*FWrho)*(1-annualnatmort)*(1-annualexploit)))
    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium Biomass
    Yeq<-eqvalue*annualexploit #equilibrium yield
    Req<-kappa*eqvalue #equilibrium recruitment
    SSeq<-eqvalue-Yeq #equilibrium spawning stock
    Neq<-Req/(1-(1-annualnatmort)*(1-annualexploit)) #equilibrium N
    Weq<-eqvalue/Neq #equilibrium average weight
  }  
  if(unfishflag==0){ #if doing unfished then just return unfished spr to optimize function; required for equlibrium calcs
  return((targzero-eqvalue)^2)
  } else { #if not doing unfished (exploit>0) then return various equilibrium values
   if(numbs_weightb==1) { #units of numbers or biomass?
     return(data.frame("Neq"=eqvalue,"Ceq"=Ceq,"Req"=Req,"SSeq"=SSeq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
   }else {
     return(data.frame("Beq"=eqvalue,"Yeq"=Yeq,"Req"=Req,"SSeq"=SSeq,"Neq"=Neq,"Weq"=Weq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
   }
  }
}
#####end function unfishspr#####

#### Common Tern Gulf of Maine pars (see HerringMSEpredspars.xlsx for derivation

numbs_weight  <-  1  #2 #1=numbers, else weight.  Will predator be tracked just in numbers or numbers and weight?  Weight allows for growth effects.
Predzero      <-  45000 #5.90E+05 # #5.60E+09  #50000 #predator unfished total N or biomass
Predsteep     <-  0.26 #0.25  #0.8 #predator steepness
PredannualA   <-  0.1  #0.6 #predator annual natural mortality rate (0-1); serves as max if time varying
Predexploit   <-  0.00  #0.3 #predator annual exploitation rate (0-1)
FWalpha       <-  0.00015#1.5 #  #0.243 #ford-walford plot intercept parameter if doing biomass units tons
FWrho         <-  0.0  #1.45 #ford-walford plot slope parameter if doing biomass units; serves as max if time varying

PredN         <-  c() #for predator abundance vector
PredN[1]      <-  3000  #7000 #initial abundance in year 1
PredB         <-  c() #for predator biomass vector if doing in those units
PredB[1]      <-  1.5  #6000 #initial biomass in year 1 
PredRecdelay  <-  4  #1 #delay in years for when recruits in year y are added to population

preypredrec<-1 #strength of effect of prey N on predator recruitment (like Plaganyi and Butterworth) >=1; 1=no effect
preyprednatm<-0 #strength of effect of prey N on predator annual natural mort (0-1) 0=no effect
preypredgrow<-1 #strengh of effect of prey N on predator growth, >=1, 1=no effect
  
COTEprodThresh<-400000

#####End user inputs########

#Do predator unfished equilibrium calculation and get unfished spr
predunfishsprfxn<-optimize(f=unfishspr,interval=c(0,50),targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=0,FWalpha=FWalpha,FWrho=FWrho,unfishflag=0,tol=0.0000001)
predunfishspr<-predunfishsprfxn$minimum
#send unfished spr through function again with an exploitation rate to get equlibrium conditions
PredEquilib<-unfishspr(predunfishspr=predunfishspr,targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=Predexploit,FWalpha=FWalpha,FWrho=FWrho,unfishflag=1)
predalpha<-PredEquilib$predalpha #predator BH SR parm
predbeta<-PredEquilib$predbeta #predator BH SR parm
Req<-PredEquilib$Req
Weq<-PredEquilib$Weq
##############################################
#### Read in Herring "data"
#preyB<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111TotBioSimYear.txt", header=T)  
#preysim<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111NAASimYear.txt", header=T)
preyNsim<-transmute(preysim, preyN=Age1+Age2+Age3+Age4+Age5+Age6+Age7+Age8, Sim=Sim)
     
by_simN<-group_by(preyNsim, Sim)
Nyears<-summarise(by_simN, n=n())

#preychar<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111SimCharAA.txt", header=T)
preychar<-cbind(preychar, Age=rep(1:8,max(preychar$Sim)))
#BASE ON TOTAL B
Ternforage<-cbind(preyB, Yr=rep(1:Nyears$n, max(preychar$Sim)))
h<-1
  preyN<-Ternforage$TotalBio[Ternforage$Sim==h]
  nyears<-Nyears$n[h]
  #preyNzero for terns is the threshold total B where prod drops, FIXED based on GOM data
  preyNzero<-COTEprodThresh

  ###predator dynamics###
  #stuff I need
  Recmult<-(preypredrec*(preyN/preyNzero))/((preypredrec-1)+(preyN/preyNzero)) #fraction of expected predator BH recruitment dependent on prey N
  PredAnnualNatM<-PredannualA*exp(-(preyN/preyNzero)*preyprednatm) #needed if annual nat mort is time varying
  TotalSurv<-(1-PredAnnualNatM)*(1-Predexploit) #total annual predator survival
  catch<-c()
  Spawn<-c() #spawners in numbers or biomass depending
  yield<-c()
  Predrec<-c()
  Predrec[1:PredRecdelay]<-Req #set recruitment in initial years at equlibrium to account for delay
  ###year loop for predator dynamics
  for(y in 1:(nyears-1)){
    if(numbs_weight==1){
        catch[y]<-PredN[y]*Predexploit
        Spawn[y]<-PredN[y]-catch[y]
      } else {
        yield[y]<-PredB[y]*Predexploit
        Spawn[y]<-PredB[y]-yield[y]
      }
      Predrec[y+PredRecdelay]<-Recmult[y]*((predalpha*Spawn[y])/(predbeta+Spawn[y])) #SR
      PredN[y+1]<-PredN[y]*TotalSurv[y]+Predrec[y+1]
      }  

simTern1 <- data.frame(yr=seq(1998,2015,1), PredN=PredN[6:23])

#ternpoptrend +   geom_point() +
#  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
#  geom_point(data=simTern, aes(x=yr, y=PredN, colour="Simulated"))+
#  labs(y="Number of nesting pairs", x="Years") +
#  theme_Publication() + scale_colour_Publication()



```

```{r, eval=sg_figs, fig.cap="Population trends for Gulf of Maine terns with and without the simulated herring-common tern productivity relationship. Linear model fit (line) with 95\\% CI band (gray shading) is shown for significant relationships. \\label{terntrendwherring}", message = FALSE, warning = FALSE}
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

#terntotalpop <- ternpopproddiet %>%
#  group_by(yr, species) %>%
#  filter(yr<2016) %>%
#  select(breedpairs, nfledged) %>%
#  filter(!is.na(nfledged)) %>%
#  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

#terntotalpop19982015 <- terntotalpop %>%
#  filter(yr>1997)

ternpoptrend <- ggplot(terntotalpop19982015, aes(x=yr, y=totpairs, colour=species))

# plot with actual data and simulated data from pop model
# WARNING only works with PredN from MSE_TernLink.R reproduced here
#######Some Functions#########
###Function to calculate unfished "SSBR", and abundance or biomass, or equilibrium characteristics given exploitation rate for delay-difference dynamics with Beverton-Holt SR.
#function(unfishedspr,desired unfished N or B, steepness,units of numbs or bio?, annual natural mortality, annual fishery exploitation rate, ford walford parameter intercept, ford walford slope param, do unfished or exploited equilib?)
#unfishspr<-function(predunfishspr=NULL,targzero=NULL,steep=NULL,numbs_weightb=NULL,annualnatmort=NULL,annualexploit=NULL,FWalpha=NULL,FWrho=NULL,unfishflag=NULL) {
#  #see delay-diff chapter of hilborn and walters and common pubs on steepness (Mangel et al 2010)
#  predrzero<-1/predunfishspr*targzero  #unfished recruitment=f(unfishedSSBR,unfished N or B specified by user
#  predalpha<-(4*steep*predrzero)/(5*steep-1) #alpha of BH SR #1/beta? alpha in Mangel et al 2010 is (targzero/predrzero)*((1-steep)/(4*steep)) #
#  predbeta<-((targzero/predrzero)*((1-steep)/(4*steep)))/((5*steep-1)/(4*steep*predrzero)) #beta of BH SR #alpha/beta? beta ibid (5*steep-1)/(4*steep*predrzero)
#  #predalpha<- (targzero/predrzero)*((1-steep)/(4*steep)) #direct from Mangel et al 2010
#  #predbeta<-(5*steep-1)/(4*steep*predrzero) #direct from Mangel et al 2010
#  if(numbs_weightb==1){ #solving in units of numbers or biomass
#    kappa<-1-(1-annualnatmort)*(1-annualexploit) #growth-survival constant (pg 339 Hilborn and Walters)
#    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium N
#    Ceq<-eqvalue*annualexploit #equilibrium catch
#    Req<-kappa*eqvalue #equilibrium recruitment
#    SSeq<-eqvalue-Ceq  #equilibrium spawning stock
#  } else {
#    kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/FWalpha  #growth-survival constant (pg 339 Hilborn and Walters)
#    #kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/(Recwt-((Prerecwt*FWrho)*(1-annualnatmort)*(1-annualexploit)))
#    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium Biomass
#    Yeq<-eqvalue*annualexploit #equilibrium yield
#    Req<-kappa*eqvalue #equilibrium recruitment
#    SSeq<-eqvalue-Yeq #equilibrium spawning stock
#    Neq<-Req/(1-(1-annualnatmort)*(1-annualexploit)) #equilibrium N
#    Weq<-eqvalue/Neq #equilibrium average weight
#  }  
#  if(unfishflag==0){ #if doing unfished then just return unfished spr to optimize function; required for equlibrium calcs
#  return((targzero-eqvalue)^2)
#  } else { #if not doing unfished (exploit>0) then return various equilibrium values
#   if(numbs_weightb==1) { #units of numbers or biomass?
#     return(data.frame("Neq"=eqvalue,"Ceq"=Ceq,"Req"=Req,"SSeq"=SSeq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
#   }else {
#     return(data.frame("Beq"=eqvalue,"Yeq"=Yeq,"Req"=Req,"SSeq"=SSeq,"Neq"=Neq,"Weq"=Weq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
#   }
#  }
#}
#####end function unfishspr#####

#### Common Tern Gulf of Maine pars (see HerringMSEpredspars.xlsx for derivation

#numbs_weight  <-  1  #2 #1=numbers, else weight.  Will predator be tracked just in numbers or numbers and weight?  Weight allows for growth effects.
#Predzero      <-  45000 #5.90E+05 # #5.60E+09  #50000 #predator unfished total N or biomass
#Predsteep     <-  0.26 #0.25  #0.8 #predator steepness
#PredannualA   <-  0.1  #0.6 #predator annual natural mortality rate (0-1); serves as max if time varying
#Predexploit   <-  0.00  #0.3 #predator annual exploitation rate (0-1)
#FWalpha       <-  0.00015#1.5 #  #0.243 #ford-walford plot intercept parameter if doing biomass units tons
#FWrho         <-  0.0  #1.45 #ford-walford plot slope parameter if doing biomass units; serves as max if time varying

#PredN         <-  c() #for predator abundance vector
#PredN[1]      <-  3000  #7000 #initial abundance in year 1
#PredB         <-  c() #for predator biomass vector if doing in those units
#PredB[1]      <-  1.5  #6000 #initial biomass in year 1 
#PredRecdelay  <-  4  #1 #delay in years for when recruits in year y are added to population

preypredrec<-1.09 #strength of effect of prey N on predator recruitment (like Plaganyi and Butterworth) >=1; 1=no effect
#preyprednatm<-0 #strength of effect of prey N on predator annual natural mort (0-1) 0=no effect
#preypredgrow<-1 #strengh of effect of prey N on predator growth, >=1, 1=no effect
  
#COTEprodThresh<-400000

#####End user inputs########

#Do predator unfished equilibrium calculation and get unfished spr
predunfishsprfxn<-optimize(f=unfishspr,interval=c(0,50),targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=0,FWalpha=FWalpha,FWrho=FWrho,unfishflag=0,tol=0.0000001)
predunfishspr<-predunfishsprfxn$minimum
#send unfished spr through function again with an exploitation rate to get equlibrium conditions
PredEquilib<-unfishspr(predunfishspr=predunfishspr,targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=Predexploit,FWalpha=FWalpha,FWrho=FWrho,unfishflag=1)
predalpha<-PredEquilib$predalpha #predator BH SR parm
predbeta<-PredEquilib$predbeta #predator BH SR parm
Req<-PredEquilib$Req
Weq<-PredEquilib$Weq
##############################################
#### Read in Herring "data"
#preyB<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111TotBioSimYear.txt", header=T)  
#preysim<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111NAASimYear.txt", header=T)
preyNsim<-transmute(preysim, preyN=Age1+Age2+Age3+Age4+Age5+Age6+Age7+Age8, Sim=Sim)
     
by_simN<-group_by(preyNsim, Sim)
Nyears<-summarise(by_simN, n=n())

#preychar<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111SimCharAA.txt", header=T)
#preychar<-cbind(preychar, Age=rep(1:8,max(preychar$Sim)))
#BASE ON TOTAL B
Ternforage<-cbind(preyB, Yr=rep(1:Nyears$n, max(preychar$Sim)))
h<-1
  preyN<-Ternforage$TotalBio[Ternforage$Sim==h]
  nyears<-Nyears$n[h]
  #preyNzero for terns is the threshold total B where prod drops, FIXED based on GOM data
  preyNzero<-COTEprodThresh

  ###predator dynamics###
  #stuff I need
  Recmult<-(preypredrec*(preyN/preyNzero))/((preypredrec-1)+(preyN/preyNzero)) #fraction of expected predator BH recruitment dependent on prey N
  PredAnnualNatM<-PredannualA*exp(-(preyN/preyNzero)*preyprednatm) #needed if annual nat mort is time varying
  TotalSurv<-(1-PredAnnualNatM)*(1-Predexploit) #total annual predator survival
  catch<-c()
  Spawn<-c() #spawners in numbers or biomass depending
  yield<-c()
  Predrec<-c()
  Predrec[1:PredRecdelay]<-Req #set recruitment in initial years at equlibrium to account for delay
  ###year loop for predator dynamics
  for(y in 1:(nyears-1)){
    if(numbs_weight==1){
        catch[y]<-PredN[y]*Predexploit
        Spawn[y]<-PredN[y]-catch[y]
      } else {
        yield[y]<-PredB[y]*Predexploit
        Spawn[y]<-PredB[y]-yield[y]
      }
      Predrec[y+PredRecdelay]<-Recmult[y]*((predalpha*Spawn[y])/(predbeta+Spawn[y])) #SR
      PredN[y+1]<-PredN[y]*TotalSurv[y]+Predrec[y+1]
      }  

simTern <- data.frame(yr=seq(1998,2015,1), PredN=PredN[6:23])

ternpoptrend +   geom_point() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, show.legend = FALSE) +
  geom_point(data=simTern1, aes(x=yr, y=PredN, colour="Simulated, no herring link")) +
  geom_point(data=simTern, aes(x=yr, y=PredN, colour="Simulated, herring link")) +
  labs(x="Year", y="Number of nesting pairs", color='Tern species') +
  scale_colour_manual(values=c("#fdb462","#386cb0","#7fc97f","#ef3b2c")) +
  theme_Publication() #+ scale_colour_Publication()


```

---

<!--There is no published stock assessment or population model for most seabirds in the Northeast US. Therefore, Gulf of Maine common and Arctic tern (*Sterna paradisaea*) population parameters were drawn from accounts in the Birds of North America [@hatch_arctic_2002; @nisbet_common_2002] and estimated from counts of breeding pairs and estimates of fledgling success summarized by the Gulf of Maine Seabird Working Group (GOMSWG; data at http://gomswg.org/minutes.html), as corrected and updated by seabird experts from throughout Maine. While we initially analyzed both Arctic and common tern information, the stakeholder workshop identified common terns as the example species for modeling, and this species has more extensive data and a generally higher proportion of herring in its diet based on that data. Therefore, this predator model is based on common terns in the Gulf of Maine. 

Adult breeding pairs by colony were combined with estimated productivity of fledglings per nest to estimate the annual number of fledglings for each year. A survival rate of 10% was applied to fledglings from each year to represent "recruits" to the breeding adult population age 4 and up [@nisbet_common_2002]. This "stock-recruit" information was used to estimate steepness for the delay difference model based on common tern information only. Fitting parameters with R nls [@Rcite] had variable success, with the full dataset unable to estimate a significant beta parameter (dashed line, Figure \ref{ternSR}) for common terns, and a truncated dataset resulting in low population production rates inconsistent with currently observed common tern trends (dotted line, Figure \ref{ternSR}). Therefore, steepness was estimated to give a relationship (solid line, Fig. \ref{ternSR}) falling between these two lines. The resulting stock recruit relationship set steepness at 0.26, a theoretical maximum breeding adult population of 45,000 pairs (@nisbet_common_2002, 1930's New England population), and a theoretical maximum recruitment of 4,500 individuals annually (reflecting approximately a productivity of 1.0 at "carrying capacity" resulting in a stable population). Average common tern productivity is 1.02 (all Gulf of Maine colony data combined). Adult mortality was assumed to be 0.1 for the delay difference model (survival of 90% [@nisbet_common_2002] for adults).
The resulting model based on common tern population dynamics in the Gulf of Maine (with no link to herring) predicts that the population will increase to its carrying capacity under steady conditions over a 150 year simulation. The actual population has increased at ~2% per year between 1998 and 2015 (GOMSWG data). Given the lack of detailed demographic information in the delay-difference model, this was considered a good representation of the average observed trend in current common tern population dynamics. 


### Herring-tern relationship model
The relationship between herring abundance and tern reproductive success was built based on information from individual colonies on annual productivity, proportion of herring in the diet, and amount of herring in the population as estimated by the current stock assessment. Since little of this information has appeared in the peer-reviewed literature, we present it in detail here.  First, productivity information was evaluated by major diet item recorded for chicks over all colonies and years. In general, common tern productivity was higher when a streamlined fish species ("hake", "herring", and "sandlance" in Fig. \ref{chickdiet}) was the major diet item relative to invertebrates ("amphipod", "euphausiid", "inverts"=unidentified invertebrates in Fig. \ref{chickdiet}). However, having herring as the major diet item resulted in about the same distribution of annual productivities as having unidentified juvenile hake (*Urophycis* or *Merluccius* sp.) or sandlance (*Ammodytes* sp.) as the major diet item for these colonies (Fig. \ref{chickdiet}). 

Individual colonies showed different trends in number of nesting pairs, productivity, and proportion of herring in the diet (plots available upon request). When both Arctic and common terns shared a colony, interannual changes in productivity were generally similar between species, suggesting that conditions at and around the colony (weather, predation pressure, and prey fields) strongly influenced productivity rather than species-specific traits. Only two colonies (Machias Seal Island near the US/Canada Border and Stratton Island in southern Maine) showed a significant positive correlation between the proportion of herring in the chick diet and productivity (Machias Seal: Spearman's rank rho = 0.63, p = 0.019; Stratton: Spearman's rank rho = 0.52, p = 0.035). Other islands showed either non-significant (no) relationships, or in one case (Metinic Island) a significant negative relationship (Fig. \ref{proddiet}). 

The estimated population size of herring on the Northeast US shelf had some relationship to the amount of herring in tern diet at several colonies (4 of 13 common tern colony diets related to herring Age 1 recruitment, 6 of 13 common tern colony diets related to herring total biomass (B), and 4 of 13 common tern colony diets related to herring SSB; detailed statistics and plots available upon request). However, statistically significant direct relationships between herring population size and tern productivity were rare, with only Ship Island productivity increasing with herring total B, and Eastern Egg Rock, Matinicus Rock, Ship, and Monomoy Islands productivity increasing with herring SSB. Given that Monomoy Island tern chicks consistently displayed the lowest proportion of herring in their diets of any colony (0-11%), we didn't consider this relationship further to build the model.  

Based on tern feeding observations, we would expect the number of age 1 herring in the population to be most related to tern productivity since that is the size class terns target, but this relationship was not found in analyzing the data. Herring total biomass was positively related to tern diets at nearly half of the colonies, and reflects all size classes including the smaller sizes most useful as tern forage, but was only directly related to tern productivity at one colony.  Herring SSB was not considered further as an index of tern prey because it represents sizes larger than tern forage. 

<!--Examining all colonies together shows some relationship between herring population size and herring in tern diets, but no consistent relationship between the proportion of herring in tern diets and tern productivity, or between herring population size and tern productivity. Therefore, a reasonable lower bound on the potential for herring to influence tern productivity in the Gulf of Maine is no relationship, and any herring control rule (short of one that severely overfishes or eliminates the stock) would not expected to affect tern productivity under this assumption.--> 

<!--To represent the potential for herring to influence tern productivity, we parameterized a tern "recruitment multiplier" based on herring assessed total biomass and common tern productivity across all colonies (except Monomoy Island where terns eat sandlance). This relationship includes a threshold herring biomass where common tern productivity would drop below 1.0, and above that threshold productivity exceeds 1.0 (Fig. \ref{herrternmod}). The threshold of ~400,000 metric tons is set where a linear relationship between herring total biomass and common tern productivity crosses productivity=1 (black dashed line in Fig. \ref{herrternmod}). However, the selected threshold is uncertain because there are few observations of common tern productivity at low herring total biomass (1975-1985). The linear relationship does not have a statistically significant slope; a curve was fit to represent a level contribution of herring total biomass to common tern productivity above the threshold. The curve descends below the threshold, dropping below 0.5 productivity at around 50,000 tons and representing the extreme assumption that herring extinction would result in tern productivity of 0. Although the relationship of tern productivity to herring biomass at extremely low herring populations has not been quantified, control rules that allow herring extinction do not meet stated management objectives for herring, so this extreme assumption for terns will not change any decisions to include or exclude control rules. 

When included in the model using $\gamma$ = 1.09 in equation \ref{recwithherring_equation}, this relationship adjusts the modeled common tern population increase to match the current average increase in common tern nesting pairs observed in the data (Fig. \ref{terntrendwherring}). There is still considerable uncertainty around this mean population trajectory which cannot be reflected in our simple model. 

### Groundfish population and herring-groundfish relationship models
Because no specific groundfish was identified as a representative herring predator during the stakeholder workshop, the first decision was which groundfish to model. Annual diet estimates (based on sample sizes of ~100+ stomachs) are available for the top three groundfish predators of herring (those with herring occurring in the diets most often in the entire NEFSC food habits database): spiny dogfish (*Squalus acanthias*, hereafter dogfish), Atlantic cod (*Gadus morhua*, hereafter cod), and silver hake (*Merluccius bilinearis*). Cod and spiny dogfish were considered first because their overall diet proportions of herring are higher, and because silver hake has the least recently updated assessment. Diet compositions by year were estimated for spiny dogfish, Georges Bank cod, and Gulf of Maine cod to match the scale of stock assessments. Full weighted diet compositions were estimated, and suggest considerable interannual variability in the herring proportion in groundfish diets (filled blue proportions of bars in Fig. \ref{gfishdiets}).  


Some interannual variation in diet may be explained by changing herring abundance. Dogfish and both cod stocks had positive relationships between the amount of herring observed in annual diets and the size of the herring population according to the most recent assessment (statistics and plots available upon request). This suggests that these groundfish predators are opportunistic, eating herring in proportion to their availability in the ecosystem. However, monotonically declining cod populations for both Gulf of Maine and Georges Bank cod stocks resulted in either no herring-cod relationship, or a negative relationship between herring populations and cod populations (Fig. \ref{gfishBherrdiet}). Only dogfish spawning stock biomass had a positive relationship with the proportion of herring in dogfish diet. Therefore, we selected dogfish as the groundfish predator for modeling.


## Dogfish population population and herring-dogfish relationship models

```{r,eval=sg_figs, fig.cap="Annual percent of herring in diet compositions for major groundfish predators of herring (dogfish and two cod stocks) estimated from NEFSC food habits database. Prey identified to herring family (Clupeidae, open bars) as well as Atlantic herring (filled bars) are included. \\label{gfishdiets}", fig.height=8, fig.width=11, out.width='\\linewidth', message = FALSE, warning = FALSE}

#dogdiet   <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/GroundfishDat/dogfishdietcomp.csv")
#GBcoddiet <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/GroundfishDat/GBcoddietcomp.csv")
#GOMcoddiet <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/GroundfishDat/GOMcoddietcomp.csv")

names(dogdiet)[1]<-"Year"
names(GBcoddiet)[1]<-"Year" 
names(GOMcoddiet)[1]<-"Year"

dogdiet <- cbind(dogdiet, Pred=rep("dogfish", dim(dogdiet)[1]))
GBcoddiet <- cbind(GBcoddiet, Pred=rep("GBcod", dim(GBcoddiet)[1]))
GOMcoddiet <- cbind(GOMcoddiet, Pred=rep("GOMcod", dim(GOMcoddiet)[1]))

dogdiet <- gather(dogdiet, Prey, Percent, -Year, -Pred)
GBcoddiet <- gather(GBcoddiet, Prey, Percent, -Year, -Pred)
GOMcoddiet <- gather(GOMcoddiet, Prey, Percent, -Year, -Pred)

dogcoddiet <- bind_rows(dogdiet, GBcoddiet, GOMcoddiet)

dogcoddiet$fillwhite <- with(dogcoddiet, ifelse(Prey=="CLUHAR", 1,0))

compplot2 <- ggplot(dogcoddiet, aes(Year, Percent, colour=Prey)) + 
  geom_bar(stat = "identity", aes(fill=fillwhite))
  #geom_bar(stat = "identity") 

herrindiet <- dogcoddiet %>%
  filter(Prey %in% c("CLUHAR", "CLUFAM"))

#herrindiet$fillwhite <- with(herrindiet, ifelse(Prey=="CLUHAR", 1,0))

compplot3 <- ggplot(herrindiet, aes(Year, Percent, colour=Prey)) + 
  #geom_bar(stat = "identity", aes(fill=fillwhite)) +
  geom_bar(stat = "identity", aes(fill=Prey)) +
  scale_colour_manual(values=c("#ef3b2c", "#7fc97f"),
                    labels=c("Clupeidae", "A. herring")) +
  scale_fill_manual(values=c(NA,"#7fc97f"),
                    labels=c("Clupeidae", "A. herring")) +
  ylim(0,100)

labels <- c(dogfish = "dogfish", GBcod = "Georges Bank cod stock", GOMcod = "Gulf of Maine cod stock")

compplot3 + facet_wrap("Pred", labeller=labeller(Pred = labels), nrow=3)  +
  theme_Publication()  # + theme(legend.position="none")

```



```{r, eval=sg_figs, fig.cap="Relationship of groundfish predator (dogfish, GBcod = Georges Bank cod, and GOMcod = Gulf of Maine cod) spawning stock biomass (SSB) with the percentage of herring in diet: both all clupeids including Atlantic herring (All Clupeids) and Atlantic herring only (A. herring). Linear model fit (line) with 95\\% CI band (gray shading) is shown for significant relationships. \\label{gfishBherrdiet}", message = FALSE, warning = FALSE}
#codGB<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GBcodpop.csv")
#codGOM<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMcodpop.csv")
#dogfish<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishpop.csv")
#gfishdiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Gfishdiets.csv")
#herring <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/herringassessout2015.csv")
#herring <- herring[,1:6]
#dogfishrec <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishrec.csv")

# add species column, tidy and combine datasets
codGB <- cbind(codGB, species=rep("GBcod", dim(codGB)[1]))
codGOM <- cbind(codGOM, species=rep("GOMcod", dim(codGOM)[1]))
dogfish <- cbind(dogfish, species=rep("dogfish", dim(dogfish)[1]))
dogfish <- full_join(dogfish, dogfishrec)

gfishdiet <- gfishdiet %>%
  gather(preypred, dietprop, 2:9) %>%
  separate(preypred, c("prey", "species"), sep="_")

codpops <- full_join(codGB, codGOM)
names(codpops)[1]<-"Yr"
names(dogfish)[2:12] <- c("LargeB", "MedB", "RecAge1t",
                          "TotJan1B","survSSB", "survSSB_MA","stocExpB",
                          "stocTotB", "stocSSB", "SSBkgtow", "SSB")

#put all in t not 1000t
dogfish <- dogfish %>%
  mutate_at(vars(LargeB, MedB, RecAge1t,TotJan1B, survSSB, survSSB_MA,
                 stocExpB, stocTotB, stocSSB, SSB),
            funs(.*1000))

dogfish <- dogfish %>%
  mutate(RecAge1 = RecAge1t/PupAvgWtkg) %>% #rec in 1000 fish matches cod units
  mutate(TotJan1B = replace(TotJan1B, TotJan1B==0, NA)) #2014 missed survey

gfishpops <- full_join(codpops, dogfish)

#merge fishpops and fish diets
gfishpopfood <- left_join(gfishpops, gfishdiet, by=c("Yr"="Year", "species"="species"))

gfishpopfood <- filter(gfishpopfood, !is.na(prey)) 

sppdat <- gfishpopfood %>%
  group_by(species) %>%
  #filter(prey == "CLUHAR") %>%
  filter(prey == "CLUALL") %>%
  do(fitHerDiet = lm(SSB ~ dietprop, data = .))

sppcoef <- tidy(sppdat, fitHerDiet)
#filter(sppcoef, p.value<0.1)

#only GBcod diet prop is significant for CLUHAR and CLUALL, plot line only for those

GBcodfood <-gfishpopfood %>%
  filter(species == "GBcod")

gfishSSBdiet <- ggplot(gfishpopfood, aes(x=dietprop, y=SSB, colour=prey)) + 
  geom_point() 

gfishSSBdiet + facet_wrap(~species) + 
  stat_smooth(data = GBcodfood, method = "lm", formula = y ~ x, size = 1, show.legend = FALSE) +
  labs(x="Percent herring in diet") +
  theme_Publication() + scale_colour_Publication(labels=c("All Clupeids", "A. herring"))


```

<!--
```{r, eval=sg_figs, fig.cap="Dogfish population relationships with herring total biomass (left) and herring proportion in diet (right) \\label{pupherring}", out.width='.49\\linewidth', fig.show='hold', fig.align='center', message = FALSE, warning = FALSE}
#codGB<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GBcodpop.csv")
#codGOM<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMcodpop.csv")
#dogfish<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishpop.csv")
#gfishdiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Gfishdiets.csv")
#herring <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/herringassessout2015.csv")
#herring <- herring[,1:6]
#dogfishrec <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishrec.csv")

# add species column, tidy and combine datasets
#codGB <- cbind(codGB, species=rep("GBcod", dim(codGB)[1]))
#codGOM <- cbind(codGOM, species=rep("GOMcod", dim(codGOM)[1]))
#dogfish <- cbind(dogfish, species=rep("dogfish", dim(dogfish)[1]))
#dogfish <- full_join(dogfish, dogfishrec)

#gfishdiet <- gfishdiet %>%
#  gather(preypred, dietprop, 2:9) %>%
#  separate(preypred, c("prey", "species"), sep="_")

#codpops <- full_join(codGB, codGOM)
#names(codpops)[1]<-"Yr"
#names(dogfish)[2:12] <- c("LargeB", "MedB", "RecAge1t",
#                          "TotJan1B","survSSB", "survSSB_MA","stocExpB",
#                          "stocTotB", "stocSSB", "SSBkgtow", "SSB")
#put all in t not 1000t
#dogfish <- dogfish %>%
#  mutate_at(vars(LargeB, MedB, RecAge1t,TotJan1B, survSSB, survSSB_MA,
#                 stocExpB, stocTotB, stocSSB, SSB),
#            funs(.*1000))

#dogfish <- dogfish %>%
#  mutate(RecAge1 = RecAge1t/PupAvgWtkg) %>% #rec in 1000 fish matches cod units
#  mutate(TotJan1B = replace(TotJan1B, TotJan1B==0, NA)) #2014 missed survey

#gfishpops <- full_join(codpops, dogfish)

#merge fishpops and fish diets
gfishpopfood <- left_join(gfishpops, gfishdiet, by=c("Yr"="Year", "species"="species"))
gfishpopfood <- filter(gfishpopfood, !is.na(prey)) 
# merge herring assessment out with gfish
gfishpopfoodherr <- left_join(gfishpopfood, herring, by=c("Yr"="yr"))

#Dogfish population model
dogfishfoodherr <- gfishpopfoodherr %>%
  filter(species=="dogfish") 

#dogfishpoptrend <- ggplot(dogfishfoodherr, aes(x=Yr, y=TotJan1B)) + geom_point()
#dogfishdiet <- ggplot(dogfishfoodherr, aes(x=Yr, y=dietprop, colour=prey)) + geom_point()
pupwtdiet <- ggplot(dogfishfoodherr, aes(x=dietprop, y=PupAvgWtkg, colour=prey)) + geom_point() + ggtitle("Dogfish pup average weights 1980-2009")
#Fwtdiet <- ggplot(dogfishfoodherr, aes(x=dietprop, y=FAvgWtkg, colour=prey)) + geom_point()

dogfishlow <- dogfishfoodherr %>%
  filter(Yr>1994 & Yr<2008)

#lowdogfishdiet <- ggplot(dogfishlow, aes(x=Yr, y=dietprop, colour=prey)) + geom_point()
lowpupwtdiet <- ggplot(dogfishlow, aes(x=dietprop, y=PupAvgWtkg, colour=prey)) + geom_point() + ggtitle("Dogfish pup average weights 1995-2007")
#lowFwtdiet <- ggplot(dogfishlow, aes(x=dietprop, y=FAvgWtkg, colour=prey)) + geom_point()

#lowpupwtdiet #+ stat_smooth(method = "lm", formula = y ~ x, size = 1)
#pupwtdiet #+ stat_smooth(method = "lm", formula = y ~ x, size = 1)

#pup wt was higher earlier in the time series when herring low
#pupwttrend <- ggplot(dogfishfoodherr, aes(x=Yr, y=PupAvgWtkg)) + geom_point() + ggtitle("Dogfish average pup weight from NEFSC surveys")

#positive relationship between populations but weak
dogherrB <- ggplot(dogfishfoodherr, aes(x=HerringTotalB, y=TotJan1B)) +
  geom_point() +
  ggtitle("Dogfish total biomass 1968-2016")
#stat_smooth(method = "loess", formula = y ~ x, size = 1) + 
#stat_smooth(method = "lm", formula = y ~ x, size = 1)

dogherrB+
  theme_Publication() + scale_colour_Publication()
pupwtdiet+
  theme_Publication() + scale_colour_Publication()
```

-->

```{r, eval=sg_figs, message = FALSE, warning = FALSE, fig.show='hold', out.width='0.4\\linewidth'}
#fig.cap="Modeled herring relative population size-dogfish natural mortality relationship \\label{herringdogfish}",
# from MSE_GroundfishLink.R
PredannualA   <-  0.092  #0.6 #predator annual natural mortality rate (0-1); serves as max if time varying
Predexploit   <-  0.092  #0.3 #predator annual exploitation rate (0-1)
preyprednatm<-0.2 #strength of effect of prey N on predator annual natural mort (0-1) 0=no effect

preypopratio  <-  seq(0,2,by=0.01) # standing in for preyN/preyNzero
PredAnnualNatM   <-  c()

PredAnnualNatM<-PredannualA*exp(-(preypopratio)*preyprednatm) 

qplot(preypopratio, PredAnnualNatM, geom="line", xlab = "Current herring abundance / unfished herring abundance", ylab = "Dogfish annual natural mortality (v)") +
  theme_Publication() + scale_colour_Publication()

#TotalSurv<-(1-PredAnnualNatM)*(1-Predexploit) #total annual predator survival

```


<!--The dogfish model stock recruitment function, initial population, and annual natural mortality were adapted from information in @rago_implications_1998; @rago_biological_2010; @bubley_reassessment_2012, and @rago_update_2013. Due to differential growth and fishing mortality by sex, our model best represents female dogfish (a split-sex delay difference model was not feasible within the time constraints of this MSE). Further, dogfish stock-recruit modeling to date based on Ricker functions [@rago_biological_2010] captures more nuances in productivity than the Beverton-Holt model we used. Our recruitment parameterization reflects a stock with generally low productivity and relatively high resilience, which we recognize is a rough approximation for a species such as dogfish. The annual fishing exploitation rate applied is the average of the catch/adult female biomass from the most recent years of the 2016 data update provided to the Mid-Atlantic Fishery Management Council (Rago pers comm 2016). 

### Herring-dogfish relationship model
There was a weak positive relationship between dogfish total biomass and herring total biomass from the respective stock assessments (Spearman's rank correlation = 0.36, p = 0.012; Pearson's correlation = 0.32, p = 0.026), but no significant relationship between dogfish weight or dogfish recruitment and herring population size. During the recent period of relatively low dogfish recruitment (1995-2007), there was a positive relationship between juvenile dogfish (pup) average weight and herring proportion in diet, suggesting a potential growth and/or recruitment mechanism; however this relationship does not hold throughout the time series, so we considered it too weak as a basis for population modeling. 

Therefore, to simulate a potential positive relationship between herring and dogfish, we assumed that dogfish survival increased (natural mortality was reduced) by an unspecified mechanism as herring abundance increased (Fig. \ref{herringdogfish}). Because dogfish are fully exploited by fisheries in this model, the impact of this change in natural mortality on total survival has small to moderate benefits to dogfish population numbers and biomass. Using a $\delta$ = 0.2 in equation \ref{varmort_equation} results in weak increases in dogfish biomass with herring abundance consistent with observations.

### Marine mammals

Because no specific marine mammal was identified as a representative herring predator in the stakeholder workshop, as with groundfish, the first decision was which marine mammal to model. Diet information for a wide range of marine mammals on the Northeast US shelf suggests that minke whales (*Balaenoptera acutorostrata*), humpback whales (*Megaptera novaeangliae*), harbor seals (*Phoca vitulina*), and harbor porpoises (*Phocoena phocoena*) have the highest proportions of herring in their diets [@smith_consumption_2015], and therefore may show some reaction to changes in the herring harvest control rule. 

While some food habits data existed for marine mammals, consultation with marine mammal stock assessment scientists at the Northeast Fisheries Science Center confirmed that no data were available to parameterize a stock-recruitment relationship for any of these marine mammal species in the Northeast US region, and no such information was available in the literature for stocks in this region. Although it may be possible to develop stock-recruitment models for one or more of these species in the future, it was not possible within the time frame of the herring MSE. Therefore, we were unable to model marine mammals within the same framework as other predators. 

Potential effects of changes in herring production and/or biomass on marine mammals were instead evaluated using an updated version of an existing food web model for the Gulf of Maine [@link_northeast_2008; @link_response_2009; @link_documentation_2006] and incorporating food web model parameter uncertainty. Overall, food web modeling showed that a simulated increase in herring production in the Gulf of Maine may produce modest but uncertain benefits to marine mammal predators, primarily because increased herring was associated with decreases in other forage groups also preyed on by marine mammals. However, this could not be pursued further within the MSE framework. <!--Please see Appendix 1 of this document for full analyses and results.--> 

<!--Predator model input parameters are summarized in Table \ref{predpars}. 
-->
## Economics

- some modeling, should have been lots more
- the dream: predator response links to ecosystem services, human well being
- takes way more time
<!--
### The Herring Fishery
The economic model of the herring fishery converts yield, $Y$, from the herring model component into Gross Revenues (GR) and Net Operating Revenues (NR).  There are two fleets, trawl and purse seine, that are assumed to have the ability to catch 70 and 30% of the yield, respectively. This division corresponds to recent historical patterns.  The midwater trawl, paired midwater trawl, and bottom trawl are all aggregated into the trawl fleet. Gross Revenue, Net Revenue, and the constraints on harvest can be represented as (year subscripts omitted here for simplicity):

\begin{align}
GR&=p(q^t+q^s)q^t+p(q^t+q^s)q^s\\
NR&=GR-c^t(q^t)-c^s(q^s)
\end{align}
where $q^i$ is the quantity landed for fleet $i$, $c^i(q^i)$ is cost function for fleet $i$, and $p(\cdot)$ is a function that relates total landings to prices.  
\begin{align}
\label{optimization_problem}
\max_{q_i} NR^i&=p(q^t+q^s)q^i - c^i(q^i)\\
q^s &\leq .3yield; \hspace{2mm} q^t \leq .7yield 
\end{align}
The optimization problem in equation \ref{optimization_problem} contains two embedded assumptions: total catch is less than or equal to yield and that a fleet may catch less than its fraction of yield (presumably because it may be more profitable to select a lower level of landings).

Economic data collected from 2011-2015 by the Northeast Fisheries Observer Program (NEFOP) were used to construct average daily costs for the trawl and purse seine fleets.  Fuel prices were much lower in 2011-2014 compared to 2015. We adjusted fuel prices to the 2011-2014 average; sensitivity analysis was performed by setting fuel prices to the 2015 levels but results are not reported here.  Other costs of fishing included water, oil, and damage costs. Crew pay and fixed costs were not included.  

We construct average catch per day fished for each fleet from the Vessel Trip Report (VTR) databases over the same time period.  The trip lengths in the VTR and observer data were similar. This allows us to construct the average cost of catching a metric ton of herring for the trawl and purse seine fleet ($c^t$ and $c^s$ respectively).  We assume that the average cost is equal to the marginal cost for each fleet.  These figures are presented in Table \ref{costs_combined}.

Annual prices were constructed from NMFS dealer data for 1982 through 2016. Annual landings were constructed from the processed ME DMR landings dataset for the same time period.Prices have been normalized to 2015 real dollars using the Bureau of Labor Statistics (BLS) Producer Price Index (PPI) for Unprocessed and Packaged Fish (WPU0223). Because Atlantic Herring was not federally managed prior to the implementation of the Herring FMP in 2000; the NMFS dealer databases may not contain all landings prior to this time. The ME DMR data do not contain prices but is a census of landings.  Exploratory analysis suggested both a regime change in the mid-1990s and likely non-stationarity of both landings and prices.  We used the testing methodology developed by @Pesaran2001BoundsRelationships to examine the existence of a long-run relationship between prices and quantities. This method does not require pretesting for stationarity; however, the test statistic does have an inconclusive zone in which knowledge of stationarity would be required. A long-run relationship between prices and landings can be modeled as:


\begin{equation}
\label{ARDL}
p_{y}= c+\sum_{i=1}^p a_i p_{t-i}+ \sum_{i=0}^n b_i q_{y-i} + e_{t},
\end{equation}
or equivalently as an error correction model (ECM):

\begin{equation}
\label{ECM}
\Delta p_y= \gamma+ \alpha_1 p_{y-1} + \sum_{i=1}^p \theta_i \Delta p_{y-i}+ \sum_{i=0}^n  \beta_i \Delta q_{y-i} + e_{y},
\end{equation}
where $\Delta$ is the first-differences operator [@Pesaran2001BoundsRelationships]. The $\gamma$ parameter must also be restricted ($\gamma=c / \alpha_1$) for equations \ref{ARDL} and \ref{ECM} to be equivalent.  @Pesaran2001BoundsRelationships tests the null of no long-run relationship using a joint F-test evaluating whether the $\alpha_1$ and $\beta_i$ parameters in equation \ref{ECM} are non-zero; however, the F-statistic has a non-standard distribution with an inconclusive area.

Equation \ref{ECM} was first estimated on the full 1982-2015 dataset; model selection criteria indicated a model with four lags of price and no lags of quantities (p=4, n=0) was preferred and that prices and quantities had no long-run relationship.  We suspect this is likely caused by a combination of overfitting of the model and a regime shift evident in the exploratory graphs. Rather than explore a regime switching model, we simply estimated equation \ref{ECM} with $p=1, n=0$ on a subset of the data (1995-2015).  If there was a regime shift, the current regime is more likely to be similar to the future.  Models estimated in natural logarithms and in levels fit well. The PSS F-statistics of 9.34 and 10.20 are above the upper critical value, strongly suggesting a long-run relationship between prices and quantities (Table \ref{ardl_regression}).  We also present the results of the ARDL(1,0) formulation because it is a bit easier to interpret. As a robustness check, we also tried varying the first (1996) and last (2016) year included in the dataset.  This did not change the estimated results substantially. We also estimated a short-run relationship between prices and quantities in which $\Delta p_y$ was regressed on $\Delta q_y$.  The short-run effects were qualitatively similar to the "long-run" model in Table \ref{ardl_regression}.  Coefficients from the ``level'' equation (Column 1 of Table \ref{ardl_regression}) are used in the simulation. 



<!-- 
MY's code for running regressions is here: /home/mlee/Documents/Herring_PDT_work/Amendment8/MSE_ABC/price_things/  herring_realprice_timeseries.do  herring_realprice_timeseries2.do
-->

<!--The simulation of Gross operating revenues occurs in a few steps.  Herring prices in a year are simulated using equations \ref{optimization_problem} and \ref{ARDL} and parameters from Table \ref{ardl_regression} previous year prices (initialized to the 2011-2015 average for the first year) under the assumption that both fleets combine to land the entire Yield.  Following @Lehuta2013InvestigatingEngland, if the price of herring is sufficiently high, we assume that consumers find it worthwhile to switch to menhaden.  If the simulated prices are higher than the price of menhaden (\$242/mt) plus transport costs (\$133/mt), we set the price of herring to \$375/mt.  When simulated prices are higher than the marginal cost of the trawl fleet(\$63.24/mt), both fleets are assumed to catch the entire Yield.  Otherwise, we use equations \ref{optimization_problem} and \ref{ARDL} to solve for quantity landed by the trawl fleet when the purse seine fleet lands 30% of yield. If it is optimal for the trawl fishery to land nothing, we use equations \ref{optimization_problem} - \ref{ARDL} to find the purse seine's optimal amount of landings. Because the marginal costs for the purse seine are always less than the marginal costs of the trawl fishery, any landings by the trawl fleet imply the purse seine fleet is landing 30% of the yield.  Net revenues to the fishery can then be calculated directly from equation \ref{optimization_problem}.

## Performance Metrics
<!--
For each combination of control rule and operating model (43,680 unique combinations), 100 simulations lasting 150 years were conducted.  Preliminary simulations suggested that this number of simulations and years was sufficient for results to be insensitive to starting conditions and short-term dynamics caused by auto-correlated processes. The simulated herring time series for every operating model and control rule was passed to the predator and economic submodels, resulting in outputs as described below using the equations above.  We report performance metrics over the final fifty years as a way to describe the long-run performance of a particular control rule.  Performance metrics were derived directly from the results of the stakeholder workshop and supplemented with additional metrics drawn from MSE best practices [@punt_management_2016].

### Herring performance metrics

Median SSB, $\frac{SSB}{SSB_{F=0}}$,  $\frac{SSB}{SSB_{MSY}}$, *yield*, $\frac{yield}{MSY}$, biomass of herring dying due to $M$, and the proportion of the herring population comprised of age-1 fish  were recorded as herring performance metrics.  Additional performance metrics included the proportion of years with $SSB < SSB_{MSY}$, $SSB < \frac{SSB_{MSY}}{2}$ (i.e., proportion years the the stock is overfished), $SSB < 0.3SSB_{F=0}$, $SSB < 0.75SSB_{F=0}$, fully-selected $F > F_{MSY}$ (i.e., proportion of years that overfishing occurred), and the proportion of years *Q*=0 (i.e., proportion of years that the fishery was closed).  Interannual variation in yield (*IAV*) was also recorded:
\begin{equation}
IAV=\frac{\sqrt{\frac{1}{50}\sum\limits_{y=1}^{50}(Y_{y+1}-Y_{y})^2}}{(\frac{1}{50}\sum\limits_{y=1}^{50}Y_y)}.
\end{equation}

### Predator Performance Metrics
Population abundance and recruitment were direct outputs for all modeled predators. Population biomass was directly output for tuna and dogfish. Stakeholders were interested in predator condition for fish and marine mammal predators at the first workshop. While delay difference models do not track individuals or age cohorts, a measure of population average weight (population biomass/population numbers) was output for tuna and dogfish. 

Productivity, the number of fledglings per breeding pair, was output for the tern model. Productivity was calculated as adult recruitment times 10 (to account for the 10% survival rate of fledglings to adults) divided by tern abundance 4 years earlier in the simulation. 

Stakeholders were interested in different measures of population status depending on the predator. For commercially fished species, status relative to current management reference points was preferred. Tuna and dogfish biomass was divided by a biomass reference point specified in current stock assessments: tuna $SSB_{MSY}^P$ was 13226 [@iccat_report_2015], and dogfish $SSB_{MSY}^P$ was 159288 [@rago_biological_2010]. Because dogfish were fully exploited in our model, they did not reach $SSB_{MSY}^P$, so we also evaluated status relative to 0.5 $SSB_{MSY}^P$ ("overfished"). Tuna condition status was assessed by dividing the output population average weight with the equilibrium average weight. Common tern colonies are managed to improve productivity, so stakeholders suggested that a common tern productivity level of 0.8 would be a minimum threshold, while a productivity of 1.0 would be a target. In addition, total population status was measured relative to current population numbers using the rationale that maintaining at least the current population was desirable. The average common tern population of nesting pairs (including Monomoy) from 1998-2015 was 16000. 

Evaluating the frequency of desirable or undesirable states over the course of a simulation is suggested by @punt_management_2016. We calculated two metrics for each of the status determinations. First, we calculated the minimum number of years in any individual simulation that a metric was above a given threshold. This is a "worst case scenario" metric. Second, we calculated the median proportion of years across all simulations for a control rule that were above the threshold. This is an "average performance" metric addressing how often good status is maintained.

For all metrics other than "frequency of good status" metrics, we report the median value for each simulation. Then, the 25th percentile, the median, and the 75th percentile of these 100 medians were calcualted to represent the performance metric for a particular control rule. Results reported here focus on the median.

### Economic Performance Metrics
Median Gross and Net Revenues were performance metrics that were constructed directly from the economic submodel analogously to the way predator and herring performance metrics were constructed.  Stakeholders were also interested in understanding stability of the herring industry. We introduce a new stability performance metric that characterizes the time-series of net revenues as in equilibrium or dis-equilibrium [@Dickey1979DistributionRoot].  For each simulation, we perform an econometric test of stationarity [@Dickey1979DistributionRoot], by estimating:

\begin{equation}
\label{DF_estimated}
\Delta NR_{t} = \beta  NR_{t-1} + \xi_1 \Delta NR_{t-1} + \varepsilon. 
\end{equation}

Statistical evidence that $\beta=0$ is evidence of dis-equilibrium (nonstationarity) of NR while statistical rejections of $H_0: \beta=0$ in favor of $H_A: \beta<0$ is evidence of equilibrium (stationarity).  Some of the control rules set quotas that are constant for three or five years; for these policies, we aggregated Net Revenue into three or five year blocks to examine the equilibrium properties across those blocks.  The results of these tests are summarized in two ways.  First, we use the unweighted Z-transform method from the meta-analysis literature to combine the results of these simulations [@stouffer1949american; @Whitlock2005CombiningApproach]. This allows for a test of the  null hypothesis that a particular control rule implemented on a particular operating model does not produce a stable equilibrium. Defining $\phi$ as the standard normal cumulative distribution function, we construct:
\begin{align}
Z  &= \frac{\sum_{i=1}^k \phi^{-1} (1-p_i)}{\sqrt(k)}
\end{align}
$Z$ has a standard normal distribution under the null hypothesis of dis-equilibrium.  We define the performance metric *Equil1* as the $p$-value associated with rejecting the null hypothesis that particular control rule leads to dis-equilibrium of net revenue. Small values of *Equil1* are evidence of a stable equilibrium.  As a robustness check, we define the performance metric *Equil2* as the percentage of simulations in which we reject the null $H_0: \beta=0$ from equation \ref{DF_estimated}.   Large values of *Equil2* are evidence of a stable equilibrium.

#Results

Some performance metrics were redundant, showed similar tradeoffs, or were expected not to vary among operating models or control rules.  For example, the proportion of age-1 herring in the population was insensitive to control rules because the fishery does not select age-1 fish.  Such metrics were listed above to accurately document the outcome of the stakeholder process, but results below were focused on metrics likely of broad interest or with possible sensitivities to operating models or control rules. A subset of eleven metrics is presented with abbreviations for reference in figures: herring relative yield ("relyield") $\frac{yield}{MSY}$; herring interannual variation in yield ("yieldvar") *IAV* above; the proportion of years *Q*=0 ("closure") the herring fishery was closed; herring relative spawning stock biomass ("relSSB") $\frac{SSB}{SSB_{F=0}}$; the proportion of years the herring stock is overfished ("overfished") $SSB < \frac{SSB_{MSY}}{2}$; probability of good tern productivity ("ternprod") the median proportion of years that tern fledglings/breeding pair >= 1.0; probability of good dogfish status ("dogstatus") the median proportion of years that dogfish SSB relative 0.5 $SSB_{MSY}^P$ >= 1.0; probability of good tuna weight status ("tunawt") the median proportion of years that tuna population weight (population population biomass/population numbers) >= average; median herring fishery net revenue ("net revenue") as described above; herring fishery stable equilibrium ("equil1") if metric is small as described above; and herring fishery stable equilibrium ("equil2") if metric is large as described above. 

## Effect of Operating Models

```{r YAY, fig.cap="Differences between operating models (OM) for key metrics. Boxplots represent the median (wide line within the box) and 25th and 75th percentiles (box) of the distribution of medians for final 50 years of each simulation for each performance metric (x-axis label, please see text for definitions) and operating model (see Table 2 for definitions) across all control rule types. Boxplot whiskers include the highest and lowest observations within 1.5 box lengths from the box. Observations further than 1.5 box lengths from the box (outliers) are represented by points. \\label{YAY}", fig.height=14, fig.width=11.5, out.width='\\linewidth', message = FALSE, warning = FALSE}
# metrics <- c('stouffer',
#              'stationary',
#              'p50_NR',
#              'PropClosure',
#              'MedSSBrelSSBmsy',
#              'PropSSBrelhalfSSBmsy',
#              'YieldrelMSY',
#              'Yvar',
#              'MedPropYrs_goodProd_Targplustern', 
#              'MedPropYrs_okBstatus', 
#              'MedPropYrs_goodAvWtstatus'
#              )
# metlabels <- c('equilibrium1',
#                'equilibrium2',
#                'revenue',
#                'closure',
#                'relSSB',
#                'overfished',
#                'relyield',
#                'yieldvar',
#                'ternprod',
#                'dogstatus',
#                'tunawt'
#                )


metrics <- c('YieldrelMSY',
             'Yvar',
             'PropClosure',
             'MedSSBrelSSBmsy',
             'PropSSBrelhalfSSBmsy',
             'MedPropYrs_goodProd_Targplustern', 
             'MedPropYrs_okBstatus', 
             'MedPropYrs_goodAvWtstatus',
             'p50_NR',
             'stouffer',
             'stationary'
             )


metlabels <- c('relyield',
               'yieldvar',
               'closure',
               'relSSB',
               'overfished',
               'ternprod',
               'dogstatus',
               'tunawt',
               'net revenue',
               'equil1',
               'equil2'
               )


OMs <- unique(allres$OM)

OMlabels <- c('LowFastBiased', 
              'LowSlowBiased', 
              'LowFastCorrect', 
              'LowSlowCorrect',  
              'HighFastBiased',  
              'HighSlowBiased', 
              'HighFastCorrect',
              'HighSlowCorrect'
              )

#OM (8) x metric (11) boxplot--

# plotting <- function(d, xvar, yvars, xlabs, ylabs){
#   P <- list()
#   for (i in 1:length(yvars)){
#     if(i < length(yvars)){
#       p <- ggplot(d, aes_string(x=xvar, y=yvars[i])) + 
#       geom_boxplot() + labs(y=ylabs[i]) +
#       theme(axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank())
#     }
#     if(i == length(yvars)){
#       p <- ggplot(d, aes_string(x=xvar, y=yvars[i])) + 
#         geom_boxplot() + labs(y=ylabs[i]) +
#         scale_x_discrete(labels = xlabs)
#     }
#     P <- c(P, list(p))
#   }
#   return(list(plots=P, num=length(yvars)))
# }

#trying to align left side of plots--still not working-- finally works!
plotting <- function(d, xvar, yvars, xlabs, ylabs){
  P <- list()
  for (i in 1:length(yvars)){
    if(i < length(yvars)){
      p <- ggplot(d, aes_string(x=xvar, y=yvars[i])) + 
        geom_boxplot() + labs(y=ylabs[i]) +
        theme_Publication() + scale_colour_Publication() + 
        theme(axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank(), plot.margin=unit(c(2,1,2,1),"mm"))
    }
    if(i == length(yvars)){
      p <- ggplot(d, aes_string(x=xvar, y=yvars[i])) + 
        geom_boxplot() + labs(y=ylabs[i]) +
        scale_x_discrete(labels = xlabs) +
        theme_Publication() + scale_colour_Publication()+ 
        theme(plot.margin=unit(c(0,1,2,1),"mm"))
    }
    #gp <- ggplotGrob(p)
    P[[i]] <- p
  }
  #return(list(plots=P, num=length(yvars)))
  gp <- lapply(P, ggplotGrob)
  g <- do.call(rbind, c(gp, size="first"))
  g$widths <- do.call(unit.pmax, lapply(gp, "[[", "widths"))
  return(g)
}

#PLOTS <- plotting(d)
#do.call(grid.arrange, c(PLOTS$plots, nrow = PLOTS$num))

metOM <- plotting(allres, "OM", metrics, OMlabels, metlabels)
grid.newpage()
grid.draw(metOM)

```

<!--
Several performance metrics performed similarly among operating models, and were stable among control rules (Figure \ref{YAY}).    Herring metrics reported relative to reference points were generally less sensitive to operating model than metrics in absolute units (Figure \ref{YAY}).  Consequently, results below focus on herring metrics reported relative to reference points, with the understanding that the operating models differ in meaningful ways (e.g., different *MSY*) if metrics are reported in absolute units.  Dogfish performance metrics were also robust to the operating models and control rules (Figure \ref{YAY}), and were not considered further.  Tuna were affected by variation in herring growth among operating models, but did not vary among control rules (Figure \ref{YAY}), and were also not considered further because herring growth is not within the control of a management strategy (i.e., harvest control rule).   Other than tuna, most metrics were affected by differences in herring *M* and steepness more than herring growth (Figure \ref{YAY}).  The  *Equil1* and *Equil2* metrics are generally consistent with each other, and indicate that a stable long-run equilibrium of net revenue is possible for any operating model  (Figure \ref{YAY}).

## Effect of Harvest Control Rules

```{r ZZZ, fig.cap="Differences between control rule types for key metrics. Boxplots represent the median (wide line within the box) and 25th and 75th percentiles (box) of the distribution of medians for final 50 years of each simulation for each performance metric (x-axis label, please see text for definitions) and control rule type (CR; described in the text Harvest control rules section: biomass based with 1 (BB), 3 (BB3yr), and 5 (BB5yr) quota blocks, biomass based 3 year quota block with a 15\\% restriction on interannual quota change (BB3yrPerc), constant catch (CC), and conditional constant catch(CCC)) across all operating models. Boxplot whiskers include the highest and lowest observations within 1.5 box lengths from the box. Observations further than 1.5 box lengths from the box (outliers) are represented by points.\\label{ZZZ}", fig.height=11, fig.width=8.5, message = FALSE, warning = FALSE}

#note this one is over ALL OM

# metrics <- c(
#              'PropClosure',
#              'MedSSBrelSSBmsy',
#              'PropSSBrelhalfSSBmsy',
#              'YieldrelMSY',
#              'Yvar',
#              'MedPropYrs_goodProd_Targplustern',
#              'stouffer',
#              'p50_NR'
#              )
# 
# metlabels <- c(
#                'closure',
#                'relSSB',
#                'overfished',
#                'relyield',
#                'yieldvar',
#                'ternprod',
#                'equil1',
#                'net revenue'
#                )

metrics <- c('YieldrelMSY',
             'Yvar',
             'PropClosure',
             'MedSSBrelSSBmsy',
             'PropSSBrelhalfSSBmsy',
             'MedPropYrs_goodProd_Targplustern',
             'stouffer',
             'p50_NR'
             )

metlabels <- c('relyield',
               'yieldvar',
               'closure',
               'relSSB',
               'overfished',
               'ternprod',
               'equil1',
               'net revenue'
               )
plotting2 <- function(d, xvar, yvars, ylabs){
  P <- list()
  for (i in 1:length(yvars)){
    if(i < length(yvars)){
      p <- ggplot(d, aes_string(x=xvar, y=yvars[i])) +
        geom_boxplot() + labs(y=ylabs[i]) +
        theme_Publication() + scale_colour_Publication() + 
        theme(axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank(), plot.margin=unit(c(2,1,2,1),"mm"))
    }
    if(i == length(yvars)){
      p <- ggplot(d, aes_string(x=xvar, y=yvars[i])) +
        geom_boxplot() + labs(y=ylabs[i]) +
        theme_Publication() + scale_colour_Publication() + 
        theme(plot.margin=unit(c(0,1,2,1),"mm"))
    }
    #gp <- ggplotGrob(p)
    P[[i]] <- p
  }
  #return(list(plots=P, num=length(yvars)))
  gp <- lapply(P, ggplotGrob)
  g <- do.call(rbind, c(gp, size="first"))
  g$widths <- do.call(unit.pmax, lapply(gp, "[[", "widths"))
  return(g)
}

#PLOTS <- plotting(d)
#do.call(grid.arrange, c(PLOTS$plots, nrow = PLOTS$num))

metCR <- plotting2(allres, "CR", metrics, metlabels)
#do.call(grid.arrange, c(metCR$plots, nrow = metCR$num))
grid.newpage()
grid.draw(metCR)

```
-->
## Predator results summary
```{r predresultsum}
knitr::include_graphics(file.path(image.dir, 'herrtopreds_results.png'))
```

<!--
The constant catch, conditional constant catch, and the biomass based control rule with a 15% restriction, generally had less interannual variation in yield than the other biomass based control rules (Figure \ref{ZZZ}).  This stability, however, came at the cost of foregone yield, with fewer options for those three classes of control rule that could achieve yields near $MSY$ (Figure \ref{ZZZ}).  The constant catch and biomass based control rule with a 15% restriction also had more alternatives that led to poorer tern production than other control rules (Figure \ref{ZZZ}).  The conditional constant catch rule, however, performed well for tern production because the cap of 0.5$F_{MSY}$ on fishing mortality effectively prevented levels of mortality that decreased herring abundance to levels where tern production would be compromised.  Figure \ref{ZZZ} shows that the biomass based control rule with a 15% restriction would often lead to dis-equilibria of Net Revenue and the HCR type responsible for the long right-tails seen in Figure \ref{YAY}.  This finding of a dis-equilibrium is likely occurring because the 15% restriction explicitly introduces memory into the HCR, causing current period Net Revenue to be related to previous period landings.  The dis-equilibrium tests applied to harvest control rules that have 3- or 5- year constant quotas use less data (the 10 or 16 year time periods corresponding to the final 50 years) and therefore have lower statistical power than those applied to the HCRs that are set annually. However, the standard BB3yr and BB5yr HCRs are characterized by equilibrium (Figure \ref{ZZZ}), so we are doubtful that this finding is caused by a statistical power problem.  Ultimately, the NEFMC eliminated the constant catch, conditional constant catch, and biomass based rule with a 15% restriction from consideration because of the foregone yield and/or relatively poor performance of some alternatives for the tern production metric.  

Given that the metrics reported in results below focus on those that were relatively robust to operating models, additional results were only reported for the operating model with low *M*, high steepness, and slow growth ("HighSlowCorrect" in figures). Further, due to Council decisions to eliminate the constant catch, conditional constant catch, and a biomass based rule with a 15% restriction, more detailed tradeoff analyses below focus on the biomass based control rule applied annually ("BB"), or with three ("BB3yr") or five year ("BB5yr") quota blocks.

-->
## Tradeoffs in Remaining Control Rules

```{r yieldSSB,  message = FALSE, warning = FALSE}
#fig.cap="Tradeoff between herring relative yield, fishery and predator metrics for HighSlowCorrect operating model ",and biomass based control rules with 1 year (BB), 3 year (BB3yr), or 5 year (BB5yr) quota blocks. Each point represents the median of 100 medians taken over the final 50 years of each simulation. \\label{yieldSSB}
# pick one OM
HiSlowCorrectOM <- allres %>%
  filter(OM=="LoM_HiSteep_NoAssBias_RecWt")

# pick BB CRs only
HSCOM_BBsonly <- HiSlowCorrectOM %>%
  filter(CR %in% c("BB", "BB3yr", "BB5yr"))

ggplot(HSCOM_BBsonly, aes(x=MedSSBrelSSBmsy, y=YieldrelMSY, colour=CR)) + 
  geom_point(alpha=0.2) + 
  scale_x_continuous(limits = c(0,3.5)) + 
  #geom_hline(yintercept=1) + 
  labs(y="relative yield", x="SSB/SSBmsy", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

```

---

```{r yieldclose, message = FALSE, warning = FALSE}
#, fig.show='hold', out.width='0.49\\linewidth'
#fig.cap="Tradeoff between herring relative yield and frequency of fishery closure for HighSlowCorrect operating model and biomass based control rules with 1 year (BB), 3 year (BB3yr), or 5 year (BB5yr) quota blocks. Each point represents the median of 100 medians taken over the final 50 years of each simulation.\\label{yieldPropClosure}"
# pick one OM
#HiSlowCorrectOM <- allres %>%
#  filter(OM=="LoM_HiSteep_NoAssBias_RecWt")

# pick BB CRs only
#HSCOM_BBsonly <- HiSlowCorrectOM %>%
#  filter(CR %in% c("BB", "BB3yr", "BB5yr"))

ggplot(HSCOM_BBsonly, aes(x=PropClosure, y=YieldrelMSY, colour=CR)) + 
  geom_point(alpha=0.2) + 
  scale_x_continuous(limits = c(0,1)) + 
  #geom_hline(yintercept=1) + 
  labs(y="relative yield", x="frequency of closure", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

```

---

```{r yieldOF,  message = FALSE, warning = FALSE}
#, fig.show='hold', out.width='0.49\\linewidth'
#fig.cap="Tradeoff between herring relative yield and probability of the stock is overfished for HighSlowCorrect operating model and biomass based control rules with 1 year (BB), 3 year (BB3yr), or 5 year (BB5yr) quota blocks. Each point represents the median of 100 medians taken over the final 50 years of each simulation.\\label{yieldProbOF}",
# pick one OM
#HiSlowCorrectOM <- allres %>%
#  filter(OM=="LoM_HiSteep_NoAssBias_RecWt")

# pick BB CRs only
#HSCOM_BBsonly <- HiSlowCorrectOM %>%
#  filter(CR %in% c("BB", "BB3yr", "BB5yr"))

ggplot(HSCOM_BBsonly, aes(x=PropSSBrelhalfSSBmsy, y=YieldrelMSY, colour=CR)) + 
  geom_point(alpha=0.2) + 
  scale_x_continuous(limits = c(0,1)) + 
  #geom_hline(yintercept=1) + 
  labs(y="relative yield", x="frequency of overfished", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

```

---

```{r yieldbirds, message = FALSE, warning = FALSE}
# fig.show='hold', out.width='0.49\\linewidth'
# fig.cap="Tradeoff between herring relative yield and probability of good tern productivity for HighSlowCorrect operating model and biomass based control rules with 1 year (BB), 3 year (BB3yr), or 5 year (BB5yr) quota blocks. Each point represents the median of 100 medianstaken over the final 50 years of each simulation.\\label{yieldbirds}",
# pick one OM
#HiSlowCorrectOM <- allres %>%
#  filter(OM=="LoM_HiSteep_NoAssBias_RecWt")

# pick BB CRs only
#HSCOM_BBsonly <- HiSlowCorrectOM %>%
#  filter(CR %in% c("BB", "BB3yr", "BB5yr"))

ggplot(HSCOM_BBsonly, aes(x=MedPropYrs_goodProd_Targplustern, y=YieldrelMSY, colour=CR)) + 
  geom_point(alpha=0.2) + 
  scale_x_continuous(limits = c(0,1)) + 
  #geom_hline(yintercept=1) + 
  labs(y="relative yield", x="frequency of good tern productivity", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

```

<!--
At similar levels of yield, using three or five year blocks for the biomass based control rule produced more control rule shapes with less $SSB$, such that the short-term stability of such quota blocks comes at the potential cost of less $SSB$ (Figure \ref{yieldSSB}).  All three biomass based variants had alternatives that could achieve yield near $MSY$ over a range of $SSB$ levels.

At similar levels of yield, the application of quota blocks resulted in lower extreme highs in $IAV$ (Figure \ref{yieldIAV}).  The application of quota blocks also reduced the number of alternatives near $MSY$, further illustrating the tradeoff between stability and yield.

All three biomass based alternatives could achieve >90%$MSY$ with nearly zero fishery closures, although the number of alternatives was fewer with longer quota blocks (Figure \ref{yieldPropClosure}).  While the tradeoffs were generally similar between $\frac{yield}{MSY}$ and the frequency that *Q*=0 for all three alternatives, vertical patterning becomes evident with longer quota blocks.  This patterning was caused by biomass based control rule shapes becoming more alike with longer quota blocks, with their performance dominated more by the length of fishery closures dictated by the quota block length than by the specific shape of the control rule.  As an extreme example, if a 50 year quota block was applied, any control rule that would close the fishery early in the time series would have a nearly identical frequency of *Q*=0 near 100%, but these same control rules would behave much differently with shorter quota blocks where the responsiveness of the specific control rules would drive results.

All of the control rule alternatives offered options that had near zero frequency of $SSB < \frac{SSB_{MSY}}{2}$ (Figure \ref{yieldProbOF}).  At similar levels of yield, using three or five year blocks for the biomass based control rule produced more control rule shapes with higher frequency of $SSB < \frac{SSB_{MSY}}{2}$, such that the short-term stability of such quota blocks comes at the potential cost of more frequently dropping to relatively low levels of biomass.

All of the control rule alternatives offered options that had high frequency of good tern productivity (equal to or greater than the management target of 1.0; Figure \ref{yieldbirds}). At similar levels of yield, using three or five year blocks for the biomass based control rule produced more control rule shapes with slightly lower frequency of good tern producivity, however, the difference is between >80% and >90% frequency of good productivity. 

The control rule alternatives resulted in good stability characteristics across a range of net revenues for the fishery (Figure \ref{revenuestability}). We have included results from the biomass based control rule with a 15% restriction on interannual variation in the quota to illustrate the relatively poor performance of this control rule type.
-->
## What control rules give us 90% of everything?

- Tern productivity at 1.0 or above more than 90% of the time
- Herring biomass more than 90% of SSBmsy
- Fishery yield more than 90% of MSY
&nbsp;  
&nbsp;  
- Fishery closures (F=0) less than 1% of the time (second plot).

---

```{r}
Nrulesgoodterns <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(MedPropYrs_goodProd_Targplustern>0.9) %>%
  summarize(tern90 = n())

Nrulesgoodfishery <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(YieldrelMSY>0.9) %>%
  summarize(yield90 = n())

Nrulesgoodherring <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(MedSSBrelSSBmsy>0.9) %>%
  summarize(SSB90 = n())

Nrulesgoodternherrfish <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  filter(MedPropYrs_goodProd_Targplustern>0.9 & MedSSBrelSSBmsy>0.9 & YieldrelMSY>0.9) %>%
  group_by(OM,CR)%>%
  summarize(ternfishherr90 = n(), 
            minF = min(FracFtarg), 
            maxF = max(FracFtarg),
            minloB = min(FracBmsyThreshLo), 
            maxloB = max(FracBmsyThreshLo),
            minhiB = min(FracBmsyThreshHi),
            maxhiB = max(FracBmsyThreshHi)
  )

CRsgoodternherrfish <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  filter(MedPropYrs_goodProd_Targplustern > 0.9 & MedSSBrelSSBmsy > 0.9 & YieldrelMSY > 0.9) %>%
  group_by(OM,CR) %>%
  select(OM, CR, FracBmsyThreshLo, FracBmsyThreshHi,FracFtarg) %>%
  mutate(id = seq(1:n()),
         Xmin = 0,
         Xmax = 4) %>%
  gather(CRpart, x, Xmin,FracBmsyThreshLo, FracBmsyThreshHi,Xmax) %>%
  arrange(OM, CR, id) %>%
  mutate(y = case_when(CRpart == "Xmin" | CRpart == "FracBmsyThreshLo" ~ 0,
                       CRpart == "FracBmsyThreshHi" | CRpart == "Xmax" ~ FracFtarg)) %>%
  mutate(bigkey = paste0(OM, CR, id))
  
#with(CRsgoodternherrfish, 
#     plot(x=c(0,FracBmsyThreshLo, FracBmsyThreshHi, 4),
#          y=c(0,0,FracFtarg, FracFtarg), type="l"))  
  
p1 <- ggplot(CRsgoodternherrfish, aes(x=x, y=y, colour=CR)) + 
  geom_line(aes(group=bigkey), alpha=0.3) +
  labs(y="F/Fmsy", x="SSB/SSBmsy", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

OMlabels <- c(HiM_LowSteep_AssBias_OldWt = 'LowFastBiased', 
              HiM_LowSteep_AssBias_RecWt = 'LowSlowBiased', 
              HiM_LowSteep_NoAssBias_OldWt = 'LowFastCorrect', 
              HiM_LowSteep_NoAssBias_RecWt = 'LowSlowCorrect',  
              LoM_HiSteep_AssBias_OldWt =  'HighFastBiased',  
              LoM_HiSteep_AssBias_RecWt = 'HighSlowBiased', 
              LoM_HiSteep_NoAssBias_OldWt = 'HighFastCorrect',
              LoM_HiSteep_NoAssBias_RecWt = 'HighSlowCorrect'
              )

p1 + facet_wrap("OM", labeller=labeller(OM = OMlabels), nrow=2) + theme(legend.position="bottom")

```

---

```{r}
Nrulesgoodterns <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(MedPropYrs_goodProd_Targplustern>0.9) %>%
  summarize(tern90 = n())

Nrulesgoodfishery <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(YieldrelMSY>0.9) %>%
  summarize(yield90 = n())

Nrulesgoodherring <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(MedSSBrelSSBmsy>0.9) %>%
  summarize(SSB90 = n())

Nrulesgoodternherrfish <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  filter(MedPropYrs_goodProd_Targplustern>0.9 & MedSSBrelSSBmsy>0.9 & YieldrelMSY>0.9 & PropClosure < 0.01) %>%
  group_by(OM,CR)%>%
  summarize(ternfishherr90 = n(), 
            minF = min(FracFtarg), 
            maxF = max(FracFtarg),
            minloB = min(FracBmsyThreshLo), 
            maxloB = max(FracBmsyThreshLo),
            minhiB = min(FracBmsyThreshHi),
            maxhiB = max(FracBmsyThreshHi)
  )

CRsgoodternherrfish <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  filter(MedPropYrs_goodProd_Targplustern > 0.9 & MedSSBrelSSBmsy > 0.9 & YieldrelMSY > 0.9 & PropClosure < 0.01) %>%
  group_by(OM,CR) %>%
  select(OM, CR, FracBmsyThreshLo, FracBmsyThreshHi,FracFtarg) %>%
  mutate(id = seq(1:n()),
         Xmin = 0,
         Xmax = 4) %>%
  gather(CRpart, x, Xmin,FracBmsyThreshLo, FracBmsyThreshHi,Xmax) %>%
  arrange(OM, CR, id) %>%
  mutate(y = case_when(CRpart == "Xmin" | CRpart == "FracBmsyThreshLo" ~ 0,
                       CRpart == "FracBmsyThreshHi" | CRpart == "Xmax" ~ FracFtarg)) %>%
  mutate(bigkey = paste0(OM, CR, id))
  
#with(CRsgoodternherrfish, 
#     plot(x=c(0,FracBmsyThreshLo, FracBmsyThreshHi, 4),
#          y=c(0,0,FracFtarg, FracFtarg), type="l"))  
  
p1 <- ggplot(CRsgoodternherrfish, aes(x=x, y=y, colour=CR)) + 
  geom_line(aes(group=bigkey), alpha=0.3) +
  labs(y="F/Fmsy", x="SSB/SSBmsy", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

OMlabels <- c(HiM_LowSteep_AssBias_OldWt = 'LowFastBiased', 
              HiM_LowSteep_AssBias_RecWt = 'LowSlowBiased', 
              HiM_LowSteep_NoAssBias_OldWt = 'LowFastCorrect', 
              HiM_LowSteep_NoAssBias_RecWt = 'LowSlowCorrect',  
              LoM_HiSteep_AssBias_OldWt =  'HighFastBiased',  
              LoM_HiSteep_AssBias_RecWt = 'HighSlowBiased', 
              LoM_HiSteep_NoAssBias_OldWt = 'HighFastCorrect',
              LoM_HiSteep_NoAssBias_RecWt = 'HighSlowCorrect'
              )

p1 + facet_wrap("OM", labeller=labeller(OM = OMlabels), nrow=2) + theme(legend.position="bottom")

```

<!--
# Discussion

Results were generally robust among operating models when presented relative to biological reference points (e.g., $\frac{yield}{MSY}$), but absolute scale differed among operating models.  This result has been previously reported [@Deroba2012Evaluating] and is likely why the results of most MSEs are presented in relative units [@Amar2009TheFishery; @Deroba2012Evaluating; @Wiedenmann2017].  While convenient scientifically, the differences in absolute scale can create challenges when communicating with stakeholders because most people are more comfortable with absolute units (e.g., fishing industry representatives think in tons and not fractions of $MSY$; @Feeney2018blending). Thus, reporting results in absolute units will still have value in public settings, and scientists should attempt to convey the reasons for differences in scale among operating models [@Feeney2018blending].

The constant catch, conditional constant catch, and restricting annual changes in the quota by 15% produced less variable yield than the other biomass based alternatives, but at the expense of yield, more frequent low levels of herring biomass, and more outcomes relatively detrimental to predators. This result is consistent with previous simulations of similar harvest control rules for lake whitefish (*Coregonus clupeaformis*) in the Laurentian Great Lakes [@Deroba2012Evaluating] and a roundfish stock managed by the International Council for the Exploration of the Sea [@Kell2006]. For lake whitefish; @Deroba2012Evaluating found that a conditional constant catch rule could achieve similar stability in yield as a 15% restriction on the interannual change to a quota applied to a biomass based control rule, but with higher yields.  A broader range of percent restrictions on the interannual variation in the quota could be evaluated, however, before assuming that these conclusions are general.  A 15% restriction was used in this analysis because that amount was specifed as desirable by stakeholders.  Conceivably, a different percentage may strike a more agreeable tradeoff between stability and other metrics of interest.  The performance of restraints on the interannual variation in quotas also depends on stock status and variation in life history traits, such as growth [@punt2002evaluation ; @Kell2006], and so should likely be evaluated on a case by case basis.

If short-term stability in yield is a fishery objective, then using quota blocks where the target harvest is the same for multiple years may be an effective method that costs little in the performance of other metrics.  The biomass based options with three or five year quota blocks produced similar ranges of performance and similar tradeoffs as annual changes in the quota. Thus, short-term stability could be gained at little long-term cost with appropriately selected harvest policy parameters.  Although, at similar level of yields, the quota block alternatives produced more options with lower biomass.  Thus, a closed-loop simulation could be used to evaluate the changes in relative performance between applying a control rule annually or using multi-year specifications.  In a simulation of lake whitefish, @li2016influence  found that the method of specifying target harvests between stock assessments was less important to relative performance than assessment frequency.  Furthermore, setting target harvest to the same value for multiple years between assessments, as in the quota blocks used here, performed similarly to using projections in the interim years. 

Nearly every stakeholder group proposed metrics that measured the health of the herring stock.  The herring biomass performance metric could capture passive (non-use) value associated with herring biomass.  It may also be related to active use values if higher herring biomass improves ecotourism, recreational, or commercial fishery outcomes.  Finally, a herring biomass performance metric may be a proxy for unmodeled recreational, ecotourism, or socio-economic components of the ecosystem that are believed to be positively associated with herring biomass. 

The simulation model used in this MSE can be thought of as a model of intermediate complexity [@plaganyi_multispecies_2014]. Future MSE models that are designed to address the role of herring as forage in the ecosystem should graduate to advanced complexity.  These advances should include more realistic models of the scientific process, herring stocks, predator-prey relationships, human behavior, and ecosystem valuation methods. However, linking the appropriate components to derive the desired set of performance metrics for management decision making need not be an insurmountable challenge. For example, fairly simple methods were used to link environmental drivers, prey and predator species, and detailed social and economic components of fisheries in the Gulf of Alaska [@zador2017linking]. The expert opinion of stakeholders involved in the MSE can be used to specify similar conceptual models in New England. In future iterations of the MSE, conceptual and qualitative modeling might be used to map out where critical data and further integrated model development would most efficiently address priority management needs.

## The Dream
In this section, we discuss the limitations of the models and simplifications necessary to meet decision-making time frames while incorporating ecosystem and economic models into management strategy evaluation.  

### Herring Dreams

The application of the biomass based and conditional constant catch control rules assumed $MSY$ reference points were known without error, as in several other studies [@irwin2008evaluating; @punt2008evaluation].  In reality, such reference points are likely to be uncertain in most cases and the bias and precision of reference point estimates depend on life hisory traits and autocorrelation in recruitment [@haltuch2008evaluating; @haltuch2009evaluating].  How the relative performance of control rules would change in the presence of error in reference points is unclear and should be a topic for future research.  Given that assessment error affects relative control rule performance [@Deroba2008], errors in reference point estimation may compound those issues and affect results in meaningful ways.  Incorporating realistic errors in reference point estimation, however, will be challenging because the effects will depend on exploitation history and the degree to which life history traits vary among years [@brodziak2008goals; @legault2015direction].  This MSE evaluated uncertainty in life history traits, but not time variation in those traits.  Methods for estimating reference points and the proper response of management in the presence of time varying life history traits is an active area of research and has been a focal point of MSEs [@Amar2009TheFishery; @legault2015direction].  For example, increases in natural mortality through time have different implications on reference points depending on whether a per recruit approach is used or if managment is concerned with limiting total mortality, where a per recruit approach would increase target $F$ but limiting total mortality would require decreasing target $F$  [@legault2015direction].  A MSE for Gulf of Alaska walleye pollock (*Gadus chalcogramma*) demonstrated that management strategies (i.e., the combination of harvest control rule and estimation model) performed differently depending on how reference points were estimated in the presence of regime shifts in recruitment, with estimates of unfished biomass depending on the range of years used to estimate average recruitment [@Amar2009TheFishery].  Atlantic herring have experienced time varying growth, and the possibility of time varying natural mortality has been considered an uncertainty in recent stock assessments [@NEFSC2012Assessment ; @Deroba2015atlantic].  Thus, evaluating the effect of errors in reference point estimation would be a prudent advancement of the MSE.  The stakeholder driven process, however, was already overwhelming for many participants given the time frame, and so adding this additional realism would likely be best completed as a separate exercise that would rely moreso on technical experts than stakeholder input.

This herring MSE did not incorporate a true stock assessment as part of the management strategy.  The approach taken offered the advanatage of simplicity, brevity, and the ability to control bias in the assessment without having to specify a source of the bias (e.g., misspecified $M$, incorrect selectivity), as would be required with the incorporation of a true stock assessment. This MSE also took advantage of pre-existing and quality checked code that helped meet the decision-making time frames.  Amending this code to include a true stock assessment likely would have precluded attaining the deadlines. Conceivably, however, relative control rule performance could vary depending on the misspecification that induces a bias in a true stock assessment model, and so several alternative sources of bias would likely have to be evaluated as part of a MSE, significantly increasing computing time in an already demanding time frame.  Given the technical nature of stock assessments, constructing an evaluation of the effect of different sources of bias in a stock assessment also could likely be conducted outside of a stakeholder process.  Nonetheless, incorporating a true stock assessment is considered best practice and may induce realism, such as levels of autocorrelation among assessment fits, that cannot be reproduced otherwise [@cox2008practical;@punt_management_2016].  Consequently, this MSE could suggest alternative management decisions as such additional realism is implemented.

### Predator Dreams

As has been found in other MSE analyses [@punt_management_2016], the predator results may be more useful for eliminating poor control rule options (BB3yrPerc, CC) than for optimizing herring control rules to improve predator metrics. There are several reasons for this. Predator populations are affected by many factors, while we attempted to isolate factors associated with prey dynamics. Further, in the Northeast US, predators have many prey options [@link_does_2002], while we attempted to evaluate relationships with just one prey, herring. Finally, time limitation necessitated simple, tractable models of complex ecological relationships. Our approach was to use the best-supported relationship for each predator based on observations from the Northeast US ecosystem. We discuss the pros and cons of this approach for each predator below.

Western Atlantic bluefin tuna migrate widely and forage throughout North Atlantic; their population footprint is much larger than that of Northeast US Atlantic herring. However, tuna feed seasonally in the Gulf of Maine, exploiting concentrated, high-energy prey to maximize growth [@golet_changes_2013]. Because tuna growth is key in the Northeast US, and because there is a well-supported relationship between herring weight and tuna growth [@golet_paradox_2015], we used this relationship. Other relationships were also investigated. Available data do not suggest a positive relationship between herring and tuna populations in our models for this MSE; Northeast US shelf herring have increased during a period of bluefin tuna decline [@NEFSC2012Assessment; @iccat_report_2015]. Stakeholder observations and fine-scale analyses [e.g., @golet_changes_2013] suggest that bluefin tuna follow herring in the Gulf of Maine and likely aggregate around herring while feeding. However, our models designed to address ABC control rules at the Northeast US shelf scale do not address herring/tuna interactions in a specific place or time, and we can draw no conclusions from our modeling about predator/prey co-occurrence or availability at smaller, local scales. Similarly, without additional observations, extrapolating local scale co-occurrence to population level relationships is not well supported. Future iterations of the MSE would require finer scale data on predators, prey, and fisheries for both to address these questions. 

Common terns, in contrast, are central-placed foragers seasonally near their island breeding colonies in the Gulf of Maine [@nisbet_common_2002]. Their foraging footprint during chick production season is much smaller than the scale of the Northeast US Atlantic herring population. Because tern productivity is a key management objective for tern colonies in the Gulf of Maine, we used the substantial existing data to explore a relationship between herring populations and tern reproductive success. However, many factors other than herring abundance affect tern production. According to Gulf of Maine Seabird Working Group minutes and other work, predation by mammals, gulls, and other birds is a major factor that most colony management aims to control [@donehower_effects_2007 ; @scopel_lauren_case_2017]. Further, timing of weather events and prey availability is important for production, but difficult to quantify at all colonies from current data [@scopel_predation_2017]. Similarly, the relatively small spatial scale and depth distribution of prey affects tern foraging success as well as the overall abundance of prey [@scopel_seabird_2017]. At one colony during the same year, the proporiton of herring in tern chick diets was much lower than the proportion of herring in razorbill (*Alca torda*) diets at the same colony; razorbills are capable of deeper dives than terns (GOMSWG minutes). Spatial variability of predation, weather, and prey distribution may drive the high variation in observed herring population-tern productivity relationship among colonies, similar to observations in other ecosystems [@sydeman_climateecosystem_2015]. This high variance in the observations is not considered by the modeled herring-tern relationship. Further, the tern model is optimistic about population trajectory because it considers only herring total biomass effects on terns, and does not model predation, habitat quantity and quality, etc. In future iterations of the MSE, a better match of spatial scale for fishery removals and seabird foraging (similar to tunas above) could better investigate management options that are not easily addressed with a stock-scale annual harvest control rule [@sydeman_best_2017]. 

Spiny dogfish may have the best spatial footprint match with Atlantic herring in the Northeast US of the three predators modeled. Dogfish forage through the same range as herring for most of the year. Considerable information on dogfish diet has been collected over time in the region, and there are adequate data to conduct a stock assessment. However, the dogfish relationship assumes herring abundance improves dogfish survival because no clear relationship was found with recruitment or growth. Increased survival may not be the mechanism for the observed positive influence of herring in diet on the dogfish population.

Our approach allowed “bottom up” effects of herring on predators to be examined, which was the key management question. Although we selected predators with high herring diet proportions, observed predator population responses to herring alone do not dominate dynamics, and our herring-predator relationship models reflect that. Predator responses to aggregate prey dynamics may be much clearer than responses to individual prey in the Northeast US ecosystem given its food web structure with many alternative prey [@link_does_2002]. Further, food web modeling explored here and in other studies suggested that “top down” effects of predators on herring, simultaneous interactions of multiple predators with herring, and side effects on other forage species could be important in this ecosystem [@link_northeast_2008; @link_response_2009; @link_documentation_2006]. While modeling multispecies interactions is a more complex and time-consuming undertaking, the results may give clearer advice for managers making decisions regarding multiple simultaneously exploited prey and predators within the ecosystem [@dewitt_multiple_2003; @lovvorn_niche_2013].

Here, the general objective for the Council was to answer "how do changes in herring population abundance affect predator populations?" This is a different and more complex question than that addressed in the 2012 herring assessment "how much herring is consumed by predators?" Our MICE models were designed specifically for evaluating alternative herring control rules, not predator stock assessment and population prediction. Council specifications and time constraints did not permit development of integrated multispecies models addressing both "bottom up" herring impacts on predators and predation mortality on herring, nor spatial or seasonal models accounting for migrations of wide-ranging predators into or out of the Northeast US shelf ecosystem. Existing multispecies models in the region only account for predation mortality on herring [@curti_evaluating_2013; @gaichas_combining_2017]. A MICE approach could be taken using these models as a starting point to incorporate key multispecies feedbacks and even broadly spatial interactions in future iterations of the MSE, as was done for the California Current [@punt_exploring_2016]. 

We caution against generalizing results for these particular predators to other predators, as population parameters and herring relationships differ. Although considerable work has been done examining forage fish fishing in many ecosystems [@cury_global_2011; @essington_fishing_2015; @hilborn_when_2017], and it can be tempting to generalize control rules specific to forage fish across all ecosystems [@pikitch_lenfest_2012], our results demonstrated that many potential control rules for Northeast US herring gave equally good results for the modeled herring predators. While we do not suggest that relationships we found here will hold for predators and prey in other ecosystems, we wholeheartedly recommend the use of ecosystem-specific data to evaluate forage fish harvest control rules and tradeoffs between objectives on a case-by-case basis. 

### Economic Dreams
The economic model of the herring fishery did not include fixed costs. If firms do not enter or exit, then the exclusion of fixed costs from the model has minimal effect when comparing HCRs within or across OMs.  Net revenues would all be overestimated by the same fixed amount.  The stationarity metric would be unaffected; however, IAV constructed without fixed costs will be smaller than the true IAV that contains fixed costs.  In reality, firms can enter and exit this industry.  Economic theory suggests that firms will enter (exit) if they anticipate large positive (negative) profits over a particular planning horizon. While herring is a limited-access fishery, less than three-quarters of the permits vessels are active, suggesting that firms could enter.  Understanding exactly how these entry and exit decisions are made was not possible on the timeline requested by NEFMC.

We also assume that marginal costs are equal to average variable costs, constant for each fleet, and do not depend on the level of biomass. A more rigorous approach might include estimating a (economic) production function for the herring fishery; this was not done in the interest of time.  It is difficult to predict how estimating a true cost function and integrating those results would change the results of the study.  

Catch in the economic model can be different from both quota and yield (from the herring model). This is frequently handled as symmetric implementation error in the fisheries literature (as it is in this model). However, the economic model suggests that either an assymetric error term, in which the error depends on prices of inputs and outputs, or a more integrated biological and economic model is warranted. 

Consumer welfare measures could be determined from a demand curve for herring.  Equation \ref{ARDL} estimates a price-quantity relationship, which is not necessarily a demand curve for herring.  Rigorous estimation of a demand curve for herring requires modeling all goods that are substitutes for herring, including mackerel, menhaden, squid, and other substitute baits. This was not done due to limited time available.  @Kirkley2011AConsiderations use a static input-output model to simulate the effects of changes in herring quotas and predator biomass levels on the New England economy. Because the @Kirkley2011AConsiderations analysis suggested that the effects of changes in herring catch on other segments of the economy are quite small, economic analysis  was confined to the herring fleet.

Economic methods that can inform ecosystem approaches to fisheries management include portfolio methods [@Edwards2004PortfolioStocks; @Jin2016ApplyingEBFM], coupled ecosystem-region models [@Jin2003LinkingEcosystem;  @Jin2012DevelopmentEngland; @Kirkley2011AConsiderations], and bioeconomic models [@Tschirhart2000GeneralEcosystem; @Finnoff2003HarvestingEcosystem; @Brown2005AFisheries;@Lehuta2013InvestigatingEngland] of varying complexity.  However, there was simply not enough time to employ these methods, nor to link economic outcomes to sociocultural outcomes [@zador2017linking].  The largest limitation of the economic model is that only the herring fishery is quantitatively modeled. Humans who indirectly use \textit{in-situ} herring were not formally modeled.  

The predator section models a few representative consumers of live herring: terns, tuna, whales, and predatory fish. Ecosystem valuation methods could be used to measure changes in outcomes for those species in dollar value [@loomis1996economic; @richardson2009total; @lew2015willingness].  People may derive value from changes in the status of these predators through either use or non-use values.  For example, people may directly value higher abundances of an animal or protection of an endangered species, even if they have no plans to watch or view them [@lew2010valuing; @lew2017temporal].  Quantifying these values typically is done using stated preference methods with data collected using surveys; these studies are costly and time consuming to develop and conduct rigorously. Benefit transfer, a method in which valuation from previous studies is applied to a new study area, may be a way to overcome these barriers [@navrud2007environmental; @johnston2010methods].

Stakeholders may also derive use value from changes in the modeled species.  Changes in herring biomass may change costs, catches, or prices in the commercial fishery for a predator.  For example, increases in biomass of spiny dogfish could lead to both higher quotas and lower costs to catch more abundant fish.  Examining changes in costs would require an economic model of production for the spiny dogfish fishery (similar to the model not used for the herring fleet) [@holland1999empirical; @hutniczak2014increasing; @reimer2017fisheries]. Changes in product quality could affect prices [@Larkin1999IntrinsicFishery; @Asche2015EconomicFisheries].  For example, because larger tuna receive higher prices, the effects of changes in average weight could be deduced from existing hedonic models [@McConnell2000HedonicHawaii; @Carroll2001PricingManagement].

These changes are not confined to an extractive sector of the economy.  For example, changes in whale populations may change outcomes for whale-watching customers.  This type of value could be quantified using both stated and revealed preference data, both of which typically require collection of survey data [@Larson2004RevealingData]. These studies are often quite costly and time consuming to develop and conduct rigorously.  Perhaps more discouragingly, the precise good being valued needs to be known quite early in the research process.  In this application, development of a valuation survey for terns would not have been able to begin until after the predator modeling was nearly complete. Benefit transfer may be the only way to value some of the use values on the timeframe required by NEFMC.

Note that increases in the biomass of a particular predator could be a net ``bad''  for society.  For example, an increase in the biomass of a predator that is low-valued but skilled at consuming herring could result in disproportionate increases in that low-valued predator. If that low-valued predator is not a complete specialist (in consuming herring), it may also drive down the biomass of high-valued predators.  The ability to manipulate the ecosystem with a prey-level ABC control rule to achieve desirable outcomes depends on the rates at which these increases in prey are converted into social utility. This conversion depends on the ecosystem technology (conversion of prey into additional biomass of high- and low-valued predators), human technology (conversion of prey and predator biomass into catch or tourism), and human preferences (converting catch or tourism into utility). Despite our current efforts, many of these relationships are not particularly well understood at this time.

In order to meet management timelines, the herring, predator, and economic models were developed in parallel, and not in sequence.  This required an educated guess about which predators and predator outcomes were sensitive to the range of HCRs.  For example, prior to completing the predator models, we did not anticipate that tuna weight would be sensitive to various operating models (i.e., fast and slow herring growth) but not the harvest control rules.  Developing the herring, predator, and economic models sequentially could have allowed for a model of the tuna fishery that accounts for the size-dependent prices [@Carroll2001PricingManagement].  In contrast, devoting scarce research time to examine the costs of harvesting tuna would not have resulted in performance measures that would help managers select among control rules because changes in herring abundance had relatively little effect on tuna.
-->
## Acknowledgements 
We thank our New England Fishery Management Council collaborators Rachel G. Feeney and Deirdre Boelke, our collaborator and lead facilitator Brian J. Irwin, and the more than 80 individuals from the fishing industry, federal and state agencies, academia, environmental organizations, and other entities who gave their time to contribute to the workshops. Madeleine Hall-Arber, Jessica Joyce, Laura Singer, and Tiffany Vidal provided excellent workshop facilitation. Beth Goettel, Linda Welch, and Aly McKnight contributed seabird data and expertise. This work benefitted from the peer review panel: Lisa Kerr (Chair), Gavin Fay, Douglas Lipton, and John Wiedenmann. Statements herein should neither be considered formal positions of the NEFMC, NMFS, nor a consensus of the participants.  Any use of trade, firm, or product names is for descriptive purposes only and does not imply endorsement by the U.S. Government.


## P.S. The clearest tradeoff

```{r yieldIAV,  message = FALSE, warning = FALSE}
#fig.cap="Tradeoff between herring relative yield and variation in yield for HighSlowCorrect operating model and biomass based control rules with 1 year (BB), 3 year (BB3yr), or 5 year (BB5yr) quota blocks. Each point represents the median of 100 medians taken over the final 50 years of each simulation.\\label{yieldIAV}",
# pick one OM
#HiSlowCorrectOM <- allres %>%
#  filter(OM=="LoM_HiSteep_NoAssBias_RecWt")

# pick BB CRs only
#HSCOM_BBsonly <- HiSlowCorrectOM %>%
#  filter(CR %in% c("BB", "BB3yr", "BB5yr"))

ggplot(HSCOM_BBsonly, aes(x=Yvar, y=YieldrelMSY, colour=CR)) + 
  geom_point(alpha=0.2) + 
  scale_x_continuous(limits = c(0,3.5)) + 
  #geom_hline(yintercept=1) + 
  labs(y="relative yield", x="variation in yield", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

```

