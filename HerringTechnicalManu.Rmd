---
title: 'The dream and the reality: meeting decision-making time frames while incorporating
  ecosystem and economic models into management strategy evaluation'
author: Jonathan Deroba, Sarah Gaichas, Min-Yang Lee, Rachel G. Feeney, Deirdre Boelke,
  Brian J. Irwin
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl
output:
  pdf_document:
    includes:
      in_header: preamble-latex.tex
    keep_tex: yes
    pandoc_args: --latex-engine=xelatex
  html_document: null
  word_document: null
bibliography: HerringMSE.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align='center')
library(ggplot2)
library(tidyr)
library(dplyr)
library(broom)
library(knitr)

data.dir <- './data'

#The sg_figs option can be set to FALSE to skip making SG's figures on the fly. Or TRUE to make them. 
sg_figs <- TRUE

if(sg_figs){
  ternpopproddiet <- read.csv(file.path(data.dir,"GOMTernPopsProdDiet_Corrected.csv"))
  preyB <- read.table(file.path(data.dir,"Unadj1111TotBioSimYear.txt"), header=T)  
  preysim <- read.table(file.path(data.dir,"Unadj1111NAASimYear.txt"), header=T)
  preychar <- read.table(file.path(data.dir,"Unadj1111SimCharAA.txt"), header=T)
  herring <- read.csv(file.path(data.dir,"herringassessout2015.csv"))
  dogdiet   <- read.csv(file.path(data.dir,"dogfishdietcomp.csv"))
  GBcoddiet <- read.csv(file.path(data.dir,"GBcoddietcomp.csv"))
  GOMcoddiet <- read.csv(file.path(data.dir,"GOMcoddietcomp.csv"))
  codGB <- read.csv(file.path(data.dir,"GBcodpop.csv"))
  codGOM <- read.csv(file.path(data.dir,"GOMcodpop.csv"))
  dogfish <- read.csv(file.path(data.dir,"dogfishpop.csv"))
  gfishdiet <- read.csv(file.path(data.dir,"Gfishdiets.csv"))
  dogfishrec <- read.csv(file.path(data.dir,"dogfishrec.csv"))
}

allres <- readRDS(file.path(data.dir,"allres.rds"))


#to get table captions and numbering
tn = local({
  i = 0
  function(x) {
    i <<- i + 1
    #paste('\n\n:Table ', i, ': ', x, sep = '')
    paste('\n\n:', x, sep = '')
    # The : before Table tells pandoc to wrap your caption in <caption></caption>
  }
})
knit_hooks$set(tab.cap = function(before, options, envir) {
  if(!before)
    tn(options$tab.cap)
})
default_output_hook = knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  if (is.null(options$tab.cap) == F)  
    x
  else
    default_output_hook(x,options)
})


```
\doublespacing

#Introduction

Atlantic herring (hereafter herring) *Clupea harengus* in the Northwest Atlantic are preyed upon by fish, seabirds, and marine mammals, and can account for 20-50% of the diet of these predators (Overholtz and Link 2007; Smith and Link 2010; Curti et al., 2013). Herring are also subject to a directed fishery, mostly using midwater trawls, purse seines, and bottom trawls, that averaged 85,000mt of landings during 2008-2017. Much of the landings are also used as bait in the relatively high value American lobster Homarus americanus fishery. Herring life-history traits (e.g., weight-at-age) have also varied through time and have a complex stock strucutre that creates uncertainty in their assessment and management. Thus, herring are of broad interest in the region, but anticipating the relative performance of mangement strategies (e.g., harvest control rules) in the face of uncertainties is challenging, which makes a management strategy evaluation (MSE) for herring in the region a potentially informative tool.

Management strategy evaluation uses simulation to evaluate the trade-offs resulting from alternative management options in the face of uncertainty [@punt2016management]. MSEs require time, however, for stakeholder input, data collection, and model development [@butterworth2007management] (Punt et al., 2014). As such, the process can take much longer than "traditional" management time frames [@butterworth2007management]. The development time is also likely to lengthen when explicit ecosystem, multi-species, or socioeconomic considerations are desired because the data and modeling needs, and subsequent uncertainties, are all greater than in a single species approach. This manuscript chronicles the development of an MSE done on a truncated timetable (~12 months) required to meet management time frames. The objectives of this manuscript were to:

1. Evaluate the relative performance of HCRs at meeting herring fishery objectives, including those related to predators of herring, as informed by stakeholder input, and,

2. Discuss our approach to developing an MSE on a relatively truncated timetable in order to meet management time frames, and identify the lessons learned throughout the process, especially as they relate to using MSE as a tool to advance an ecosystem based approach to management [@plaganyi2014multispecies].

The fisheries management process in New England usually starts when managers percieve a problem causing a management goal or objective to be unmet. Managers will propose solutions and a technical group, typically composed of scientists and policy analysts from state agencies and the National Marine Fisheries Service (NMFS), will analyze these possible solutions. Both managers and the technical group can be aided and advised by an Advisory Panel, a closed group appointed by managers that is typically drawn from members of the fishing industry, processing sector, and Environmental Non-Governmental Organizations (ENGOs). In addition to the public comment process, the Advisory Panel is one of the mechanisms for stakeholders to raise awareness of management problems to managers. The Council will eventually select a solution through a vote and NMFS will, after verifying that it is consistent with applicable laws, translate those solutions into regulations and enforce those regulations. Management actions, particularly contentious ones, can take years to develop and implement.

In January 2016, the New England Fishery Management Council (NEFMC), the political body responsible for federally managed species in the northeast US, requested an MSE to evaluate harvest control rules (HCRs) for herring \footnote{The process is described in detail in Feeney \textit{et al}, YYYY}. Fishery managers wanted to develop an HCR that, among other things, accounted for the role of Atlantic herring as forage in the ecosystem. However, the exact ''accounting'' system was left to be defined by stakeholder-driven workshops that were open to the public. Two stakeholder workshops were conducted, one in May 2016 and another in December 2016. Members of the herring, lobster, groundfish, tuna, recreational, and whale-watching industries participated, as well as ENGOs, federal and state agencies, and academics. Input from these diverse stakeholders were then utilized to construct the closed-loop simulation portion of the MSE. Notably, while the techincal group knew the general scope of the modeling exercise (HCRs that account for herring as forage), detailed modeling of many components of interest could not begin in earnest until this step was finished.

The NEFMC desired to have results from the MSE ready to inform fisheries management decisions within one year, which left little time to develop the technical aspects of the MSE. A particularly challenging aspect of the time frame was deciding what technical aspects of the MSE (e.g., operating models) could be compromised or short-cut (i.e., perhaps not ideal from a scientific or best-practices standpoint) while ensuring the results would still accurately portray the trade-offs among objectives and remain relevant for decision-making. Thus, the methods described represent the reality of what was achieved in order to enable managers to make informed decisions within their preferred time frames, and this reality is then contrasted with more ideal scientific approaches that should be the ultimate goal for use in future decision making (i.e., the "dream").

#Methods
**Herring** 
 
*Basics.--* An MSE was developed specific to Gulf of Maine - Georges Bank Atlantic herring.  The MSE was a modified version of that used in @Deroba2014EvaluatingRho, and symbols were largely consistent with @Deroba2014EvaluatingRho (Table \ref{symtab}). The MSE was based on an age-structured simulation that considered fish from age-1 through age-8+ (age-8 and older), which is consistent with the age ranges used in the 2012 and 2015 Atlantic herring stock assessments [@NEFSC2012Assessment; @Deroba2015atlantic].  The abundances at age in year one of all simulations equaled the equilibrium abundances produced by the fishing mortality rate that would reduce the population to 40% of $SSB_{F=0}$.  Abundance in each subsequent age and year was calculated assuming that fish died exponentially according to an age and year specific total instantaneous mortality rate (Table XX T1-T2).
<!---markdown style table. fucking escape characters-->
```{r symboltable, tab.cap="Table of Symbols \\label{symtab}", echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|	Symbol	|	Definition
|:--------	|:--------------------------------------------------------
|	$y$	|	year
|	$a$	|	age
|	$R$	|	herring recruitment
|	$SSB$	|	herring spawning stock biomass
|	$F$	|	fishing mortality
|	$h$	|	steepness
|	$\\varepsilon_R$	|	recrutment process error
|	$\\sigma_R^2$	|	variance of recruitment process error
|	$\\omega$	|	autocorrelation of recruitment error
|	$N$	|	herring abundance
|	$m$	|	herring maturity
|	$W$	|	herring weight
|	$\\widehat{N}$	|	assessed herring abundance
|	$\\rho$	|	bias in assessed herring abundance
|	$\\varepsilon_{\\phi}$	|	assessment error
|	$\\tau$	|	autocorrelation of assessment error
|	$\\sigma_{\\phi}^2$	|	variance of assessment error
|	$B$	|	herring total biomass
|	$\\widehat{SSB}$	|	assessed herring spawning stock biomass
|	$\\widehat{B}$	|	assessed herring total biomass
|	$M$	|	herring natural mortality
|	$MSY$	|	herring maximum sustainable yield
|	$SSB_{up}$	|	upper biomass parameter for biomass based control rule
|	$SSB_{low}$	|	lower biomass parameter for biomass based control rule
|	$\\psi$	|	proportion of $F_{MSY}$ for biomass based control rule
|	$F_{MSY}$	|	fishing mortality at herring maximum sustainable yield
|	$\\tilde{F}$	|	target herring fishing mortality
|	$S$	|	herring fishery selectivity
|	$\\bar{F}$	|	fishing mortality that would remove quota from herring population
|	$Q$	|	quota for herring fishery
|	$F$	|	realized herring fishery mortality
|	$\\varepsilon_{\\theta}$	|	implementation error
|	$\\sigma_{\\theta}^2$	|	variance of implementation error
|	$P$	|	denotes a quantity that applies to a predator of herring
|	$N^P$	|	predator abundance
|	$S^P$	|	annual predator survival
|	$R^P$	|	predator recruitment from Beverton-Holt relationship
|	$\\bar{B}^P$	|	predator recruitment as modified by a relationship with herring
|	$v$	|	annual predator natural mortality
|	$u$	|	annual predator exploitation mortality
|	$Fwint$	|	intercept of Ford-Walford relationship
|	$Fwslope$	|	slope of Ford-Walford relationship
|	$B^P$	|	predator biomass
|	$N_{thresh}$	|	threshold in herring abundance that induces a reaction from a predator
|	$AnnAlpha$	|	intercept of Ford-Walford relationship as modified by a relationship with herring
|	$AnnRho$	|	slope of Ford-Walford relationship as modified by a relationship with herring
|	$\\delta$	|	exponent relating herring abundance to predator survival
|	$Havgwt$	|	average weight of herring
|	$\\lambda$	|	exponent relating herring average weight to tuna growth
|	$T$	|	inflection point of the relationship between herring average weight and tuna growth
|	$SSB_{MSY}$	|	herring spawning stock biomass at maximum sustainable yield
|	$IAV$	|	interannual variation in herring yield
|	$SSB_{MSY}^P$	|	predator spawning stock biomass at maximum sustainable yield
|	GR	|	gross revenue
|	NR	|	net operating revenues
|	i	|	fleet (trawl, t, or purse seine, s)
|	q	|	quantity landed
|	c()	|	cost function
|	p	|	function relating landings to prices
|	t	|	denotes trawl fishery in economic model
|	s	|	denotes purse seine fishery in economic model
|	$a_i$	|	parameter of price and landing model
|	b	|	parameter of price and landing model
|	$\\gamma$	|	parameter of price and landing model
|	$\\alpha$	|	parameter of price and landing model
|	$\\theta_i$	|	parameter of price and landing model
|	$\\beta$	|	parameter of price and landing model
|	$\\xi$	|	parameter of economic stationarity metric
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

Recruitment followed Beverton-Holt dynamics [@francis1992use] (Table XX T3-T5):
\begin{equation}
 R_{1,y+1}=\frac{(\frac{SSB_{F=0}}{R_{F=0}} \frac{1-h}{4h})SSB_y}{1+(\frac{5h-1}{4hR_{F=0}})SSB_y}e^{\varepsilon_{R,y}-\frac{\sigma_R^2}{2}} \\
 \varepsilon_{R,y}=\omega \varepsilon_{R,y-1}+\sqrt{1-\omega^2}\varrho_y \\
 \varrho \sim N(0,\sigma_R^2) \\
 SSB_y=\sum\limits_{a=1}^{8+}N_{a,y}m_aW_a. \\
\end{equation}

The variance of recruitment process errors ($\sigma_R^2$) equaled 0.36 and the degree of autocorrelation ($\omega$) equaled 0.1, which are values consistent with recruitment estimates from a recent Atlantic herring stock assessment [@Deroba2015atlantic].

*Assessment Error.--* A stock assessment was approximated (i.e., assessment errors) similar to @punt2008evaluation and @Deroba2014EvaluatingRho.  Assessment error was modeled as a year-specific lognormal random deviation common to all ages, with first-order autocorrelation and a term that created the option to include bias $\varepsilon_{}$ (Table XX T6-T7):

\begin{equation}
\widehat{N}_{a,y}=[N_{a,y}(\rho+1)]e^{\varepsilon_{\phi,y}-\frac{\sigma_\phi^2}{2}} \\
\varepsilon_{\phi,y}=\vartheta\varepsilon_{\phi,y-1}+\sqrt{1-\vartheta^2}\tau_y \\
\tau \sim N(0,\sigma_\phi^2). \\
\end{equation}

The variance of assessment errors ($\sigma_\phi^2$ ) equaled 0.05 and autocorrelation ($\vartheta$) equaled 0.7.  Rho ($\rho$) allowed for the inclusion of bias in the assessed value of abundance (see below; @Deroba2014EvaluatingRho).  Assessed spawning stock biomass ($\widehat{SSB}_y$) was calculated similarly to $SSB_y$ except with $N_{a,y}$ replaced with $\widehat{N}_{a,y}$ (Table XX T5), and assessed total biomass ($\widehat{B}_y$) was calculated as the sum across ages of the product of $\widehat{N}_{a,y}$ and $W_a$.

*Operating Models.--* The stakeholder workshops identified uncertainties about herring life history traits and stock assessment, and the effect of some of these uncertainties on harvest control rule performance was evaluated by simulating the control rules for each of eight operating models (Table \ref{OMs}; Figures 1-2).  The uncertainties addressed by the eight operating models included: Atlantic herring natural mortality and steepness, Atlantic herring weight-at-age, and possible bias in the stock assessment beyond the unbiased measurement error ($\varepsilon_{\phi y}$). 

```{r OMs, tab.cap="Operating model uncertainties addressed\\label{OMs}", echo=FALSE, message=FALSE, warnings=FALSE,  results='asis'}
tabl <- "
| Operating Model Name | Herring productivity | Herring growth   | Assessment bias  |
|:---------------------|:---------------------|:-----------------|:-----------------|
| LowFastBiased        | Low: high $M$, low $h$ (0.44)  | 1976-1985: fast | 60% overestimate |
| LowSlowBiased        | Low: high $M$, low $h$ (0.44)  | 2005-2014: slow | 60% overestimate |
| LowFastCorrect       | Low: high $M$, low $h$ (0.44)  | 1976-1985: fast | None             |
| LowSlowCorrect       | Low: high $M$, low $h$ (0.44)  | 2005-2014: slow | None             |
| HighFastBiased       | High: low $M$, high $h$ (0.79) | 1976-1985: fast | 60% overestimate |
| HighSlowBiased       | High: low $M$, high $h$ (0.79) | 2005-2014: slow | 60% overestimate |
| HighFastCorrect      | High: low $M$, high $h$ (0.79) | 1976-1985: fast | None             |
| HighSlowCorrect      | High: low $M$, high $h$ (0.79) | 2005-2014: slow | None             |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

```{r MortsWts, tab.cap="Herring natural mortality and mean weights-at-age (kg) \\label{MWttab}", echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|Age	|High $M$	|Low $M$	|Fast Growth	|Slow Growth |
|:----|:----|:----|:----|:----|
|1	|0.81	|0.54	|0.01	|0.02|
|2	|0.65	|0.43	|0.03	|0.04|
|3	|0.54	|0.36	|0.09	|0.07|
|4	|0.48	|0.32	|0.16	|0.11|
|5	|0.45	|0.3	|0.21	|0.14|
|6	|0.42	|0.28	|0.25	|0.16|
|7	|0.41	|0.27	|0.28	|0.18|
|8+	|0.40	|0.26	|0.31	|0.21|
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

The specific values used in the operating models for each of the uncertainties were premised on data used in recent stock assessments or estimates from fits of stock assessment models [@Deroba2015atlantic].  Natural mortality in recent stock assessments has varied among ages and years, with $M$ being higher during 1996-2014 than in previous years  [@NEFSC2012Assessment;@Deroba2015atlantic].  Natural mortality, however, has also been identified as an uncertainty in the stock assessments and sensitivity runs have been conducted without higher $M$ during 1996-2014, such that $M$ was constant among years [@NEFSC2012Assessment;@Deroba2015atlantic].  To capture uncertainty in $M$ in the MSE, operating models were run with either relatively high or low $M_a$ (Table \ref{MWttab}; Figure 1).  Relatively high $M_a$ values equaled the age-specific natural mortality rates used for the years 1996-2014 in the stock assessment.  Relatively low $M_a$ values in the MSE equaled the age-specific natural mortality rates used for the years 1965-1995 in the stock assessment.  In the MSE, $M_a$ was always time invariant.

Uncertainty in estimates of stock-recruit parameters were represented in the MSE by using the parameters estimated by stock assessments fit with and without the higher $M$ during 1996-2014.  Stock assessment fits with higher $M$ during 1996-2014 produced estimates of steepness and $SSB_{F=0}$ that were lower than in stock assessment fits without higher $M$ during 1996-2014 (Table 3; Figure 1).  Thus, operating models with relatively high $M_a$ always had relatively low steepness and $SSB_{F=0}$, and the opposite held with relatively low $M_a$ (Table \ref{OMs}).

Uncertainty in Atlantic herring size-at-age was accounted for by having operating models with either fast or slow growth (i.e., weights-at-age; Table \ref{MWttab}; Figure 3).  Atlantic herring weight-at-age generally declined from the mid-1980s through the mid-1990s, and has been relatively stable since.  Reasons for the decline are speculative and no causal relationships have been established.  Thus, fast growth operating models had weights-at-age that equaled the January 1 weights-at-age from the most recent stock assessment averaged over the years 1976-1985, while the slow growth operating models averaged over the years 2005-2014 (@Deroba2015atlantic).  In the MSE, weight-at-age was always time invariant.

Differences in $M$, stock-recruit parameters, and weights-at-age led to differences in unfished and $MSY$ reference points among operating models (Table \ref{RefPts}).  The effect of $M$ and stock-recruit parameters was larger than the effect of differences in weight-at-age (Table \ref{RefPts}).

```{r refpt,tab.cap="Unfished and MSY reference points for the Atlantic herring operating models \\label{RefPts}", echo=FALSE, message=FALSE, warnings=FALSE, results='asis' }
tabl <- "
| Steepness | Natural Mortality | Growth | Unfished SSB | SSB MSY | MSY | F MSY |
|:----|:----|:----|:----|:----|:----|:----|
| 0.44 | High | Slow | 845176 | 324977 | 66061 | 0.31 |
| 0.44 | High | Fast | 845176 | 335849 | 60969 | 0.28 |
| 0.79 | Low | Slow | 1347080 | 369089 | 129171 | 0.54 |
| 0.79 | Low | Fast | 1347080 | 405485 | 120360 | 0.45 |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```


To address concerns about possible stock assessment bias, operating models with and without a positive bias were included.  In operating models without bias, $\rho$=0 and the only assessment error was that caused by the unbiased measurement errors ($\epsilon_{\phi y}$).  In operating models with bias, $\rho$=0.6, which was based on the degree of retrospective pattern in $SSB$ from the most recent stock assessment [@Deroba2015atlantic].

*Harvest Control Rules.--* Several  basic control rules were evaluated, including a biomass based control rule [@katsukawa2004numerical], a constant catch rule, and a conditional constant catch rule (Figure 3; @clark2004conditional, @Deroba2012Evaluating).  The biomass based control rule was defined by three parameters: the proportion ($\psi$) of $F_{MSY}$ that dictates the maximum desired fishing mortality rate ($\tilde{F}$), an upper SSB threshold ($SSB_{up}$), and a lower SSB threshold ($SSB_{low}$).  The $\tilde{F}$ equaled the maximum when $\widehat{SSB}$ was above the upper threshold, declined linearly between the upper and lower thresholds, and equaled zero below the lower threshold:

  \begin{equation}
  \label{Fy_equation}
    \tilde{F}_y=
    \begin{cases}
      \psi F_{MSY}, & \text{if}\ \widehat{SSB}_y \geq SSB_{up} \\
      \psi F_{MSY} \frac{\widehat{SSB}_y - SSB_{low}}{SSB_{up}-SSB_{low}}, & \text{if}\ SSB_{low} < \widehat{SSB}_y < SSB_{up}\\
      0, & \text{if}\ \widehat{SSB}_y \leq SSB_{low}
    \end{cases}
  \end{equation}

The $\tilde{F}_y$ was then used to set a quota in year y + 1 (Table XX T8).  $\tilde{F}_{ay}$ equaled $\tilde{F}_y$ times $S_a$, and $S_a$ was time and simulation invariant selectivity at age equal to the values for the mobile gear fishery reported in [@Deroba2015atlantic, Table 1].  $\tilde{F}_y$ was used to set a quota in the following year to approximate the practice of using projections based on an assessment using data through year y - 1 to set quotas in the following year(s).  Furthermore, although $\tilde{F}_y$ was set using $\widehat{SSB}_y$, the quota was based on $\widehat{B}_y$ because the fishery selects some immature ages.  The fully selected fishing mortality rate that would remove the quota from the true population ($\bar{F}_y$) was found using Newton-Raphson iterations.
Several variations of the biomass based rule were also evaluated.  These variations included applying the control rule annually, using the same quota for three year blocks such that the control rule is applied every fourth year (i.e., $Q_{y+1}=Q_{y+2}=Q_{y+3}$), using the same quota for 5 year blocks, and using the same quota for three year blocks but restricting the change in the quota to 15% in either direction when the control rule was reapplied in the fourth year.  Thus, four variants of the biomass based control rule were evaluated: 1) annual application, 2) three year blocks, 3) five year blocks, and 4) 3 year blocks with a 15% restriction.

For each biomass based control rule variant, a range of values for the three parameters defining the control rule were evaluated.  The proportion ($\psi$) of $F_{MSY}$ that dictates the maximum desired fishing mortality rate was varied from 0.1$F_{MSY}$ to 1.0$F_{MSY}$ in increments of 0.1, while the upper and lower SSB threshold parameters ($SSB_{up} \; SSB_{low}$) were varied from 0.0$SSB_{MSY}$ to 4$SSB_{MSY}$ but with inconsistent increments (i.e., 0.0, 0.1, 0.3, 0.5, 0.7, 0.9, 1.0, 1.1, 1.3, 1.5, 1.7, 2.0, 2.5, 3, 3.5, 4).  The full factorial of combinations for the three biomass based control rule parameters produced 1,360 shapes (note $SSB_{low}$ must be <= $SSB_{up}$) and each of these shapes was evaluated for each of the four biomass based control rule variants described above.

The constant catch control rule is defined by one parameter, a desired constant catch (i.e., quota) amount (Figure 3).  The constant catch amounts were varied from 0.1$MSY$ to 1.0$MSY$ in increments of 0.1.  

The conditional constant catch rule used a constant desired catch amount unless removing that desired catch from the assessed biomass caused the fully selected fishing mortality rate to exceed a pre-determined maximum, in which case the desired catch was set to the value produced by applying the maximum fully selected fishing mortality rate to the assessed biomass (Figure 3).  Thus, the conditional constant catch rule has two policy parameters: a desired constant catch amount, and a maximum fishing mortality rate.  The constant catch amounts were varied from 0.1$MSY$ to 1.0$MSY$ in increments of 0.1, while the maximum fishing mortality rate equaled 0.5$F_{MSY}$.  When the maximum fishing mortality rate portion of the conditional constant catch rule was invoked, a quota was set in the same manner as when $\widehat{SSB}_y >= SSB_{up}$ in the biomass based control rule described above.

*Implementation Error.--* Implementation errors were also included in a similar way as in @punt2008evaluation and @Deroba2012Evaluating, as year-specific lognormal random deviations (Table XX T9):
\begin{equation}
F_{a,y}=\bar{F}_yS_ae^{\varepsilon_{\theta,y}-\frac{\sigma_\theta^2}{2}} \\
\varepsilon_{\theta}\sim N(0,\sigma_\theta^2).
\end{equation}
The variance of implementation errors ($\sigma_\theta^2$) equaled 0.001.

**Predators**

There are two components of predator modeling for the herring MSE: a predator population model, and a herring-predator relationship model to link herring with predator populations. Here, we give an overview of the modeling process, and we describe the decisions made in parameterizing individual predator models and herring-predator relationships in the following sections. The overall population in numbers for each predator $P$ each year $N_{y}^P$ is modeled with a delay-difference function: 
\begin{equation}
N_{y+1}^P = N_{y}^PS_{y}^P +  R_{y+1}^P \label{delaydiffN_equation},
\end{equation}
where annual predator survival $S_{y}^P$ is based on annual natural mortality $v$ and exploitation $u$ 
\begin{equation}
S_{y}^P =  (1-v_{y})(1-u) \label{survival_equation},
\end{equation}
and annual recruitment $R_{y}^P$ (delayed until recruitment age a) is a Beverton-Holt function defined as above for herring.

Predator population biomass is defined with Ford-Walford plot intercept ($FWint$) and slope ($FWslope$) growth parameters
\begin{equation}
B_{y+1}^P = S_{y}^P (FWint N_{y}^P + FWslope B_{y}^P) + FWint R_{y+1}^P \label{delaydiffB_equation}
\end{equation}

Parameterizing this model requires specification of the stock-recruitment relationship (steepness h and unfished spawning stock size in numbers or biomass), the natural mortality rate, the fishing mortality (exploitation) rate, the initial population size, and the weight at age of the predator (Ford-Walford plot intercept and slope parameters). For each predator, population parameters were derived from different sources (Tab. \ref{predsource}).

```{r popsources, tab.cap="Predator population model specification and parameter sources\\label{predsource}", echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|                      | Highly migratory     | Seabird              | Groundfish           | Marine mammal        |
|:---------------------|:---------------------|:---------------------|:---------------------|:---------------------|
| Stakeholder preferred species | Bluefin tuna | Common tern | not specified | not specified |
| Species modeled     | Bluefin tuna (western Atlantic stock) | Common tern (Gulf of Maine colonies as defined by the GOM Seabird Working Group) | Spiny dogfish (GOM and GB cod stocks also examined) | none, data limited (Minke & humpback whales, harbor porpoise, harbor seal examined) |
| Stock-recruitment   | Current assessment and literature | Derived from observations | Current assessment and literature | No time series data for our region | 
| Natural mortality | Current assessment | Literature | Current assessment | Derivable from assessment? |
| Fishing mortality | Current assessment | n/a | Current assessment | Derivable from assessment? |
| Initial population | Current assessment | Derived from observations | Current assessment | Derivable from assessment? |
| Weight at age | Literature | Literature | Literature | Literature | 
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

Predator population models were based on either the most recent stock assessment for the predator or from observational data from the Northeast US shelf. Herring-predator relationships were based on either peer-reviewed literature or observational data specific to the Northeast US shelf. We did not include process or observation error in any of these modeled relationships. This is obviously unrealistic, but the primary obective of the herring MSE is to evaluate the effect of herring management on predators. Leaving out variability driven by anything other than herring is intended to clarify the effect of herring managment. 

To develop the herring-predator relationship model, specific herring population characteristics (e.g. total abundance or biomass, or abundance/biomass of certain ages or sizes) were related to either predator growth, predator reproduction, or predator survival. Our aim was to use information specific to the Northeast US shelf ecosystem, either from peer-reviewed literature, from observations, or a combination. 

In general, if support for a relationship between herring and predator recruitment was evident, it was modeled as a predator recruitment multiplier based on the herring population ($Hpop_{y}$) relative to a specified threshold $Hthresh$:
\begin{equation}
\bar{R}_{y+a}^P = R_{y+a}^P  * \frac{\gamma(N_{y}/N_{thresh})}{(\gamma-1)+(N_{y}/N_{thresh})} \label{recwithherring_equation}, 
\end{equation}

where $\gamma$ > 1 links herring population size relative to the threshold level to predator recruitment.

If a relationship between predator growth and herring population size was evident, annual changes in growth were modeled by modifying either the Ford-Walford intercept ($AnnAlpha$) or slope ($AnnRho$):

\begin{equation}
B_{y+1}^P = S_{y}^P (AnnAlpha_{y} N_{y} + FWslope B_{y}) + AnnAlpha_{y}R_{y+1}, or
\end{equation}

\begin{equation}
B_{y+1} = S_{y} (FWint N_{y} + AnnRho_{y} B_{y}) + FWint R_{y+1}, 
\end{equation}

where either $AnnAlpha$ or $AnnRho$ are defined for a predator using herring population parameters (see Eqn. \ref{tunagrow_equation} below).

Finally, herring population size $N_{y}$ could be related to predator survival using a multiplier on constant predator annual natural mortality $v$: 

\begin{equation}
v_{y} =  v e ^ {-(\frac{N_{y}}{N_{F=0}})\delta} \label{varmort_equation},
\end{equation}
where 0 < $\delta$ <1 links herring population size to predator survival.

After specifying the population model parameters and herring-predator relationship, we applied the [@hilborn_quantitative_2003] equilibruim calculation for the delay difference model with F=0 to get the unfished spawners per recruit ratio. This ratio was then used in a new equilibruim calculation with the current predator exploitation rate to estimate Beverton-Holt stock recruitment parameters, equilibrium recruitment and equilibrium individual weight under exploitation. Then, each model was run forward for 150 years with output from the herring operating model specifying the herring population characteristics. 

## Highly migratory species
Bluefin tuna were identified at the stakeholder workshop as the recommended highly migratory herring predator. 

### Tuna population model
Western Atlantic bluefin tuna population parameters were drawn from the 2014 stock assessment [@iccat_report_2015], the growth curve from [@restrepo_updated_2010], and recruitment parameters from a detailed examination of alternative stock recruit relationships [@porch_making_2016]. Ultimately, the âlow recruitmentâ scenario was selected to represent bluefin tuna productivity in the Gulf of Maine, which defines Bmsy as 13,226 t and therefore affects measures of status relative to Bmsy. Continuation of the current tuna fishing strategy (F<0.5Fmsy under the low recruitment scenario) is assumed. All predator population model parameters are listed in Table 2. 

### Herring-tuna relationship model
Tuna diets are variable depending on location and timing of foraging [@chase_differences_2002; @golet_changes_2013; @logan_diet_2015; @golet_paradox_2015], but for the purposes of this analysis, we assumed that herring is an important enough prey of tuna to impact tuna growth in the Northeast US shelf ecosystem. A relationship between bluefin tuna growth and herring average weight was implemented based on information and methods in @golet_paradox_2015. The relationship between tuna condition anomaly (defined as proportional departures from the weight-at-length relationship used in the assessment) and average weight of tuna-prey-sized herring ($Havgwt_{y}$, herring >180 mm collected from commercial herring fisheries) was modeled as a generalized logistic function with lower and upper bounds on tuna growth parameters:
\begin{equation}
AnnAlpha_{y} = (0.9 FWint) + \frac{(1.1 FWint) - (0.9 FWint)}{1+e^{(1-\lambda)*(100(Havgwt_{y}-T)/T)}} \label{tunagrow_equation},
\end{equation} 
where $\lambda$ > 1 links herring average weight anomalies to tuna growth.
   
The inflection point of $T$ = 0.15 kg average weight matches the 0 tuna weight anomaly in @golet_paradox_2015 (p. 186, Fig 2C), and upper and lower bounds were determined by estimating the growth intercept with weight at age 10% higher or lower, respectively from the average weight at age obtained by applying the length to weight conversion reported in the 2014 stock assessment [@iccat_report_2015] to the length at age estimated from the @restrepo_updated_2010 growth curve (Fig \ref{herringtuna}). When included in the model with $\lambda$ = 1.1 in equation \ref{tunagrow_equation}, the simulated variation in tuna weight at age covered the observed range reported in @golet_paradox_2015. 

```{r, fig.cap="Modeled herring average weight-tuna growth relationship \\label{herringtuna}", out.width='300pt', message = FALSE, warning = FALSE}
# from MSE_TunaLink.R
FWalpha       <-  0.020605  #ford-walford plot intercept parameter 
FWrho         <-  0.9675  #ford-walford plot slope parameter
BFTGrowThresh <-  0.15
preypredgrow  <-  1.1 #strengh of effect of prey N on predator growth, >=1, 1=no effect

preyAvgWt     <-  seq(0,0.3,by=0.01)
AnnualAlpha   <-  c()

AnnualAlpha<-(0.9*FWalpha) + ((1.1*FWalpha) - (0.9*FWalpha))/(1+exp((1-preypredgrow)*(100*(preyAvgWt-BFTGrowThresh)/BFTGrowThresh))) #alpha changes with herring avg wt, not slope

qplot(preyAvgWt, AnnualAlpha, geom="line") 

```

## Seabirds
Common terns were identified at the stakeholder workshop as the recommended seabird herring predator. 

### Tern population model
There is no published stock assessment or population model for most seabirds in the Northeast US. Therefore, Gulf of Maine Common and Arctic tern population parameters were drawn from accounts in the Birds of North America [@hatch_arctic_2002; @nisbet_common_2002] and estimated from counts of breeding pairs and estimates of fledgling success summarized by the Gulf of Maine Seabird Working Group (GOMSWG; data at http://gomswg.org/minutes.html), as corrected and updated by seabird experts from throughout Maine. While we analyzed both Arctic and Common tern information, the stakeholder workshop identified Common terns as the example species for modeling, and this species has more extensive data and a generally higher proportion of herring in its diet based on that data. Therefore, the model is based on common terns in the Gulf of Maine. 

Adult breeding pairs by colony were combined with estimated productivity of fledglings per nest to estimate the annual number of fledglings for each year. A survival rate of 10% was applied to fledglings from each year to represent ârecruitsâ to the breeding adult population age 4 and up [@nisbet_common_2002]. This âstock-recruitâ information was used to estimate steepness for the delay difference model based on common tern information only. Fitting parameters with R nls [@Rcite] had variable success, with the full dataset unable to estimate a significant beta parameter (cyan line, Fig. \ref{ternSR}) for common terns, and a truncated dataset resulting in low population production rates inconsistent with currently observed common tern trends (bright green line overlaid with black, Fig. \ref{ternSR}). Therefore, steepness was estimated to give a relationship (black line, Fig. \ref{ternSR}) falling between these two lines. The resulting stock recruit relationship set steepness at 0.26, a theoretical maximum breeding adult population of 45,000 pairs (@nisbet_common_2002, 1930âs New England population), and a theoretical maximum recruitment of 4,500 individuals annually (reflecting approximately a productivity of 1.0 at âcarrying capacityâ resulting in a stable population). Average common tern productivity is 1.02 (all GOM colony data combined). Adult mortality was assumed to be 0.1 for the delay difference model (survival of 90% [@nisbet_common_2002] for adults).


```{r, eval=sg_figs, fig.cap="Stock-recruitment function for Gulf of Maine common terns \\label{ternSR}", out.width='400pt', message = FALSE, warning = FALSE}
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

terntotalpop <- ternpopproddiet %>%
  group_by(yr, species) %>%
  filter(yr<2016) %>%
  select(breedpairs, nfledged) %>%
  filter(!is.na(nfledged)) %>%
  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

ternrec <- ggplot(terntotalpop, aes(x=totpairs, y=totfledge*.1, colour=species)) +
  geom_point() +
  scale_y_continuous(limits = c(0,5000)) +
  scale_x_continuous(limits = c(0,45000)) +
  ggtitle("Tern stock and recruitment assuming 10% fledgling->adult survival")

BHfun <- function(x,a,b){
  (x/a)/(1+(1/a*b)*x)
}

BHsteep <- function(Sdat, steep, Rmax, Smax){
  4*steep*Rmax*Sdat/
    (Smax*(1-steep)+Sdat*(5*steep-1))
}

ternrec+
  stat_function(fun=BHfun, args=list(a= 5.445551,b=0.0002266453), col="green", lwd=2)+
  stat_function(fun=BHfun, args=list(a= 9.786020,b=-0.0001570145), col="cyan3")+
  stat_function(fun=BHsteep, args=list(steep=0.41, Rmax=2900, Smax=45000), col="black") +
  stat_function(fun=BHsteep, args=list(steep=0.26, Rmax=4500, Smax=45000), col="black")

```
 

The resulting model based on common tern population dynamics in the Gulf of Maine (with no link to herring) predicts that the population will increase to its carrying capacity under steady conditions over a 150 year simulation. The actual population has increased at ~2% per year between 1998 and 2015 (Fig. \ref{terntrend}). Given the lack of detailed demographic information in the delay-difference model, this was considered a good representation of the average observed trend in current common tern population dynamics. 

```{r, eval=sg_figs, fig.cap="Population trends for Gulf of Maine terns, no herring link \\label{terntrend}", out.width='400pt', message = FALSE, warning = FALSE}
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

#terntotalpop <- ternpopproddiet %>%
#  group_by(yr, species) %>%
#  filter(yr<2016) %>%
#  select(breedpairs, nfledged) %>%
#  filter(!is.na(nfledged)) %>%
#  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

terntotalpop19982015 <- terntotalpop %>%
  filter(yr>1997)

ternpoptrend <- ggplot(terntotalpop19982015, aes(x=yr, y=totpairs, colour=species))

# plot with actual data and simulated data from pop model
# WARNING only works with PredN from MSE_TernLink.R reproduced here
#######Some Functions#########
###Function to calculate unfished "SSBR", and abundance or biomass, or equilibrium characteristics given exploitation rate for delay-difference dynamics with Beverton-Holt SR.
#function(unfishedspr,desired unfished N or B, steepness,units of numbs or bio?, annual natural mortality, annual fishery exploitation rate, ford walford parameter intercept, ford walford slope param, do unfished or exploited equilib?)
unfishspr<-function(predunfishspr=NULL,targzero=NULL,steep=NULL,numbs_weightb=NULL,annualnatmort=NULL,annualexploit=NULL,FWalpha=NULL,FWrho=NULL,unfishflag=NULL) {
  #see delay-diff chapter of hilborn and walters and common pubs on steepness (Mangel et al 2010)
  predrzero<-1/predunfishspr*targzero  #unfished recruitment=f(unfishedSSBR,unfished N or B specified by user
  predalpha<-(4*steep*predrzero)/(5*steep-1) #alpha of BH SR #1/beta? alpha in Mangel et al 2010 is (targzero/predrzero)*((1-steep)/(4*steep)) #
  predbeta<-((targzero/predrzero)*((1-steep)/(4*steep)))/((5*steep-1)/(4*steep*predrzero)) #beta of BH SR #alpha/beta? beta ibid (5*steep-1)/(4*steep*predrzero)
  #predalpha<- (targzero/predrzero)*((1-steep)/(4*steep)) #direct from Mangel et al 2010
  #predbeta<-(5*steep-1)/(4*steep*predrzero) #direct from Mangel et al 2010
  if(numbs_weightb==1){ #solving in units of numbers or biomass
    kappa<-1-(1-annualnatmort)*(1-annualexploit) #growth-survival constant (pg 339 Hilborn and Walters)
    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium N
    Ceq<-eqvalue*annualexploit #equilibrium catch
    Req<-kappa*eqvalue #equilibrium recruitment
    SSeq<-eqvalue-Ceq  #equilibrium spawning stock
  } else {
    kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/FWalpha  #growth-survival constant (pg 339 Hilborn and Walters)
    #kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/(Recwt-((Prerecwt*FWrho)*(1-annualnatmort)*(1-annualexploit)))
    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium Biomass
    Yeq<-eqvalue*annualexploit #equilibrium yield
    Req<-kappa*eqvalue #equilibrium recruitment
    SSeq<-eqvalue-Yeq #equilibrium spawning stock
    Neq<-Req/(1-(1-annualnatmort)*(1-annualexploit)) #equilibrium N
    Weq<-eqvalue/Neq #equilibrium average weight
  }  
  if(unfishflag==0){ #if doing unfished then just return unfished spr to optimize function; required for equlibrium calcs
  return((targzero-eqvalue)^2)
  } else { #if not doing unfished (exploit>0) then return various equilibrium values
   if(numbs_weightb==1) { #units of numbers or biomass?
     return(data.frame("Neq"=eqvalue,"Ceq"=Ceq,"Req"=Req,"SSeq"=SSeq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
   }else {
     return(data.frame("Beq"=eqvalue,"Yeq"=Yeq,"Req"=Req,"SSeq"=SSeq,"Neq"=Neq,"Weq"=Weq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
   }
  }
}
#####end function unfishspr#####

#### Common Tern Gulf of Maine pars (see HerringMSEpredspars.xlsx for derivation

numbs_weight  <-  1  #2 #1=numbers, else weight.  Will predator be tracked just in numbers or numbers and weight?  Weight allows for growth effects.
Predzero      <-  45000 #5.90E+05 # #5.60E+09  #50000 #predator unfished total N or biomass
Predsteep     <-  0.26 #0.25  #0.8 #predator steepness
PredannualA   <-  0.1  #0.6 #predator annual natural mortality rate (0-1); serves as max if time varying
Predexploit   <-  0.00  #0.3 #predator annual exploitation rate (0-1)
FWalpha       <-  0.00015#1.5 #  #0.243 #ford-walford plot intercept parameter if doing biomass units tons
FWrho         <-  0.0  #1.45 #ford-walford plot slope parameter if doing biomass units; serves as max if time varying

PredN         <-  c() #for predator abundance vector
PredN[1]      <-  3000  #7000 #initial abundance in year 1
PredB         <-  c() #for predator biomass vector if doing in those units
PredB[1]      <-  1.5  #6000 #initial biomass in year 1 
PredRecdelay  <-  4  #1 #delay in years for when recruits in year y are added to population

preypredrec<-1 #strength of effect of prey N on predator recruitment (like Plaganyi and Butterworth) >=1; 1=no effect
preyprednatm<-0 #strength of effect of prey N on predator annual natural mort (0-1) 0=no effect
preypredgrow<-1 #strengh of effect of prey N on predator growth, >=1, 1=no effect
  
COTEprodThresh<-400000

#####End user inputs########

#Do predator unfished equilibrium calculation and get unfished spr
predunfishsprfxn<-optimize(f=unfishspr,interval=c(0,50),targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=0,FWalpha=FWalpha,FWrho=FWrho,unfishflag=0,tol=0.0000001)
predunfishspr<-predunfishsprfxn$minimum
#send unfished spr through function again with an exploitation rate to get equlibrium conditions
PredEquilib<-unfishspr(predunfishspr=predunfishspr,targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=Predexploit,FWalpha=FWalpha,FWrho=FWrho,unfishflag=1)
predalpha<-PredEquilib$predalpha #predator BH SR parm
predbeta<-PredEquilib$predbeta #predator BH SR parm
Req<-PredEquilib$Req
Weq<-PredEquilib$Weq
##############################################
#### Read in Herring "data"
#preyB<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111TotBioSimYear.txt", header=T)  
#preysim<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111NAASimYear.txt", header=T)
preyNsim<-transmute(preysim, preyN=Age1+Age2+Age3+Age4+Age5+Age6+Age7+Age8, Sim=Sim)
     
by_simN<-group_by(preyNsim, Sim)
Nyears<-summarise(by_simN, n=n())

#preychar<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111SimCharAA.txt", header=T)
preychar<-cbind(preychar, Age=rep(1:8,max(preychar$Sim)))
#BASE ON TOTAL B
Ternforage<-cbind(preyB, Yr=rep(1:Nyears$n, max(preychar$Sim)))
h<-1
  preyN<-Ternforage$TotalBio[Ternforage$Sim==h]
  nyears<-Nyears$n[h]
  #preyNzero for terns is the threshold total B where prod drops, FIXED based on GOM data
  preyNzero<-COTEprodThresh

  ###predator dynamics###
  #stuff I need
  Recmult<-(preypredrec*(preyN/preyNzero))/((preypredrec-1)+(preyN/preyNzero)) #fraction of expected predator BH recruitment dependent on prey N
  PredAnnualNatM<-PredannualA*exp(-(preyN/preyNzero)*preyprednatm) #needed if annual nat mort is time varying
  TotalSurv<-(1-PredAnnualNatM)*(1-Predexploit) #total annual predator survival
  catch<-c()
  Spawn<-c() #spawners in numbers or biomass depending
  yield<-c()
  Predrec<-c()
  Predrec[1:PredRecdelay]<-Req #set recruitment in initial years at equlibrium to account for delay
  ###year loop for predator dynamics
  for(y in 1:(nyears-1)){
    if(numbs_weight==1){
        catch[y]<-PredN[y]*Predexploit
        Spawn[y]<-PredN[y]-catch[y]
      } else {
        yield[y]<-PredB[y]*Predexploit
        Spawn[y]<-PredB[y]-yield[y]
      }
      Predrec[y+PredRecdelay]<-Recmult[y]*((predalpha*Spawn[y])/(predbeta+Spawn[y])) #SR
      PredN[y+1]<-PredN[y]*TotalSurv[y]+Predrec[y+1]
      }  

simTern <- data.frame(yr=seq(1998,2015,1), PredN=PredN[6:23])

ternpoptrend +   geom_point() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  geom_point(data=simTern, aes(x=yr, y=PredN, colour="Simulated"))


```

### Herring-tern relationship model
The relationship between herring abundance and tern reproductive success was built based on information from individual colonies on annual productivity, proportion of herring in the diet, and amount of herring in the population as estimated by the current stock assessment. Since little of this information has appeared in the peer-reviewed literature, we present it in detail here.  First, productivity information was evaluated by major diet item recorded for chicks over all colonies and years. In general, common tern productivity was higher when a streamlined fish species was the major diet item relative to invertebrates, but having herring as the major diet item resulted in about the same distribution of productivities as having hake or sandlance as the major diet item for these colonies (Fig. \ref{chickdiet}). 

```{r, eval=sg_figs, fig.cap="Major diet items for Gulf of Maine tern fledgelings \\label{chickdiet}",  out.width='400pt', message = FALSE, warning = FALSE}
#knitr::include_graphics("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/TernMajorDietItems.png")
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

majorterndiet <- ternpopproddiet %>% 
  filter(!majority.diet %in% c("", "hake and sandlance",
                             "hake and butterfish",
                             "herring and hake",
                             "herring present"))

dietitem <- ggplot(majorterndiet, aes(x=majority.diet, y=productivity, colour=species)) +
  geom_hline(yintercept = 1) + 
  geom_boxplot()

dietitem + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))                  

```

Individual colonies showed different trends in number of nesting pairs, productivity, and proportion of herring in the diet (plots available upon request). When both Arctic and Common terns shared a colony, interannual changes in productivity were generally similar between species, suggesting that conditions at and around the colony (weather, predation pressure, and prey fields) strongly influenced productivity rather than species-specific traits. Only two colonies (Machias Seal Island near the Canadian Border and Stratton Island in southern Maine) showed a significant positive correlation between the proportion of herring in the chick diet and productivity. Other islands showed either non-significant (no) relationships, or in one case (Metinic Island) a significant negative relationship (Fig. \ref{proddiet}). 

```{r, eval=sg_figs, fig.cap="Herring proporiton in diet and tern productivity by colony \\label{proddiet}", out.width='400pt', message = FALSE, warning = FALSE}
#knitr::include_graphics("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/ternproddiet.png")
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

ternproddiet <- ggplot(ternpopproddiet, aes(x=prop.herring, y=productivity, colour=species)) +
  geom_point() +
  geom_hline(yintercept = 1) +
  #stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  #stat_smooth(method = "loess", formula = y ~ x, size = 1) +
  ggtitle("Herring proportion in diet and tern productivity GOM")

ternproddiet + facet_wrap(~colony) #+ theme(text=element_text(size=16))

```

The estimated population size of herring on the Northeast US shelf had some relationship to the amount of herring in tern diet at several colonies (4 of 13 common tern colony diets related to herring Age 1 recruitment, 6 of 13 common tern colony diets related to herring total B, and 4 of 13 common tern colony diets related to herring SSB; detailed statistics and plots available upon request). However, statistically significant direct relationships between herring population size and tern productivity were rare, with only Ship Island productivity increasing with herring total B, and Eastern Egg Rock, Matinicus Rock, Ship, and Monomoy Islands productivity increasing with herring SSB. Given that Monomoy Island tern chicks consistently received the lowest proportion of herring in their diets of any colony (0-11%), we donât consider this relationship further to build the model.  

Based on tern feeding observations, we would expect the number of age 1 herring in the population to be most related to tern productivity since that is the size class terns target, but this relationship was not found in analyzing the data. Herring total biomass was positively related to tern diets at nearly half of the colonies, and reflects all size classes including the smaller sizes most useful as tern forage, but was only directly related to tern productivity at one colony.  Herring SSB was not considered further as an index of tern prey because it represents sizes larger than tern forage. 

<!--Examining all colonies together shows some relationship between herring population size and herring in tern diets, but no consistent relationship between the proportion of herring in tern diets and tern productivity, or between herring population size and tern productivity. Therefore, a reasonable lower bound on the potential for herring to influence tern productivity in the Gulf of Maine is âno relationship,â and any herring control rule (short of one that severely overfishes or eliminates the stock) would not expected to affect tern productivity under this assumption.--> 

To represent the potential for herring to influence tern productivity, we parameterized a tern ârecruitment multiplierâ based on herring assessed total biomass and common tern productivity across all colonies (except Monomoy where terns eat sandlance). This relationship includes a threshold herring biomass where common tern productivity would drop below 1.0, and above that threshold productivity exceeds 1.0 (Fig. \ref{herrternmod}). The threshold of ~400,000 tons is set where a linear relationship between herring total biomass and common tern productivity crosses productivity=1 (black dashed line in Fig. \ref{herrternmod}). However, the selected threshold is uncertain because there are few observations of common tern productivity at low herring total biomass (1975-1985). The linear relationship does not have a statistically significant slope; a curve was fit to represent a level contribution of herring total biomass to common tern productivity above the threshold. The curve descends below the threshold, dropping below 0.5 productivity at around 50,000 tons and representing the extreme assumption that herring extinction would result in tern productivity of 0. Although the relationship of tern productivity to herring biomass at extremely low herring populations has not been quantified, control rules that allow herring extinction do not meet stated management objectives for herring, so this extreme assumption for terns will not change any decisions to include or exclude control rules. 

```{r, eval=sg_figs, fig.cap="Modeled influence of herring total biomass on tern reproductive success \\label{herrternmod}", out.width='400pt', message = FALSE, warning = FALSE}
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

#herring <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/herringassessout2015.csv")
herring <- herring[,1:6]

ternpopproddiet_herring <- left_join(ternpopproddiet, herring)

#terntotalpop <- ternpopproddiet %>%
#  group_by(yr, species) %>%
#  filter(yr<2016) %>%
#  select(breedpairs, nfledged) %>%
#  filter(!is.na(nfledged)) %>%
#  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

# Monomoy Island is a third of the population but eats mainly sandlance and is south of GOM proper--leave out?

terntotpop_noMon <- ternpopproddiet %>%
  group_by(yr, species) %>%
  filter(colony != "Monomoy") %>%
  filter(yr<2016) %>%
  select(breedpairs, nfledged) %>%
  filter(!is.na(nfledged)) %>%
  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

ternpop_herringpop <- left_join(terntotalpop, herring)
ternpopnomon_herringpop <- left_join(terntotpop_noMon, herring)

totprodnomonherr <- ggplot(ternpopnomon_herringpop, aes(x=HerringTotalB, y=totfledge/totpairs, colour=species)) +
  geom_point() +
  geom_hline(yintercept = 1) +
  ggtitle("Tern production (no Monomoy) and assessed herring tot B")

#totprodnomonherr + stat_smooth(method = "lm", formula = y ~ x, size = 1) 

HerrAlpha <- 1.09
HerringThresh <- 400000

recmult<-(HerrAlpha*(ternpopnomon_herringpop$HerringTotalB/HerringThresh))/((HerrAlpha-1)+(ternpopnomon_herringpop$HerringTotalB/HerringThresh))

#totprodnomonherr + geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5)

lmtotnomon <- lm(totfledge/totpairs ~ HerringTotalB, species=="Common", data=ternpopnomon_herringpop)

#totprodnomonherr + geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5) +
  #geom_line(aes(x=HerringTotalB, y=9.439e-01 + 1.210e-07*HerringTotalB), color="black", lty=3)

totprodnomonherr + 
  scale_y_continuous(limits = c(0,1.8)) +
  scale_x_continuous(limits = c(0,2500000)) +
  geom_line(aes(x=HerringTotalB, y=recmult), lwd=1.5) +
  geom_line(aes(x=HerringTotalB, y=9.439e-01 + 1.210e-07*HerringTotalB), color="black", lty=3) +
  geom_line(aes(x=seq(0,2500000,length.out=51), y=(HerrAlpha*(seq(0,2500000,length.out=51)/HerringThresh))/((HerrAlpha-1)+(seq(0,2500000,length.out=51)/HerringThresh))))


```

When included in the model using $\gamma$ = 1.09 in equation \ref{recwithherring_equation}, this relationship adjusts the modeled common tern population increase to match the current average increase in common tern nesting pairs observed in the data (Fig. \ref{terntrendwherring}). There is still considerable uncertainty around this mean population trajectory which cannot be reflected in our simple model. 

```{r, eval=sg_figs, fig.cap="Population trends for Gulf of Maine terns with simulated herring-common tern productivity relationship \\label{terntrendwherring}", out.width='400pt', message = FALSE, warning = FALSE}
#ternpopproddiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMTernPopsProdDiet_Corrected.csv")

#reconcile names
#names(ternpopproddiet)[5]<-"productivity"

#get rid of trailing white spaces
#ternpopproddiet$majority.diet <- sub(" +$", "", ternpopproddiet$majority.diet)

#terntotalpop <- ternpopproddiet %>%
#  group_by(yr, species) %>%
#  filter(yr<2016) %>%
#  select(breedpairs, nfledged) %>%
#  filter(!is.na(nfledged)) %>%
#  summarise(totpairs = sum(breedpairs, na.rm=T), totfledge = sum(nfledged, na.rm=T))

#terntotalpop19982015 <- terntotalpop %>%
#  filter(yr>1997)

ternpoptrend <- ggplot(terntotalpop19982015, aes(x=yr, y=totpairs, colour=species))

# plot with actual data and simulated data from pop model
# WARNING only works with PredN from MSE_TernLink.R reproduced here
#######Some Functions#########
###Function to calculate unfished "SSBR", and abundance or biomass, or equilibrium characteristics given exploitation rate for delay-difference dynamics with Beverton-Holt SR.
#function(unfishedspr,desired unfished N or B, steepness,units of numbs or bio?, annual natural mortality, annual fishery exploitation rate, ford walford parameter intercept, ford walford slope param, do unfished or exploited equilib?)
#unfishspr<-function(predunfishspr=NULL,targzero=NULL,steep=NULL,numbs_weightb=NULL,annualnatmort=NULL,annualexploit=NULL,FWalpha=NULL,FWrho=NULL,unfishflag=NULL) {
#  #see delay-diff chapter of hilborn and walters and common pubs on steepness (Mangel et al 2010)
#  predrzero<-1/predunfishspr*targzero  #unfished recruitment=f(unfishedSSBR,unfished N or B specified by user
#  predalpha<-(4*steep*predrzero)/(5*steep-1) #alpha of BH SR #1/beta? alpha in Mangel et al 2010 is (targzero/predrzero)*((1-steep)/(4*steep)) #
#  predbeta<-((targzero/predrzero)*((1-steep)/(4*steep)))/((5*steep-1)/(4*steep*predrzero)) #beta of BH SR #alpha/beta? beta ibid (5*steep-1)/(4*steep*predrzero)
#  #predalpha<- (targzero/predrzero)*((1-steep)/(4*steep)) #direct from Mangel et al 2010
#  #predbeta<-(5*steep-1)/(4*steep*predrzero) #direct from Mangel et al 2010
#  if(numbs_weightb==1){ #solving in units of numbers or biomass
#    kappa<-1-(1-annualnatmort)*(1-annualexploit) #growth-survival constant (pg 339 Hilborn and Walters)
#    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium N
#    Ceq<-eqvalue*annualexploit #equilibrium catch
#    Req<-kappa*eqvalue #equilibrium recruitment
#    SSeq<-eqvalue-Ceq  #equilibrium spawning stock
#  } else {
#    kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/FWalpha  #growth-survival constant (pg 339 Hilborn and Walters)
#    #kappa<-((1-(1+FWrho)*(1-annualnatmort)*(1-annualexploit))+(FWrho*(1-annualnatmort)^2*(1-annualexploit)^2))/(Recwt-((Prerecwt*FWrho)*(1-annualnatmort)*(1-annualexploit)))
#    eqvalue<-(predalpha/kappa)-(predbeta/(1-annualexploit)) #equilibrium Biomass
#    Yeq<-eqvalue*annualexploit #equilibrium yield
#    Req<-kappa*eqvalue #equilibrium recruitment
#    SSeq<-eqvalue-Yeq #equilibrium spawning stock
#    Neq<-Req/(1-(1-annualnatmort)*(1-annualexploit)) #equilibrium N
#    Weq<-eqvalue/Neq #equilibrium average weight
#  }  
#  if(unfishflag==0){ #if doing unfished then just return unfished spr to optimize function; required for equlibrium calcs
#  return((targzero-eqvalue)^2)
#  } else { #if not doing unfished (exploit>0) then return various equilibrium values
#   if(numbs_weightb==1) { #units of numbers or biomass?
#     return(data.frame("Neq"=eqvalue,"Ceq"=Ceq,"Req"=Req,"SSeq"=SSeq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
#   }else {
#     return(data.frame("Beq"=eqvalue,"Yeq"=Yeq,"Req"=Req,"SSeq"=SSeq,"Neq"=Neq,"Weq"=Weq,"predrzero"=predrzero,"predalpha"=predalpha,"predbeta"=predbeta))
#   }
#  }
#}
#####end function unfishspr#####

#### Common Tern Gulf of Maine pars (see HerringMSEpredspars.xlsx for derivation

#numbs_weight  <-  1  #2 #1=numbers, else weight.  Will predator be tracked just in numbers or numbers and weight?  Weight allows for growth effects.
#Predzero      <-  45000 #5.90E+05 # #5.60E+09  #50000 #predator unfished total N or biomass
#Predsteep     <-  0.26 #0.25  #0.8 #predator steepness
#PredannualA   <-  0.1  #0.6 #predator annual natural mortality rate (0-1); serves as max if time varying
#Predexploit   <-  0.00  #0.3 #predator annual exploitation rate (0-1)
#FWalpha       <-  0.00015#1.5 #  #0.243 #ford-walford plot intercept parameter if doing biomass units tons
#FWrho         <-  0.0  #1.45 #ford-walford plot slope parameter if doing biomass units; serves as max if time varying

#PredN         <-  c() #for predator abundance vector
#PredN[1]      <-  3000  #7000 #initial abundance in year 1
#PredB         <-  c() #for predator biomass vector if doing in those units
#PredB[1]      <-  1.5  #6000 #initial biomass in year 1 
#PredRecdelay  <-  4  #1 #delay in years for when recruits in year y are added to population

preypredrec<-1.09 #strength of effect of prey N on predator recruitment (like Plaganyi and Butterworth) >=1; 1=no effect
#preyprednatm<-0 #strength of effect of prey N on predator annual natural mort (0-1) 0=no effect
#preypredgrow<-1 #strengh of effect of prey N on predator growth, >=1, 1=no effect
  
#COTEprodThresh<-400000

#####End user inputs########

#Do predator unfished equilibrium calculation and get unfished spr
predunfishsprfxn<-optimize(f=unfishspr,interval=c(0,50),targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=0,FWalpha=FWalpha,FWrho=FWrho,unfishflag=0,tol=0.0000001)
predunfishspr<-predunfishsprfxn$minimum
#send unfished spr through function again with an exploitation rate to get equlibrium conditions
PredEquilib<-unfishspr(predunfishspr=predunfishspr,targzero=Predzero,steep=Predsteep,numbs_weightb=numbs_weight,annualnatmort=PredannualA,annualexploit=Predexploit,FWalpha=FWalpha,FWrho=FWrho,unfishflag=1)
predalpha<-PredEquilib$predalpha #predator BH SR parm
predbeta<-PredEquilib$predbeta #predator BH SR parm
Req<-PredEquilib$Req
Weq<-PredEquilib$Weq
##############################################
#### Read in Herring "data"
#preyB<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111TotBioSimYear.txt", header=T)  
#preysim<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111NAASimYear.txt", header=T)
preyNsim<-transmute(preysim, preyN=Age1+Age2+Age3+Age4+Age5+Age6+Age7+Age8, Sim=Sim)
     
by_simN<-group_by(preyNsim, Sim)
Nyears<-summarise(by_simN, n=n())

#preychar<-read.table("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Unadj1111SimCharAA.txt", header=T)
#preychar<-cbind(preychar, Age=rep(1:8,max(preychar$Sim)))
#BASE ON TOTAL B
Ternforage<-cbind(preyB, Yr=rep(1:Nyears$n, max(preychar$Sim)))
h<-1
  preyN<-Ternforage$TotalBio[Ternforage$Sim==h]
  nyears<-Nyears$n[h]
  #preyNzero for terns is the threshold total B where prod drops, FIXED based on GOM data
  preyNzero<-COTEprodThresh

  ###predator dynamics###
  #stuff I need
  Recmult<-(preypredrec*(preyN/preyNzero))/((preypredrec-1)+(preyN/preyNzero)) #fraction of expected predator BH recruitment dependent on prey N
  PredAnnualNatM<-PredannualA*exp(-(preyN/preyNzero)*preyprednatm) #needed if annual nat mort is time varying
  TotalSurv<-(1-PredAnnualNatM)*(1-Predexploit) #total annual predator survival
  catch<-c()
  Spawn<-c() #spawners in numbers or biomass depending
  yield<-c()
  Predrec<-c()
  Predrec[1:PredRecdelay]<-Req #set recruitment in initial years at equlibrium to account for delay
  ###year loop for predator dynamics
  for(y in 1:(nyears-1)){
    if(numbs_weight==1){
        catch[y]<-PredN[y]*Predexploit
        Spawn[y]<-PredN[y]-catch[y]
      } else {
        yield[y]<-PredB[y]*Predexploit
        Spawn[y]<-PredB[y]-yield[y]
      }
      Predrec[y+PredRecdelay]<-Recmult[y]*((predalpha*Spawn[y])/(predbeta+Spawn[y])) #SR
      PredN[y+1]<-PredN[y]*TotalSurv[y]+Predrec[y+1]
      }  

simTern <- data.frame(yr=seq(1998,2015,1), PredN=PredN[6:23])

ternpoptrend +   geom_point() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  geom_point(data=simTern, aes(x=yr, y=PredN, colour="Simulated"))


```

## Groundfish
Because no specific groundfish was identified as a representative herring predator during the stakeholder workshop, the first decision was which groundfish to model. Annual diet estimates (based on sample sizes of ~100+ stomachs) are available for the top three groundfish predators of herring (those with herring occurring in the diets most often in the entire NEFSC food habits database): spiny dogfish, Atlantic cod, and silver hake. Cod and spiny dogfish were considered first because their overall diet proportions of herring are higher, and because silver hake has the least recently updated assessment. Diet compositions by year were estimated for spiny dogfish, Georges Bank cod, and Gulf of Maine cod to match the scale of stock assessments. Full weighted diet compositions were estimated, and suggest considerable interannual variability in the herring proportion in groundfish diets (filled blue proportions of bars in Fig. \ref{gfishdiets}).  

```{r,eval=sg_figs, fig.cap="Annual diet compositions for major groundfish predators of herring estimated from NEFSC food habits database \\label{gfishdiets}", message = FALSE, warning = FALSE}

#dogdiet   <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/GroundfishDat/dogfishdietcomp.csv")
#GBcoddiet <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/GroundfishDat/GBcoddietcomp.csv")
#GOMcoddiet <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/GroundfishDat/GOMcoddietcomp.csv")

names(dogdiet)[1]<-"Year"
names(GBcoddiet)[1]<-"Year" 
names(GOMcoddiet)[1]<-"Year"

dogdiet <- cbind(dogdiet, Pred=rep("dogfish", dim(dogdiet)[1]))
GBcoddiet <- cbind(GBcoddiet, Pred=rep("GBcod", dim(GBcoddiet)[1]))
GOMcoddiet <- cbind(GOMcoddiet, Pred=rep("GOMcod", dim(GOMcoddiet)[1]))

dogdiet <- gather(dogdiet, Prey, Percent, -Year, -Pred)
GBcoddiet <- gather(GBcoddiet, Prey, Percent, -Year, -Pred)
GOMcoddiet <- gather(GOMcoddiet, Prey, Percent, -Year, -Pred)

dogcoddiet <- bind_rows(dogdiet, GBcoddiet, GOMcoddiet)

dogcoddiet$fillwhite <- with(dogcoddiet, ifelse(Prey=="CLUHAR", 1,0))

compplot2 <- ggplot(dogcoddiet, aes(Year, Percent, colour=Prey)) + 
  geom_bar(stat = "identity", aes(fill=fillwhite)) 
  #geom_bar(stat = "identity") 

compplot2 + facet_wrap("Pred", nrow=3) + theme(legend.position="none")

```



Some interannual variation in diet may be explained by changing herring abundance. Dogfish and both cod stocks had positive relationships between the amount of herring observed in annual diets and the size of the herring population according to the most recent assessment (statistics and plots available upon request). This suggests that these groundfish predators are opportunistic, eating herring in proportion to their availability in the ecosystem. However, monotonically declining cod populations for both GOM and GB cod stocks resulted in either no herring-cod relationship, or a negative relationship between herring populations and cod populations (Fig. \ref{gfishBherrdiet}). Only dogfish spawning stock biomass had a positive relationship with the proporiton of herring in dogfish diet. Therefore, we selected dogfish as the groundfish predator for modeling.





```{r, eval=sg_figs, fig.cap="Relationship of assessed groundfish spawning stock biomass (SSB) with the proportion of herring in diet \\label{gfishBherrdiet}", out.width='400pt',message = FALSE, warning = FALSE}
#codGB<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GBcodpop.csv")
#codGOM<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMcodpop.csv")
#dogfish<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishpop.csv")
#gfishdiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Gfishdiets.csv")
#herring <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/herringassessout2015.csv")
#herring <- herring[,1:6]
#dogfishrec <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishrec.csv")

# add species column, tidy and combine datasets
codGB <- cbind(codGB, species=rep("GBcod", dim(codGB)[1]))
codGOM <- cbind(codGOM, species=rep("GOMcod", dim(codGOM)[1]))
dogfish <- cbind(dogfish, species=rep("dogfish", dim(dogfish)[1]))
dogfish <- full_join(dogfish, dogfishrec)

gfishdiet <- gfishdiet %>%
  gather(preypred, dietprop, 2:9) %>%
  separate(preypred, c("prey", "species"), sep="_")

codpops <- full_join(codGB, codGOM)
names(codpops)[1]<-"Yr"
names(dogfish)[2:12] <- c("LargeB", "MedB", "RecAge1t",
                          "TotJan1B","survSSB", "survSSB_MA","stocExpB",
                          "stocTotB", "stocSSB", "SSBkgtow", "SSB")
#put all in t not 1000t
dogfish <- dogfish %>%
  mutate_at(vars(LargeB, MedB, RecAge1t,TotJan1B, survSSB, survSSB_MA,
                 stocExpB, stocTotB, stocSSB, SSB),
            funs(.*1000))

dogfish <- dogfish %>%
  mutate(RecAge1 = RecAge1t/PupAvgWtkg) %>% #rec in 1000 fish matches cod units
  mutate(TotJan1B = replace(TotJan1B, TotJan1B==0, NA)) #2014 missed survey

gfishpops <- full_join(codpops, dogfish)

#merge fishpops and fish diets
gfishpopfood <- left_join(gfishpops, gfishdiet, by=c("Yr"="Year", "species"="species"))

gfishpopfood <- filter(gfishpopfood, !is.na(prey)) 

gfishSSBdiet <- ggplot(gfishpopfood, aes(x=dietprop, y=SSB, colour=prey)) + 
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1) 
gfishSSBdiet + facet_wrap(~species)


```

### Dogfish population model
The dogfish model stock recruitment function, initial population, and annual natural mortality were adapted from information in [@rago_implications_1998; @rago_biological_2010; @bubley_reassessment_2012; @rago_update_2013]. Due to differential growth and fishing mortality by sex, our model best represents female dogfish (a split-sex delay difference model was not feasible within the time constraints of this MSE). Further, dogfish stock-recruit modeling to date based on Ricker functions [@rago_biological_2010] captures more nuances in productivity than the Beverton-Holt model we used. Our recruitment parameterization reflects a stock with generally low productivity and relatively high resilience, which we recognize is a rough approximation for a species such as dogfish. The annual fishing exploitation rate applied is average of the catch/adult female biomass from the most recent years of the 2016 data update provided to the Mid-Atlantic Fishery Management Council (Rago pers comm). 

### Herring-dogfish relationship model
There was a weak positive relationship between dogfish total biomass and herring total biomass from the respective stock assessments (Fig. \ref{pupherring}), but no clear relationship between dogfish weight or dogfish recruitment and herring population size. During the recent period of relatively low dogfish recruitment (1995-2007), there is a positive relationship between dogfish pup average weight and herring proportion in diet, suggesting a potential growth and or recruitment mechanism; however this relationship does not hold throughout the time series (Fig. \ref{pupherring}). 


```{r, eval=sg_figs, fig.cap="Dogfish population relationships with herring total biomass (left) and herring proportion in diet (right) \\label{pupherring}", out.width='.49\\linewidth', fig.show='hold', fig.align='center', message = FALSE, warning = FALSE}
#codGB<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GBcodpop.csv")
#codGOM<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/GOMcodpop.csv")
#dogfish<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishpop.csv")
#gfishdiet<-read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/Gfishdiets.csv")
#herring <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/herringassessout2015.csv")
#herring <- herring[,1:6]
#dogfishrec <- read.csv("/Users/sgaichas/Documents/0_Data/MSE/HerringMSE/dogfishrec.csv")

# add species column, tidy and combine datasets
#codGB <- cbind(codGB, species=rep("GBcod", dim(codGB)[1]))
#codGOM <- cbind(codGOM, species=rep("GOMcod", dim(codGOM)[1]))
#dogfish <- cbind(dogfish, species=rep("dogfish", dim(dogfish)[1]))
#dogfish <- full_join(dogfish, dogfishrec)

#gfishdiet <- gfishdiet %>%
#  gather(preypred, dietprop, 2:9) %>%
#  separate(preypred, c("prey", "species"), sep="_")

#codpops <- full_join(codGB, codGOM)
#names(codpops)[1]<-"Yr"
#names(dogfish)[2:12] <- c("LargeB", "MedB", "RecAge1t",
#                          "TotJan1B","survSSB", "survSSB_MA","stocExpB",
#                          "stocTotB", "stocSSB", "SSBkgtow", "SSB")
#put all in t not 1000t
#dogfish <- dogfish %>%
#  mutate_at(vars(LargeB, MedB, RecAge1t,TotJan1B, survSSB, survSSB_MA,
#                 stocExpB, stocTotB, stocSSB, SSB),
#            funs(.*1000))

#dogfish <- dogfish %>%
#  mutate(RecAge1 = RecAge1t/PupAvgWtkg) %>% #rec in 1000 fish matches cod units
#  mutate(TotJan1B = replace(TotJan1B, TotJan1B==0, NA)) #2014 missed survey

#gfishpops <- full_join(codpops, dogfish)

#merge fishpops and fish diets
gfishpopfood <- left_join(gfishpops, gfishdiet, by=c("Yr"="Year", "species"="species"))
gfishpopfood <- filter(gfishpopfood, !is.na(prey)) 
# merge herring assessment out with gfish
gfishpopfoodherr <- left_join(gfishpopfood, herring, by=c("Yr"="yr"))

#Dogfish population model
dogfishfoodherr <- gfishpopfoodherr %>%
  filter(species=="dogfish") 

#dogfishpoptrend <- ggplot(dogfishfoodherr, aes(x=Yr, y=TotJan1B)) + geom_point()
#dogfishdiet <- ggplot(dogfishfoodherr, aes(x=Yr, y=dietprop, colour=prey)) + geom_point()
pupwtdiet <- ggplot(dogfishfoodherr, aes(x=dietprop, y=PupAvgWtkg, colour=prey)) + geom_point() + ggtitle("Dogfish pup average weights 1980-2009")
#Fwtdiet <- ggplot(dogfishfoodherr, aes(x=dietprop, y=FAvgWtkg, colour=prey)) + geom_point()

dogfishlow <- dogfishfoodherr %>%
  filter(Yr>1994 & Yr<2008)

#lowdogfishdiet <- ggplot(dogfishlow, aes(x=Yr, y=dietprop, colour=prey)) + geom_point()
lowpupwtdiet <- ggplot(dogfishlow, aes(x=dietprop, y=PupAvgWtkg, colour=prey)) + geom_point() + ggtitle("Dogfish pup average weights 1995-2007")
#lowFwtdiet <- ggplot(dogfishlow, aes(x=dietprop, y=FAvgWtkg, colour=prey)) + geom_point()

#lowpupwtdiet #+ stat_smooth(method = "lm", formula = y ~ x, size = 1)
#pupwtdiet #+ stat_smooth(method = "lm", formula = y ~ x, size = 1)

#pup wt was higher earlier in the time series when herring low
#pupwttrend <- ggplot(dogfishfoodherr, aes(x=Yr, y=PupAvgWtkg)) + geom_point() + ggtitle("Dogfish average pup weight from NEFSC surveys")

#positive relationship between populations but weak
dogherrB <- ggplot(dogfishfoodherr, aes(x=HerringTotalB, y=TotJan1B)) +
  geom_point() +
  ggtitle("Dogfish total biomass 1968-2016")
#stat_smooth(method = "loess", formula = y ~ x, size = 1) + 
#stat_smooth(method = "lm", formula = y ~ x, size = 1)

dogherrB
pupwtdiet
```



Therefore, to simulate a potential positive relationship between herring and dogfish, we assumed that dogfish survival increased (natural mortality was reduced) by an unspecified mechanism as herring abundance increased (Fig. \ref{herringdogfish}). Because dogfish are fully exploited by fisheries in this model, the impact of this change in natural mortality on total survival has small to moderate benefits to dogfish population numbers and biomass. Using a $\delta$ = 0.2 in equation \ref{varmort_equation} results in weak increases in dogfish biomass with herring abundance consistent with observations.



```{r, eval=sg_figs, fig.cap="Modeled herring relative population size-dogfish natural mortality relationship \\label{herringdogfish}", out.width='300pt', message = FALSE, warning = FALSE}
# from MSE_GroundfishLink.R
PredannualA   <-  0.092  #0.6 #predator annual natural mortality rate (0-1); serves as max if time varying
Predexploit   <-  0.092  #0.3 #predator annual exploitation rate (0-1)
preyprednatm<-0.2 #strength of effect of prey N on predator annual natural mort (0-1) 0=no effect

preypopratio  <-  seq(0,2,by=0.01) # standing in for preyN/preyNzero
PredAnnualNatM   <-  c()

PredAnnualNatM<-PredannualA*exp(-(preypopratio)*preyprednatm) 

qplot(preypopratio, PredAnnualNatM, geom="line", xlab = "current herring abundance / unfished herring abundance", ylab = "dogfish annual natural mortality v") 

#TotalSurv<-(1-PredAnnualNatM)*(1-Predexploit) #total annual predator survival

```
## Marine mammals
Because no specific marine mammal was identified as a representative herring predator in the stakeholder workshop, as with groundfish, the first decision was which marine mammal to model. Diet information for a wide range of marine mammals on the Northeast US shelf suggests that minke whales, humpback whales, harbor seals, and harbor porpoises have the highest proportions of herring in their diets [@smith_consumption_2015], and therefore may show some reaction to changes in the herring ABC control rule. 

While some food habits data existed for marine mammals, consultation with marine mammal stock assessment scientists at the Northeast Fisheries Science Center confirmed that no data were available to parameterize a stock-recruitment relationship for any of these marine mammal species in the Northeast US region, and no such information was available in the literature for stocks in this region. Althouth it may be possible to develop stock-recruitment models for one or more of these species in the future, it was not possible within the time frame of the herring MSE. Therefore, we were unable to model marine mammals within the same framework as other predators. 

Potential effects of changes in herring production and/or biomass on marine mammals were instead evaluated using an updated version of an existing food web model for the Gulf of Maine [@link_northeast_2008; @link_response_2009; @link_documentation_2006] and incorporating food web model parameter uncertainty. Overall, food web modeling showed that a simulated increase in herring production in the Gulf of Maine may produce modest but uncertain benefits to marine mammal predators, primarily because increased herring was associated with decreases in other forage groups also preyed on by marine mammals. Please see Appendix 1 of this document for full analyses and results. 

## Summary of predator model input parameters
Table 2. Predator model input parameters
```{r pars, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| Parameter                | Tuna         | Tern         | Dogfish      |
|:-------------------------|:-------------|:-------------|:-------------|
| Numbers or Weight?       | Weight       | Numbers      | Weight       |
| Unfished spawning pop    | 6.69E+04     | 45000        | 300000       |
| Steepness *h*            | 1.0          | 0.26         | 0.97         |
| Annual nat. mortality *v*| 0.14         | 0.1          | 0.092        |
| Annual exploitation *u*  | 0.079        | 0.00         | 0.092        |
| Growth intercept *FWint* | 0.020605     | 0.00015      | 0.000278     |
| Growth slope *FWslope *  | 0.9675       | 0.0          | 0.9577       |
| Initial abundance        | 111864       | 3000         | 49629630     |
| Initial biomass          | 27966        | 1.5          | 134000       |
| Recruit delay (age) *a*  | 1            | 4            | 10           |
| Prey-recruitment link    | 1 (off)      | 1.09         | 1 (off)      |
| Prey-mortality link      | 0 (off)      | 0 (off)      | 0.2          |
| Prey-growth link         | 1.1          | 1 (off)      | 1 (off)      |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```
##**Performance Metrics**

**Herring**

For each combination of control rule shape and operating model, 100 simulations were conducted, each for 150 years.  Preliminary simulations suggested that this number of simulations and years was sufficient for results to be insensitive to starting conditions and short-term dynamics caused by auto-correlated processes.  Median SSB,  $\frac{SSB}{SSB_{F=0}}$,  $\frac{SSB}{SSB_{MSY}}$, *yield*, $\frac{yield}{MSY}$, biomass of herring dying due to M, and the proportion of the herring population comprised of age-1 fish over the last 50 years of each simulation were recorded as performance metrics.  Additional performance metrics included the proportion of the last 50 years of each simulation with $SSB < SSB_{MSY}$, $SSB < \frac{SSB_{MSY}}{2}$ (i.e., proportion of the last 50 years that are overfished), $SSB < 0.3SSB_{F=0}$, $SSB < 0.75SSB_{F=0}$, fully-selected $F > F_{MSY}$ (i.e., proportion of the last 50 years that overfishing occurred), and *Q*=0 (i.e., proportion of the last 50 years that the fishery was closed).  Interannual variation in yield (*IAV*) was also recorded over the last 50 years of each simulation (Table XX T10):
\begin{equation}
IAV=\frac{\sqrt{\frac{1}{50}\sum\limits_{y=1}^{50}(Y_{y+1}-Y_{y})^2}}{(\frac{1}{50}\sum\limits_{y=1}^{50}Y_y)}.
\end{equation}

These performance metrics were highlighted to be of interest at the stakeholder workshops.  

**Predators**
Predator performance metrics included those described at the stakeholder workshop, as well as several others drawn from MSE best practices [@punt_management_2016]. Each of the simulated herring time series for every operating model, control rule, and simulation was passed to each predator model, resulting in outputs as described below using the equations above.

All predator performance metrics were calculated based on the final 50 years of each replicate simulation. For all metrics other than "frequency of good status" metrics, we took the median value over the final 50 years of each replicate simulation. Then, the 25th percentile, the median, and the 75th percentile of these 100 medians were calcualted to represent the performance metric for a particular control rule. Results reported here focus on the median.

### Biomass, Abundance, Recruitment
Population abundance and recruitment in numbers were output for all modeled predators. Population biomass was output for tuna and dogfish. These quantities were directly output by the models.

### Predator condition
Stakeholders expressed interest in predator condition for fish and marine mammal predators at the first workshop. While delay difference models do not track individuals or age cohorts, a measure of population average weight (population biomass/population numbers) was output for tuna and dogfish. 

### Predator productivity
Productivity, the number of fledglings per breeding pair, was output for the tern model. Productivity was calculated as recruitment times 10 (to account for the 10% survival rate of fledglings to adults) divided by tern abundance 4 years earlier in the simulation. 

### Status relative to thresholds
Stakeholders were interested in different measures of population status depending on the predator. For commercially fished species, status relative to current management reference points was preferred. Tuna and dogfish biomass was divided by a biomass reference point specified in current stock assessments: tuna $SSB_{MSY}^P$ was 13226 [@iccat_report_2015], and dogfish $SSB_{MSY}^P$ was 159288 [@rago_biological_2010]. Because dogfish were fully exploited in our model, they did not reach $SSB_{MSY}^P$, so we also evaluated status relative to 0.5 $SSB_{MSY}^P$ ("overfished"). Tuna condition status was assessed by dividing the output population average weight with the equilibrium average weight. Common tern colonies are managed to improve productivity, so stakeholders suggested that a common tern productivity level of 0.8 would be a minimum threshold, while a productivity of 1.0 would be a target. In addition, total population status was measured relative to current population numbers using the rationale that maintaining at least the current population was desirable. The average common tern population of nesting pairs (including Monomoy) from 1998-2015 was 16000. 

### Frequency of good status
Evaluating the frequency of desirable or undesirable states over the course of a simulation is suggested by @punt_management_2016. We calculated two metrics for each of the status determinations. First, we calculated the minimum number of years in any individual simulation that a metric was above a given threshold. This is a "worst case scenario" metric. Second, we calculated the median proportion of years across all simulations for a control rule that were above the threshold. This is an "average performance" metric addressing how often good status is maintained.

**An Economic Model of the Predators**

We didn't do one.

**An Economic Model of the Herring Fishery** 

*Basics and Intro--*
There are many economic methods that can inform ecosystem approaches to fisheries management[^a].  @Kirkley2011AConsiderations use a static input-output model to simulate the effects of changes in herring quotas and predator biomass levels on the New England economy. Their analysis suggested that the effects of changes in herring catch on other segments of the economy are quite small; we, therefore confined the analysis to the herring fleet. @Lehuta2013InvestigatingEngland also construct an coupled ecological-economic model of herring under the assumption of competitive output markets for herring and zero economic profit.  We did not make this assumption.  

[^a]: @Edwards2004PortfolioStocks and @Jin2016ApplyingEBFM illustrate a portfolio approach. @Jin2003LinkingEcosystem and @Jin2012DevelopmentEngland link regional economic models to ecosystem models. @Tschirhart2000GeneralEcosystem and @Finnoff2003HarvestingEcosystem link structural economic models of constrained optimization to ecosystem models.  

The economic model of the herring fishery converts \textit{yield} from the herring component into Gross Revenues (GR) and Net Operating Revenues (NR).  There are two fleets,trawl and purse seine, that are assumed to have the ability to catch 70 and 30% of the \textit{yield} respectively[^c].  The midwater trawl, paired midwater trawl, and bottom trawl are all aggregated into the trawl fleet. Gross Revenue, Net Revenue, and the constraints on harvest can be represented as ($y$ subscripts omitted here for simplicity):

[^c]: The fishery is managed with four sub-ACLs and the purse seine fleet can only fish in one of the four areas.  This  70/30 split corresponds to recent history.

\begin{align}
GR&=p(q^t+q^s)q^t+p(q^t+q^s)q^s\\
NR&=GR-c^t(q^t)-c^s(q^s)
\end{align}
where $q^i$ is the quantity landed for fleet $i$, $c^i(q^i)$ is cost function for fleet $i$, and $p(\cdot)$ is a function that relates total landings to prices.  
\begin{align}
\label{optimization_problem}
\max_{q_i} NR^i&=p(q^t+q^s)q^i - c^i(q^i)\\
q^s &\leq .3yield; \hspace{2mm} q^t \leq .7yield 
\end{align}
The optimization problem in equation \ref{optimization_problem} contains two embedded assumptions: total catch is less than or equal to Yield and that a fleet may  catching less than it's fraction of yield (presumably because it may be more profitable to select a lower level of landings).

*Production and Costs--*
Economic data collected from 2011-2015 by the Northest Fisheries Observer Program (NEFOP) are used to construct average daily costs for the trawl and purse seine fleets.  Fuel prices were much lower in 2011-2014 compared to 2015. We adjusted fuel prices to the 2011-2014 average; sensitivity analysis was performed by settting fuel prices to the 2015 levels but results not reported here.  Other costs of fishing included water, oil, and damage costs. Crew pay and fixed costs were not included.  

We construct average catch per day fished for each fleet from the Vessel Trip Report databases over the same time period.  The trip lengths in the VTR and observer data were very similar. This allows us to construct the average cost of catching a metric ton of herring for the trawl and purse seine fleet ($c^t$ and $c^s$ respectively).  We assume that the average cost is equal to the marginal cost for each fleet.  These figures are presented in Table \ref{costs_combined}.

\begin{table}[htpb]
\begin{centering}
\begin{tabular}{l r r r r r r r r}\hline
	&	Marginal &Catch &	Trip length&\multicolumn{3}{c}{Cost per day}	&	Observed	&	VTR	\\
Year	&	Cost (\$/mt)& (mt/day) &days	&	Low	&	High	&	Raw	&	 trips	&	 trips	\\\hline
Seine	&	14.27 & 87.5& 1.0&	1,249	&	1,664	&	1,396	&	207	&	1,413	\\
Trawl	&	62.43 & 61.4	&2.9&	3,833	&	5,009	&	4,315	&	573	&	2,005	\\\hline
\end{tabular}
\caption{Marginal cost of 1mt of herring, daily catch, trip length, and cost per day for the purse seine and trawl fleets averaged over 2011-2015. \label{costs_combined}}
\end{centering}
\end{table}


*Prices--*
Annual prices were constructed from NMFS dealer data for 1982 through 2016[^d]. Annual landings were constructed from the processed ME DMR landings dataset for the same time period.  Exploratory analysis suggested both a regime change in the mid-1990s and likely non-stationarity of both landings and prices.  We used the Bounds testing methodology developed by @Pesaran2001BoundsRelationships test for a long-run relationship between prices and quantities. This method does not require pretesting for stationarity; however, the test statistic does have an inconclusive zone in which knowledge of stationarity would required. A long-run relationship between prices and landings can be modeled as:

[^d]: Prices have been normalized to 2015 real dollars using the Bureau of Labor Statistics (BLS) Producer Price Index (PPI) for Unprocessed and Packaged Fish (WPU0223). Because Atlantic Herring was not federally managed prior to the implementation of the Herring FMP in 2000; the NMFS dealer databases may not contain all landings prior to this time. The ME DMR data do not contain prices but is a census of landings.

\begin{equation}
\label{ARDL}
p_{y}= c+\sum_{i=1}^p a_i p_{t-i}+ \sum_{i=0}^n b_i q_{y-i} + e_{t},
\end{equation}
or equivalently as an error correction model (ECM):

\begin{equation}
\label{ECM}
\Delta p_y= \gamma+ \alpha_1 p_{y-1} + \sum_{i=1}^p \theta_i \Delta p_{y-i}+ \sum_{i=0}^n  \beta_i \Delta q_{y-i} + e_{y},
\end{equation}
where $\Delta$ is the first-differences operator [@Pesaran2001BoundsRelationships]. The $\gamma$ parameter must also be restricted ($\gamma=c / \alpha_1$) for these equations \ref{ARDL} and \ref{ECM} to be equivalent.  @Pesaran2001BoundsRelationships tests the null of no long-run relationship using a joint F-test that the $\alpha_1$ and $\beta_i$ parameters in equation \ref{ECM} are non-zero; however, the F-statistic has a non-standard distribution with an inconclusive area.

Equation \ref{ECM} was first estimated on the full 1982-2015 dataset; model selection criteria indicated (p=4,n=0) was preferred and that prices were not affected by quantities.  We suspect this is likely caused by a combination of overfitting of the model and a regimes shift evident in the exploratory graphs. Rather than explore a regime switching model, we simply estimated equation \ref{ECM} with $p=1, n=0$ on a subset of the data (1995-2015).  If there was a regime shift, the current regime is more likely to be similar to the future.  Models estimated in natural logarithms and in levels fit well. The PSS F-statistics of 9.34 and 10.20 are above the upper critical value, strongly suggesting a long-run relationship between prices and quantities[^e] (Table \ref{ardl_regression}).  We also present the results of the ARDL(1,0) formulation because it is a bit easier to interpret. Coefficients from the ``level'' equation (Column 1 of Table \ref{ardl_regression}) are used in the simulation. 

\begin{table}[htbp]
\begin{center}
\begin{tabular}{lcc} \hline
Model		&	(1) &	(2) 	\\
	&	price &	\textit{ln} price	\\\hline
Price$_{t-1}$		&	0.646***	&	0.666***	\\
		&	-0.0937	&	-0.0935	\\
Quantity		&	-1.194***	&	-0.395***	\\
		&	-0.277	&	-0.0956	\\
Constant		&	217.8***	&	6.423***	\\
		&	-48.16	&	-1.484	\\
Observations		&	21	&	21	\\
R-squared		&	0.906	&	0.906	\\
BGp		&	0.34	&	0.547	\\
BGF		&	1	&	0.4	\\
PSS	F-statistic	&	10.2	&	9.34	\\\hline
1\% Critical values &\multicolumn{2}{c}{[6.84, 7.84]} \\\hline
\multicolumn{3}{c}{ Standard errors in parentheses} \\
\multicolumn{3}{c}{ *** p$<$0.01, ** p$<$0.05, * p$<$0.1} \\\hline
\end{tabular}
\caption{Regression results from the ``ARDL'' specification (Equation \ref{ARDL}), PSS Bounds test and associated critical values.  1995-2015 data only. The explanatory variables enter in levels in the first column and natural logarithms in the second column.  \label{ardl_regression}}
\end{center}
\end{table}

[^e]:As a robustness check, we also tried varying the first (1996) and last (2016) year included in the dataset.  This did not change the estimated results substantially. We also estimated a short-run relationship between prices and quantities in which $\Delta p_y$ was regressed on $\Delta q_y$.  The short-run effects were qualitatively similar to the "long-run" model in Table \ref{ardl_regression}.  


<!-- 
MY's code for running regressions is here: /home/mlee/Documents/Herring_PDT_work/Amendment8/MSE_ABC/price_things/  herring_realprice_timeseries.do  herring_realprice_timeseries2.do
-->

*Net Operating Revenues--*
The simulation of Gross operating revenues occurs in a few steps.  Herring prices in a year are simulated using equations \ref{optimization_problem} and \ref{ARDL}, parameters from Table \ref{ardl_regression} previous year prices (initialized to the 2011-2015 average for the first year) under the assumption that both fleets combine to land the entire Yield.  If simulated prices are higher than the marginal cost of the trawl fleet($63.24/mt), both fleets are assumed to catch the entire Yield.  Otherwise, we use equations \ref{optimization_problem} and \ref{ARDL} to solve for quantity landed by the trawl fleet when the purse seine fleet lands 30% of yield. If it optimal for the trawl fishery to land nothing, we use equations \ref{optimization_problem} and \ref{ARDL} to find the purse seine's optimal amount of landings[^f]. Net revenues to the fishery can then be calculated directly from equation \ref{optimization_problem}.

[^f]: Because the marginal costs for the purse seine are always less than the marginal costs of the trawl fishery, any landings by the trawl fleet imply the purse seine fleet is landing 30% of the yield.  

*Stability --*
Stakeholders were interested in understanding stability of the herring industry. We computed Interannual Variation (IAV) of Net Revenues. While IAV can summarize variability, it does not provide insight into the equilibrium properties of the time series.  An additional performance metric, stationarity, is used to assess the stability of net revenues over the terminal period. For each simulation, we perform an econometric test of stationarity [@Dickey1979DistributionRoot], by estimating 

\begin{equation}
\label{DF_estimated}
\Delta NR_{y} = \beta  NR_{y-1} + \xi_1 \Delta NR_{y-1} + \varepsilon 
\end{equation}
for each simulation. Econometric evidence that $\beta=0$ is evidence of a unit root (nonstationarity) while statistical rejections of $H_0: \beta=0$ in favor of $H_A: \beta<0$ is evidence of stationarity of the time-series.  The results of these tests are summarized in two ways. First, we use techniques from the unweighted Z-transform method from the meta-analysis literature to combine the results of these simulations [@stouffer1949american; @Whitlock2005CombiningApproach]. This allows for a test of the  null hypothesis that a particular control rule implemented on a particular operating model does not produce a stable equilibrium. Defining $\phi$ as the standard normal cumulative distribution function, we construct:
\begin{align}
Z  &= \frac{\sum_{i=1}^k \phi^{-1} (1-p_i)}{\sqrt(k)}
\end{align}
$Z$ has a standard normal distribution under the null hypothesis of no stable equilibrium.  We report the p-value associated with rejecting the null that particular control rule leads to non-stationary trajectory of revenue; small values are evidence of a stable equilbrium.  Second, we classify a particular simulation as stationary if we reject the null $H_0: \beta=0$ in favor of $H_A: \beta<0$ at the 10% significance level and  report the percentage of simulations that are stationary; large values are evidence of a stable equilibrium.

<!---
Comment out economic crap.
Two economic models were recently developed that focused on herring in the Northeast United States. ,
through the intermediary of the extractive herring sector. The authors
take an optimization approach: herring landings are selected to maximize
output.

There are two drawbacks to this approach. First, because the model is static, the effects of changes in commercial herring removals on predators (through changes in herring biomass) cannot be deduced. The dynamic ecosystem models developed address this particular shortcoming. Second, constant prices for herring are assumed; this assumption is relaxed as well. %THIS IS 
Neither approaches examine the value of increased herring biomass on other fisheries
STUFF FROM THE KIRKLEY AND LEHUTA CITATIONS

A key factor in management performance is the process by which  management tools are developed and implemented.

One approach to the creation of regulatory legitimacy is to structure the management process around user participation in decision-making. User participation addresses the twin problems of integrating human  and ecological systems and bringing individual users into the  definition of the collective good. Participation offers certain  benefits to the management process but it also carries costs. Whether  it is worthwhile for fishery management depends on the relative  magnitudes of those benefits and costs. [@Hanna1995UserCouncil]

What we ask of fishery governance is that it coordinate institutional  rules and individual actions by performing certain functions: incorporate multiple objectives representing different types of  conservation and use; bring the time horizons of private individuals  into line with those of the public; send signals of resource scarcity  and enable effective adaptive responses; promote legitimacy by  reflecting accepted norms of equity and by controlling harmful  opportunism; contain both the level and distribution of transactions  costs.These functions are expressions of Williamson's organizational  imperative to minimize costs, accommodate limited information, and  safeguard against harmful opportunism.
 [@Hanna1999StrengtheningResources]


Fishery management must, among other things, incorporate multiple objectives, promote legitimacy by reflecting accepted norms, and have low transactions costs [@Hanna1999StrengtheningResources]. User participation in decision-making is a way to increase regulatory legitimacy [@Hanna1995UserCouncil]. One drawback to user-participation is that meetings tend to attract participants with the most extreme views [@Osborne2000MeetingsParticipation; @Turner2005MeetingsAnalysis].
-->
-------------------------------

#Results
Stakeholders had wide-ranging, diverse, and often conflicting preferences. One of our first findings is that there often weaker tradeoffs than anticipated.  For example, the XXX for Dogfish, tuna, and XXX were relatively insensitive to both Operating Model and HCR type (Figure YAY). Other performance metrics were highly related to each other, like Net Revenue and Yield/MSY (Figure XY-scatter).  

As second finding was that two classes of control rules (Constant Catch and the 3-year biomass based with a limit on adjustment) performed poorly relative to the other control rules.  Here’s a few results that illustrate that finding (Figure ZZZ). Perhaps stationarity goes here?
**Effects of Operating Models**

The effect of growth on the relative performance of control rules was relatively minor for all metrics than the effect of *M* and steepness (INSERT A PLOT - maybe boxplot among all CRs?).  Furthermore, performance of control rules was similar between the operating models with different *M* and steepness values when reported relative to biological reference points (e.g., $\frac{SSB}{SSB_{MSY}}$, $\frac{yield}{MSY}$), but the scale of results in absolute values was generally different (INSERT PLOT).  Consequently, results were only reported in relative units for the low *M*/high steepness, and slow growth operating model, with the understanding that the operating models differ in meaningful ways (e.g., different *MSY*) if metrics are reported in absolute units.

Positive bias in assessment errors resulted in more control rules that led to lower amounts of biomass, more frequent biomass levels below $SSB_{MSY}$, higher *IAV*, but a generally similar range of yield (BOXPLOT).  ##Perhaps also add summary effect and boxplot for predator and econ metrics##.  For the sake of brevity, additional results and tradeoffs (see below) were only reported using an unbiased assessment error operating model.

**Tradeoffs**

*Herring*

Several of the herring performance metrics were redundant and exhibited similar tradeoffs.  So, only a few tradeoffs that are commonly of interest were reported.  Namely, $\frac{yield}{MSY}$ vs. $\frac{SSB}{SSB_{MSY}}$, $\frac{yield}{MSY}$ vs. *IAV*, $\frac{yield}{MSY}$ vs. the frequncy that *Q*=0, and $\frac{yield}{MSY}$ vs. the frequncy that $SSB < \frac{SSB_{MSY}}{2}$.

Biomass based control rule variants without a restriction on interannual change in the quota provided a broader range of $yield$ and $SSB$ than other control rules ().  At similar levels of yield, using three or five year blocks for the biomass based control rule produced more control rule shapes with less $SSB$, such that the short-term stability of such quota blocks comes at the potential cost of less $SSB$.

Biomass based control rule variants without a restriction on interannual change in the quota provided a broader range of $yield$ and *IAV* than other control rules (). Restricting the interannual change in the quota for the biomass based control rule or using one of the constant catch variants produced options with lower *IAV* than the biomass based alternatives, but biomass based options were available that could attain higher yields that the other control rules could not.  Thus, restricting the interannual change in the quota or using constant catch variants can produce more stable yields than alternatives, but at the cost of yield.

Tradeoffs for $\frac{yield}{MSY}$ vs. the frequncy that *Q*=0 were similar to that of $\frac{yield}{MSY}$ vs. *IAV*.  Biomass based control rule variants without a restriction on interannual change in the quota provided a broader range of results than other control rule alternatives.  Restricting the interannual change in the quota for the biomass based control rule or using one of the constant catch variants produced less, and often no fishery closures, that could not be achieved by the biomass based control rules, but at the cost of not offering options that could achieve yields as high as biomass based control rules.

All of the control rule alternatives offered options that had near zero frequency of $SSB < \frac{SSB_{MSY}}{2}$.  At similar levels of yield, using three or five year blocks for the biomass based control rule produced more control rule shapes with higher frequency of $SSB < \frac{SSB_{MSY}}{2}$, such that the short-term stability of such quota blocks comes at the potential cost of more frequently dropping to relatively low levels of biomass.  While restricting the interannual change in the quota or using one of the constant catch variants offered options that had near zero frequency of $SSB <\frac{SSB_{MSY}}{2}$, these options could not achieve as high of yield as biomass based options that also had near zero frequency of $SSB <\frac{SSB_{MSY}}{2}$.  Some constant catch options also had near 100% frequency of $SSB <\frac{SSB_{MSY}}{2}$.

#Discussion

Relative results insensitive to OM, which has been found before.

CC options not flexible and can usually be outperformed by other CRs, unless stability is a heavily preferred objective.

We only evaluated a 15% restriction on interannual change in the quote for a BB control rule because this was a value preferred by stakeholders.  Exploring a broader range of percentages, however, may result in a broader range of performance that may sacrfice less yield (than our 15%) but still gain some stability.  See Laurie Kell's stuff; Deroba and Bence.

If short-term stability is an objective, then using quota blocks may be effective.  Some BB CR options with quota blocks could produce similar performance as annual changes in the quota.  Although, at similar level of yields, the quota blocks produced more options with lower biomass.  Thus, a closed-loop simulation should be used to evaluate the changes in relative performance between applying a CR annually or using a quota blocks.

We assumed reference points were known without error, and so our results may not generalize to cases where such values are poorly estimated.  Incorporating error in the estimation of reference points within simulations is an area of active research, but is not straightforward.  For example, the reference points (e.g., MSY) depend on life history traits that may change through time, and so how to accommodate time varying life history in the calculation of the reference values would need to be considered as part of a management strategy.  See Deroba and Bence.

We did not incorporate a full stock assessment due to time contraints.  Discuss pros and cons; this is part of the reality and dream, as is the above paragraph.

MICE can be a reasonable approach to conducting science to meet relatively short managment time frames.  Scientists may have to sacrifice some dreams in order to meet realities of doing research in support of managment.  Review other MICE literature.  Discuss MICE in the context of multi-species/ecosystemy based management, and whether this even qualifies as ecosystem based.

Dive into the "forage" fish debate!?  While herring may constitute "large" fractions of diet, our population level analyses suggest only relatively weak relationships.  Likely due to alternative prey.  Herring abundance may also not be the most important aspect for predators, as their condition seems to be more directly linked to tuna condition, and tuna condition has been good at low herring N and visa versa.

An open stakeholder driven process produced dividends for this analysis in the form of improved relationships and data.  Greater attention should be paid to what stakeholders are involved and how they are involved in MSE processes.  Probably leave a short paragraph assuming Feeney et al. accepted.

Econ something.  Sorry M-Y, but that's the best I can do getting started on Econ discussion topics.

If we care about herring as forage, then including herring biomass is effectively double counting.  Alternatively, it suggests that something was left out of the ecosystem model.  <!---ML will tighten up -->


## The Dream
In this section, we discuss the limitations of the quantiative models and simplifications necessary to meet decision-making time frames while incorporating ecosystem and economic models into management strategy evaluation.


### Economics
<!---ML will tighten these up a bit. -->
We did not include fixed costs. If firms do not enter or exit, then the exclusion of fixed costs from the model has minimal qualitative effects. The stationarity metric would be unaffected; however, IAV constructed without fixed costs will be smaller than the true IAV that contains fixed costs. A bigger problem is that, in the long run, firms can enter and exit this industry.  If firms can enter and exit, then exclusion of fixed costs from the model could result in misleading recommendations. We did not model firm entry and exit; this is a difficult decision to model. Economic theory suggests that firms will enter (exit) if they anticipate large positive (negative) profits over a particular planning horizon; however, understanding exactly how these decisions are made was not possible.  Less than three-quarters of the permitted herring vessels were active in the fishery, suggesting that firms could enter if future profitability is expected to be high.

We also assume that marginal costs are equal to average variable costs, constant for each fleet, and do not depend on the level of biomass. A more rigorous approach might include estimating a (economic) production function for the herring fishery; this was not done in the interest of time.  It is difficult to predict how estimating a true cost function and integrating those results would change the results of the study.

Catch in the economic model can be different from the yield (from the herring model). This is frequently handled as symmetric implimentation error in the fisheries literature (as it is in this model). However, the market model suggests that this is not so simple.

The largest limitation of the economic component of the model is that only the herring fishery is quantitatively modeled. Consumers of landed herring and economic valuation of \textit{in-situ} herring are not considered.    

Equation \ref{ARDL} estimates a price-quantity relationship, not necessarily a demand curve for herring.  If we believe that the lobster bait market is well functioning, then consumer welfare measures could be determined from a demand curve for herring.  Rigorous estimation of a demand curve for herring likely requires modeling goods are substitutes for herring, possibly including  mackerel, menhaden, squid,  and substitute bait. This was not done due to limited time available. 

@Finnoff2003HarvestingEcosystem and @Brown2005AFisheries describe methods to trace the effects of changes in harvest or biomass of one species through an ecosystem.  The predator section models a few representative consumers of live herring: terns, tuna, whales, and predatory fish. Ecosystem Valuation methods could be used to measure changes in outcomes for those species in dollar value [@loomis1996economic; @richardson2009total; @lew2015willingness].  People may derive value from changes in the status of these predators through either use or non-use values.  For example, people may directly value higher abundances of an animal or protection of an endangered species, even if they have no plans to watch or view them [@lew2010valuing; @lew2017temporal].  Quantifying these values typically is done using stated preference methods with data collected using surveys; these studies are costly and time consuming to develop and conduct rigorously.  Benefit transfer, a method in which valuation from previous studies is applied to a new study area,may be the only way to overcome these barriers [@navrud2007environmental; @johnston2010methods].

Consumers may also derive use value from changes in the modeled species. For example, changes in whale populations may change outcomes for whale-watching customers [@Larson2004RevealingData].  This type of value can be quantified using both stated and revealed preference data, both of which typically require collection of survey data; these studies are also costly and time consuming to develp and conduct rigorously.  Perhaps more discouragingly, the precise good being valued (say, a doubling of the tern population) needs to be known quite early in the research process.  In this application, development of a valuation survey for terns would not have been able to start until after the predator modeling was nearly complete. Benefit transfer may be the only way to value some of the use values on the timeframe required by NEFMC.

Another avenue for use value to arise is though changes in costs, catches, or prices in the associated commercial fishery.  For example, increases in biomass of spiny dogfish could lead to both higher quotas and lower costs to catch more abundant fish.  Examining changes in costs would require an economic model of production for the spiny dogfish fishery (similar to the model not used for the herring fleet) [@holland1999empirical; @hutniczak2014increasing; @reimer2017fisheries]. Changes in product quality could result in higher prices [@Larkin1999IntrinsicFishery; @Asche2015EconomicFisheries].  For example, because larger tuna receives higher prices, the effects of changes in average weight could be deduced from existing hedonic models [@McConnell2000HedonicHawaii; @Carroll2001PricingManagement].

One of the difficulties with including a quantitative economic model is that it's difficult to know which predator and performance metric to formally model.  For example, prior to completing the predator models, we did not know that tuna weight but not abundances would be sensitive to various harvest control rules.  If we had tried to model how changes in abundance affect affect costs of harvesting tuna, this would have not been a fruitful use of time.

Note that increases in the biomass of a particular predator could be a net ``bad''  for society.  For example, an increase in the biomass of a predator that is low-valued but skilled at consuming herring could result in disproportionate increases in that low-valued predator. If that low-valued predator is not a complete specialist (in consuming herring), it may also drive down the biomass of high-valued predators.  The ability to manipulate the ecosystem with a prey-level ABC control rule to achieve desirable outcomes depends on the rates at which these increases in prey are converted into social utility. This conversion depends on the ecosystem technology (conversion of prey into additional biomass of high- and low-valued predators), human technology (conversion of prey and predator biomass into catch or tourism), and human preferences (converting catch or tourism into utility). Despite our current efforts, many of these technologies are not particularly well understood at this time.




-------------------------------
#References
